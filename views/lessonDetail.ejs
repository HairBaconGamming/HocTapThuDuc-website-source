<%- include('partials/header') %>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

<link rel="stylesheet" href="/css/styleLessonDetail.css">

<div class="lesson-detail-page">
    <div class="lesson-container">
        
        <aside class="lesson-sidebar" id="lessonSidebar">
            <div class="sidebar-header">
                <div class="d-flex align-items-center gap-2 text-dark fw-bold small text-uppercase">
                    <i class="fas fa-stream text-primary"></i> Mục lục bài học
                </div>
            </div>
            
            <div class="toc-wrapper">
                <ul id="toc-list" class="toc-list">
                    <li class="p-3 text-muted small fst-italic ps-4">Đang tải mục lục...</li>
                </ul>
            </div>

            <div class="p-3 border-top bg-light">
                <a href="<%= course ? ('/course/' + course._id) : '/subjects' %>" class="btn btn-outline-secondary w-100 btn-sm fw-bold">
                    <i class="fas fa-arrow-left me-2"></i> Quay lại khóa học
                </a>
            </div>
        </aside>

        <main class="lesson-content-wrapper" id="mainScrollArea">
            <div class="lesson-content-inner">
                
                <div class="lesson-breadcrumb d-none d-md-block">
                    <div class="breadcrumb-list">
                        <span class="breadcrumb-item"><a href="/">Trang chủ</a></span>
                        <span class="breadcrumb-separator">/</span>
                        <span class="breadcrumb-item"><a href="/courses">Khóa học</a></span>
                        <span class="breadcrumb-separator">/</span>
                        <span class="breadcrumb-item active"><%= lesson.title %></span>
                    </div>
                </div>

                <div class="lesson-header">
                    <div class="lesson-meta">
                        <span class="badge-cat"><%= lesson.category || 'Bài học' %></span>
                        <span><i class="far fa-calendar-alt me-1"></i> <%= new Date(lesson.createdAt).toLocaleDateString('vi-VN') %></span>
                        <span><i class="far fa-user me-1"></i> <%= lesson.createdBy ? lesson.createdBy.username : 'Admin' %></span>
                    </div>
                    <h1 class="lesson-title"><%= lesson.title %></h1>
                </div>

                <div id="lessonContentArea">
                    <div class="text-center py-5 my-5">
                        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
                        <p class="mt-3 text-muted fw-bold">Đang tải nội dung...</p>
                    </div>
                </div>

                <div class="lesson-footer d-flex justify-content-between align-items-center mt-5 pt-5 border-top">
                    <button class="btn btn-light rounded-pill px-4 fw-bold text-secondary" onclick="history.back()">
                        <i class="fas fa-arrow-left me-2"></i> Quay lại
                    </button>

                    <button id="btn-finish-lesson" class="btn btn-success btn-lg rounded-pill px-5 shadow-sm fw-bold transition-all" onclick="completeLesson('<%= lesson._id %>')">
                        <span>Hoàn thành</span> <i class="fas fa-check-circle ms-2"></i>
                    </button>
                </div>

                <div class="mt-5 pt-5">
                     </div>

            </div>
        </main>

    </div>
</div>

<button class="btn btn-dark rounded-circle shadow-lg d-lg-none position-fixed" 
        style="bottom: 90px; left: 20px; width: 50px; height: 50px; z-index: 1000; display:flex; align-items:center; justify-content:center;"
        onclick="document.getElementById('lessonSidebar').classList.toggle('active')">
    <i class="fas fa-list-ul fs-5"></i>
</button>

<button class="btn-floating-comments" id="btn-toggle-comments" title="Thảo luận">
    <i class="fas fa-comments"></i>
    <span class="comment-badge" id="comment-badge" style="display:none;">0</span>
</button>

<div class="comments-modal hidden" id="comments-modal">
    <div class="comments-modal-header">
        <span><i class="far fa-comments me-2"></i>Thảo luận</span>
        <button class="btn-close" id="btn-close-comments" style="filter: invert(0.5); opacity: 0.8;"></button>
    </div>
    <div class="comments-modal-body" id="comments-modal-body">
        </div>
    <div class="comments-modal-footer" id="comments-modal-footer">
        </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>

<script>
    window.LESSON_ID = '<%= lesson._id %>';
    window.AUTHOR_USERNAME = '<%= lesson.createdBy ? lesson.createdBy.username : "" %>';
    window.USER = <%- user ? JSON.stringify({ id: user._id, username: user.username, avatar: user.avatar }) : 'null' %>;

    // [FIX TRIỆT ĐỂ] CHUYỂN DATA SANG BASE64 ĐỂ TRÁNH LỖI KÝ TỰ ĐẶC BIỆT
    <% 
        let rawContent = lesson.content || [];
        // Nếu là Object/Array thì chuyển thành chuỗi JSON trước
        if (typeof rawContent === 'object') {
            rawContent = JSON.stringify(rawContent);
        }
        // Chuyển toàn bộ chuỗi sang Base64
        // Buffer là có sẵn trong môi trường NodeJS (EJS chạy trên server)
        let contentBase64 = Buffer.from(rawContent).toString('base64');
    %>
    
    // Gán chuỗi Base64 an toàn vào biến window
    window.LESSON_CONTENT_B64 = "<%= contentBase64 %>";
</script>

<script src="/js/lessonDetail.js"></script>
<script src="/js/lessonDetailComments.js"></script>

<%- include('partials/footer') %>