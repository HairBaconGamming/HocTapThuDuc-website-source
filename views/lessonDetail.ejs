<%- include('partials/header') %>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />

<link rel="stylesheet" href="/css/styleLessonDetail.css">

<style>
    .katex-display { overflow-x: auto; overflow-y: hidden; padding: 5px 0; }
</style>

<div class="container" style="max-width: 1000px; margin: 20px auto 0; padding: 0 20px;">
    <%- include('partials/breadcrumb') %>
</div>

<div class="lesson-page-wrapper">
    <div class="lesson-sidebar">
        <a href="<%= course ? ('/course/' + course._id) : (subject ? ('/subjects/' + subject._id) : '/subjects') %>" class="back-link">
            <i class="fas fa-arrow-left"></i> Quay lại khóa học
        </a>
        <div class="course-progress">
            </div>
    </div>

    <div class="lesson-main-content">
        <div class="lesson-header">
            <div class="lesson-meta">
                <span class="badge-cat"><%= lesson.category || 'Bài học' %></span>
                <span class="lesson-date"><i class="far fa-clock"></i> <%= new Date(lesson.createdAt).toLocaleDateString('vi-VN') %></span>
            </div>
            <h1 class="lesson-title"><%= lesson.title %></h1>
            
            <div class="author-info">
                <img src="<%= lesson.createdBy && lesson.createdBy.avatar ? lesson.createdBy.avatar : '/img/default-avatar.png' %>" alt="Author">
                <span>Đăng bởi <strong><%= lesson.createdBy ? lesson.createdBy.username : 'Admin' %></strong></span>
            </div>
        </div>

        <div id="lessonContentArea" class="lesson-body" data-content='<%= lesson.content %>'>
            <div class="loading-spinner">
                <i class="fas fa-circle-notch fa-spin"></i> Đang tải nội dung...
            </div>
        </div>

        <div class="lesson-footer text-center mt-5">
            <button id="btn-finish-lesson" class="btn btn-success btn-lg px-5" onclick="completeLesson('<%= lesson._id %>')">
                <i class="fas fa-check-circle"></i> Hoàn thành bài học
            </button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script src="/js/lessonDetail.js"></script>

<%- include('partials/footer') %>