<%# ========================================================================= %>
<%# EJS Template for Creating/Editing Lessons (V3 - Preview/Fullscreen)     %>
<%# ========================================================================= %>

<%# Determine the mode, defaulting to 'add' if not provided by the server %>
<% const currentMode = typeof mode !== 'undefined' ? mode : 'add'; %>

<%# Set the page title based on the determined mode %>
<% const pageTitle = currentMode === 'edit' ? 'Ch·ªânh s·ª≠a B√†i h·ªçc' : 'T·∫°o B√†i h·ªçc M·ªõi'; %>

<%# Now use 'currentMode' consistently throughout the rest of this EJS file %>

<%# Include Header: Pass title, user data, and active page identifier %>
<%- include('partials/header', {
    title: pageTitle,
    user: typeof user !== 'undefined' ? user : null,
    activePage: 'lessonAdd' // Adjust as needed, e.g., 'dashboard' if accessed from there
}) %>

<%# Link to the NEW CSS file for V3 styles %>
<link rel="stylesheet" href="/styleManageLessonV3.css">

<%# Essential JS Libraries (Load these early in <head> or defer/async if possible, but ensure they are loaded before your script) %>
<%# GSAP Core & Flip Plugin are CRITICAL - Consider loading non-render-blocking %>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/Flip.min.js" defer></script>
<%# Optional but useful, load deferred %>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js" defer></script>

<%# Toast UI Editor CSS & JS - Load deferred %>
<link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
<script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js" defer></script>

<%# Marked.js (for Markdown Preview rendering) - Load deferred %>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer></script>

<%# KaTeX (for Math formula rendering) - Optional, Load deferred %>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js" onload="console.log('KaTeX auto-render loaded.')"></script>

<%# MathLive (Alternative/Additional Math Input/Rendering) - Optional, Load deferred %>
<link rel="stylesheet" href="https://unpkg.com/mathlive/dist/mathlive-static.css" />
<script src="https://unpkg.com/mathlive/dist/mathlive.min.js" defer></script>

<%# Cloudflare Turnstile Script (Load async/defer) %>
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
<%# ------------------------------------------------------------------------- %>


<%# Main content section with unique class %>
<section class="manage-lesson-section">

    <%# Optional Animated Background Elements %>
    <div class="manage-lesson-background">
        <div class="bg-element element-1"></div>
        <div class="bg-element element-2"></div>
    </div>

    <%# Main content container with backdrop blur and styling %>
    <div class="container manage-lesson-container">

        <%# Step Indicator (Visual progress tracker) %>
        <div class="step-indicator" data-animate="fade-in">
            <div class="step active" data-step="1">
                <span class="step-number">1</span>
                <span class="step-label">Th√¥ng tin</span>
                <div class="step-connector"></div>
            </div>
            <div class="step" data-step="2">
                <span class="step-number">2</span>
                <span class="step-label">N·ªôi dung</span>
                <div class="step-connector"></div>
            </div>
            <div class="step" data-step="3">
                <span class="step-number">3</span>
                <span class="step-label">Ho√†n t·∫•t</span>
            </div>
        </div>

        <%# Main Title: Dynamically changes based on mode %>
        <h2 class="main-title" data-animate="fade-in" data-anim-delay="0.1">
            <%= pageTitle %> <%# Use the variable defined at the top %>
        </h2>

        <%# The Main Form: Action and method depend on mode %>
        <%# Pass lesson ID via data-attribute for JS key generation if needed %>
        <form action="<%= (currentMode === 'edit' && typeof lesson !== 'undefined') ? '/lesson/' + lesson._id + '/edit' : '/lesson/add' %>"
              method="POST"
              id="lessonForm"
              class="manage-lesson-form"
              data-lesson-id="<%= (currentMode === 'edit' && typeof lesson !== 'undefined') ? lesson._id : 'new' %>"
              novalidate> <%# novalidate added, JS handles validation %>

            <%# Method Override for PUT request in edit mode %>
            <% if (currentMode === 'edit') { %>
                <input type="hidden" name="_method" value="PUT">
            <% } %>

            <%# Wrapper for all form steps (Height animated by JS/GSAP) %>
            <div class="form-steps-wrapper">

                <%# ===================================================== %>
                <%# STEP 1: Basic Lesson Information                      %>
                <%# ===================================================== %>
                <div class="form-step active" data-step-content="1">
                    <h3 class="step-title">Th√¥ng tin C∆° b·∫£n</h3>

                    <div class="form-grid two-columns">
                        <%# Subject Selection %>
                        <div class="input-field-group fancy-input">
                            <label for="subjectId" class="form-label-v2 static">M√¥n h·ªçc</label>
                            <div class="custom-select-wrapper-v2">
                                <i class="fas fa-book select-icon"></i>
                                <select name="subjectId" id="subjectId" class="form-input-v2 custom-select-v2" required>
                                    <option value="" disabled <%= (currentMode === 'add' || !lesson?.subject) ? 'selected' : '' %>>-- Ch·ªçn m√¥n h·ªçc --</option>
                                    <% if (typeof subjects !== 'undefined' && Array.isArray(subjects)) { %>
                                        <% subjects.forEach(function(subject) { %>
                                            <% const isSelected = (currentMode === 'edit' && lesson?.subject && lesson.subject.toString() === subject._id.toString()); %>
                                            <option value="<%= subject._id %>" <%= isSelected ? 'selected' : '' %>>
                                                <%= subject.name %>
                                            </option>
                                        <% }); %>
                                    <% } else { %>
                                         <option value="" disabled>L·ªói t·∫£i m√¥n h·ªçc</option>
                                    <% } %>
                                </select>
                                <i class="fas fa-chevron-down select-arrow"></i>
                            </div>
                            <div class="validation-error" data-for="subjectId">Vui l√≤ng ch·ªçn m√¥n h·ªçc.</div>
                        </div>

                        <%# Category Selection %>
                        <div class="input-field-group fancy-input">
                             <label for="category" class="form-label-v2 static">Th·ªÉ lo·∫°i</label>
                             <div class="custom-select-wrapper-v2">
                                  <i class="fas fa-tags select-icon"></i>
                                  <select name="category" id="category" class="form-input-v2 custom-select-v2" required>
                                     <% const currentCategoryValue = (currentMode === 'edit' && lesson?.category) ? lesson.category : ''; %>
                                     <option value="" disabled <%= !currentCategoryValue ? 'selected' : '' %>>-- Ch·ªçn th·ªÉ lo·∫°i --</option>
                                     <option value="grammar" <%= currentCategoryValue === 'grammar' ? 'selected' : '' %>>Ng·ªØ ph√°p</option>
                                     <option value="vocabulary" <%= currentCategoryValue === 'vocabulary' ? 'selected' : '' %>>T·ª´ v·ª±ng</option>
                                     <option value="exercise" <%= currentCategoryValue === 'exercise' ? 'selected' : '' %>>B√†i t·∫≠p</option>
                                     <option value="theory" <%= currentCategoryValue === 'theory' ? 'selected' : '' %>>L√≠ thuy·∫øt</option>
                                     <option value="reading" <%= currentCategoryValue === 'reading' ? 'selected' : '' %>>ƒê·ªçc hi·ªÉu</option>
                                     <option value="listening" <%= currentCategoryValue === 'listening' ? 'selected' : '' %>>Nghe hi·ªÉu</option>
                                     <option value="other" <%= currentCategoryValue === 'other' ? 'selected' : '' %>>Kh√°c</option>
                                  </select>
                                  <i class="fas fa-chevron-down select-arrow"></i>
                              </div>
                              <div class="validation-error" data-for="category">Vui l√≤ng ch·ªçn th·ªÉ lo·∫°i.</div>
                        </div>

                        <!-- views/ManageLesson.ejs (b√™n trong .form-grid c·ªßa Step 1) -->

                     <div class="input-field-group fancy-input full-width tag-input-group">
                        <i class="fas fa-tags input-icon"></i>
                        <!-- Container ch·ª©a c√°c tag pill v√† √¥ input th·∫≠t s·ª± -->
                        <div id="tag-input-container" class="tag-input-container">
                            <!-- JS s·∫Ω ch√®n c√°c tag pill v√†o ƒë√¢y -->
                            <input type="text" id="tag-input-field" class="tag-input-field" placeholder=" ">
                        </div>
                        <!-- Label n·ªïi, nh·∫•t qu√°n v·ªõi c√°c tr∆∞·ªùng kh√°c -->
                        <label for="tag-input-field" class="form-label-v2">Tags (nh·∫•n Enter ho·∫∑c d·∫•u ph·∫©y)</label>
                        <!-- ƒê∆∞·ªùng g·∫°ch ch√¢n hi·ªáu ·ª©ng focus -->
                        <div class="input-focus-line"></div>
                        <!-- Input ·∫©n n√†y m·ªõi th·ª±c s·ª± g·ª≠i d·ªØ li·ªáu ƒëi -->
                        <input type="hidden" name="tags" id="hidden-tags-input" value="<%= (lesson && lesson.tags) ? lesson.tags.join(', ') : '' %>">
                    </div>

                    <%# Lesson Title Input %>
                    <div class="input-field-group fancy-input">
                        <input type="text" name="title" id="title" class="form-input-v2" placeholder=" " value="<%= (currentMode === 'edit' && lesson?.title) ? lesson.title.trim() : '' %>" required minlength="3" maxlength="150">
                        <label for="title" class="form-label-v2">Ti√™u ƒë·ªÅ B√†i h·ªçc</label>
                        <span class="input-focus-line"></span>
                        <i class="fas fa-heading input-icon"></i>
                         <div class="validation-error" data-for="title">Ti√™u ƒë·ªÅ ph·∫£i c√≥ t·ª´ 3 ƒë·∫øn 150 k√Ω t·ª±.</div>
                    </div>

                    <%# PRO Only Toggle (Only shown to PRO users or if lesson IS PRO) %>
                    <% const canSetPro = (typeof user !== 'undefined' && user && user.isPro); %>
                    <% const isCurrentlyPro = (currentMode === 'edit' && lesson?.isProOnly); %>
                    <% if (canSetPro || isCurrentlyPro) { %>
                        <div class="fancy-toggle-group">
                            <label class="switch-v2">
                                <input type="checkbox" name="isProOnly" value="true" <%= isCurrentlyPro ? 'checked' : '' %> <%= !canSetPro ? 'disabled' : '' %>>
                                <span class="slider-v2 round">
                                    <span class="icon-on"><i class="fas fa-crown"></i></span>
                                    <span class="icon-off"><i class="fas fa-lock-open"></i></span>
                                </span>
                            </label>
                            <span class="toggle-label-v2">
                                B√†i h·ªçc ch·ªâ d√†nh cho <span class="pro-text-inline">PRO</span>
                                <% if (!canSetPro && isCurrentlyPro) { %>
                                     (B·∫°n kh√¥ng th·ªÉ thay ƒë·ªïi c√†i ƒë·∫∑t n√†y)
                                <% } else if (!canSetPro && !isCurrentlyPro) { %>
                                     (N√¢ng c·∫•p PRO ƒë·ªÉ t·∫°o b√†i h·ªçc PRO)
                                <% } %>
                            </span>
                        </div>
                     <% } else { %>
                         <%# If user cannot set PRO and lesson is not PRO, ensure false is submitted %>
                         <input type="hidden" name="isProOnly" value="false">
                     <% } %>


                    <%# Step 1 Navigation Button %>
                    <div class="step-navigation">
                        <span></span> <%# Spacer %>
                        <button type="button" class="btn btn-primary next-step-btn" data-next-step="2">
                            Ti·∫øp t·ª•c <i class="fas fa-arrow-right ms-1"></i>
                        </button>
                    </div>
                </div> <%# End Step 1 %>
                </div>

                <%# ===================================================== %>
                <%# STEP 2: Lesson Type & Content (PREVIEW BASED)       %>
                <%# ===================================================== %>
                <div class="form-step" data-step-content="2">
                    <h3 class="step-title">Lo·∫°i & N·ªôi dung B√†i h·ªçc</h3>

                    <%# Lesson Type Selector Tabs %>
                    <% const initialType = (currentMode === 'edit' && lesson?.type) ? lesson.type : 'markdown'; %>
                    <div class="lesson-type-selector-v2">
                        <button type="button" class="type-tab-btn <%= initialType === 'markdown' ? 'active' : '' %>" data-type="markdown" title="VƒÉn b·∫£n Markdown">
                            <i class="fab fa-markdown"></i> <span>Markdown</span>
                        </button>
                        <button type="button" class="type-tab-btn <%= initialType === 'quiz' ? 'active' : '' %>" data-type="quiz" title="Tr·∫Øc nghi·ªám">
                            <i class="fas fa-tasks"></i> <span>Tr·∫Øc nghi·ªám</span>
                        </button>
                        <button type="button" class="type-tab-btn <%= initialType === 'video' ? 'active' : '' %>" data-type="video" title="Video">
                            <i class="fas fa-video"></i> <span>Video</span>
                        </button>
                        <button type="button" class="type-tab-btn <%= initialType === 'essay' ? 'active' : '' %>" data-type="essay" title="T·ª± lu·∫≠n">
                            <i class="fas fa-pen-alt"></i> <span>T·ª± lu·∫≠n</span>
                        </button>
                    </div>
                    <%# Hidden input to store the selected lesson type %>
                    <input type="hidden" id="lessonType" name="type" value="<%= initialType %>">

                    <%# Container for editor panels (JS shows/hides based on type) %>
                    <div class="editor-area">

                        <%# --- Markdown Panel --- %>
                        <div class="editor-panel" data-editor-type="markdown" style="<%= initialType === 'markdown' ? 'display: block;' : 'display: none;' %>">
                            <label class="editor-label" for="markdownData_preview"><i class="fab fa-markdown"></i> N·ªôi dung Markdown</label>
                            <div id="markdownData_preview" class="editor-preview-container interactive-preview"
                                 data-editor-target="markdownData"
                                 data-editor-type="markdown"
                                 data-editor-context="N·ªôi dung ch√≠nh Markdown"
                                 role="button" tabindex="0" aria-label="Ch·ªânh s·ª≠a n·ªôi dung Markdown">
                                <div class="preview-content">
                                    <%# JS will render preview here based on markdownData value %>
                                    <p class="text-muted initial-placeholder">Click ƒë·ªÉ ch·ªânh s·ª≠a...</p>
                                </div>
                                <div class="edit-overlay" aria-hidden="true">
                                    <i class="fas fa-pencil-alt"></i> Ch·ªânh s·ª≠a
                                </div>
                            </div>
                            <textarea name="editorData[markdown]" id="markdownData" class="hidden-data" aria-hidden="true"><%= lesson?.editorData?.markdown ?? '' %></textarea>
                        </div>

                        <%# --- Quiz Panel --- %>
                        <div class="editor-panel" data-editor-type="quiz" style="<%= initialType === 'quiz' ? 'display: block;' : 'display: none;' %>">
                            <label class="editor-label"><i class="fas fa-tasks"></i> So·∫°n th·∫£o Quiz</label>
                            <% if (typeof user !== 'undefined' && user && user.isPro) { %>
                                <div class="ai-feature-box">
                                    <label for="docxFile" class="ai-label"><i class="fas fa-wand-magic-sparkles"></i> T·∫°o Quiz nhanh t·ª´ DOCX/PDF (PRO)</label>
                                    <div class="ai-controls">
                                        <input type="file" id="docxFile" name="docxFile" accept=".docx,.pdf" class="ai-file-input">
                                        <button type="button" id="generateQuizBtn" class="btn btn-secondary btn-ai-generate"><i class="fas fa-cogs me-1"></i> T·∫°o Quiz</button>
                                    </div>
                                    <small class="form-text text-muted">T·∫£i l√™n file b√†i t·∫≠p ƒë·ªÉ AI t·ª± ƒë·ªông t·∫°o c√¢u h·ªèi tr·∫Øc nghi·ªám.</small>
                                </div>
                             <% } else { %>
                                <p class="pro-notice"><i class="fas fa-lock"></i> T√≠nh nƒÉng t·∫°o Quiz t·ª´ file ch·ªâ d√†nh cho t√†i kho·∫£n <a href="/pro" class="pro-text-inline">PRO</a>.</p>
                             <% } %>
                             <div id="quizContainer" class="quiz-editor-container">
                                 <p class="text-center text-muted initial-placeholder">ƒêang t·∫£i c√¢u h·ªèi...</p>
                             </div>
                             <button type="button" id="addQuestionBtn" class="btn btn-secondary add-item-btn"><i class="fas fa-plus"></i> Th√™m C√¢u H·ªèi</button>
                             <%
                                  let quizJsonString = "[]"; // Default empty array as string
                                  if (currentMode === 'edit' && lesson?.editorData?.quiz) {
                                      try {
                                          // Ensure it's treated as an object/array before stringifying
                                          const quizDataObject = lesson.editorData.quiz;
                                          if (typeof quizDataObject === 'string') {
                                              // If it's already a string, try parsing first to ensure validity? Risky.
                                              // Assume it should be an array/object from the controller.
                                              // For safety, just use the string if it's already one, but log warning.
                                              console.warn("Quiz data in EJS was already a string. Using as is.");
                                              quizJsonString = quizDataObject;
                                          } else if (typeof quizDataObject === 'object' && quizDataObject !== null) {
                                              quizJsonString = JSON.stringify(quizDataObject);
                                          }
                                      } catch (e) {
                                          console.error("Error stringifying quiz data in EJS:", e);
                                          quizJsonString = "[]"; // Fallback to empty array
                                      }
                                  }
                              %>
                              <input type="hidden" name="editorData[quiz]" id="quizData" class="hidden-data" value='<%- quizJsonString %>'>
                        </div>

                        <%# --- Video Panel --- %>
                        <div class="editor-panel" data-editor-type="video" style="<%= initialType === 'video' ? 'display: block;' : 'display: none;' %>">
                            <label class="editor-label" for="videoUrl"><i class="fas fa-video"></i> Li√™n k·∫øt Video</label>
                            <div class="input-field-group fancy-input">
                               <input type="url" name="editorData[video]" id="videoUrl" class="form-input-v2" placeholder=" " value="<%= lesson?.editorData?.video ?? '' %>" pattern="https?://.+">
                               <label for="videoUrl" class="form-label-v2">URL Video (YouTube, Vimeo...)</label>
                               <span class="input-focus-line"></span>
                               <i class="fas fa-link input-icon"></i>
                               <div class="validation-error" data-for="videoUrl">Vui l√≤ng nh·∫≠p URL h·ª£p l·ªá (b·∫Øt ƒë·∫ßu b·∫±ng http:// ho·∫∑c https://).</div>
                            </div>
                            <div id="videoPreview" class="video-preview-area">
                                <p class="text-muted text-center initial-placeholder">D√°n URL video v√†o √¥ tr√™n ƒë·ªÉ xem tr∆∞·ªõc.</p>
                            </div>
                        </div>

                        <%# --- Essay Panel --- %>
                         <div class="editor-panel" data-editor-type="essay" style="<%= initialType === 'essay' ? 'display: block;' : 'display: none;' %>">
                            <label class="editor-label"><i class="fas fa-pen-alt"></i> So·∫°n th·∫£o T·ª± lu·∫≠n</label>

                            <div class="essay-section">
                                <h4><i class="fas fa-file-alt"></i> ƒê·ªÅ b√†i chung (T√πy ch·ªçn)</h4>
                                <div id="essayPromptData_preview" class="editor-preview-container interactive-preview"
                                     data-editor-target="essayPromptData"
                                     data-editor-type="essayPrompt"
                                     data-editor-context="ƒê·ªÅ b√†i T·ª± lu·∫≠n"
                                     role="button" tabindex="0" aria-label="Ch·ªânh s·ª≠a ƒë·ªÅ b√†i chung">
                                    <div class="preview-content">
                                         <p class="text-muted initial-placeholder">Click ƒë·ªÉ ch·ªânh s·ª≠a...</p>
                                    </div>
                                     <div class="edit-overlay" aria-hidden="true">
                                        <i class="fas fa-pencil-alt"></i> Ch·ªânh s·ª≠a
                                    </div>
                                </div>
                                <textarea name="editorData[essayPrompt]" id="essayPromptData" class="hidden-data" aria-hidden="true"><%= lesson?.editorData?.essayPrompt ?? '' %></textarea>
                             </div>

                            <div class="essay-section">
                                <h4><i class="fas fa-cogs"></i> C·∫•u h√¨nh Ch·∫•m ƒëi·ªÉm</h4>
                                <div class="input-field-group fancy-input">
                                    <label for="essayGrading" class="form-label-v2 static">Ph∆∞∆°ng ph√°p ch·∫•m</label>
                                    <div class="custom-select-wrapper-v2">
                                        <i class="fas fa-check-double select-icon"></i>
                                        <% const currentGradingValue = lesson?.editorData?.essayGrading ?? 'simple'; %>
                                        <select name="editorData[essayGrading]" id="essayGrading" class="form-input-v2 custom-select-v2">
                                            <% const isProUser = typeof user !== 'undefined' && user && user.isPro; %>
                                            <option value="ai" <%= !isProUser ? 'disabled' : '' %> <%= currentGradingValue ==='ai' ? 'selected' : '' %>>
                                                ü§ñ Ch·∫•m AI (Gemini) <%= !isProUser ? '[Y√™u c·∫ßu PRO]' : '' %>
                                            </option>
                                            <option value="absolute" <%= !isProUser ? 'disabled' : '' %> <%= currentGradingValue ==='absolute' ? 'selected' : '' %>>
                                                üíØ Ch·∫•m Tuy·ªát ƒë·ªëi (S·ªë l·ªói) <%= !isProUser ? '[Y√™u c·∫ßu PRO]' : '' %>
                                            </option>
                                            <option value="smart" <%= !isProUser ? 'disabled' : '' %> <%= currentGradingValue ==='smart' ? 'selected' : '' %>>
                                                üí° Ch·∫•m Th√¥ng minh (BERT) <%= !isProUser ? '[Y√™u c·∫ßu PRO]' : '' %>
                                            </option>
                                            <option value="simple" <%= currentGradingValue ==='simple' ? 'selected' : '' %>>
                                                üîé Ch·∫•m So s√°nh (T·ª´ kh√≥a)
                                            </option>
                                        </select>
                                        <i class="fas fa-chevron-down select-arrow"></i>
                                    </div>
                                    <small class="form-text text-muted">Ch·ªçn c√°ch h·ªá th·ªëng s·∫Ω g·ª£i √Ω ch·∫•m ƒëi·ªÉm cho b√†i l√†m.</small>
                                </div>
                                <div class="input-field-group fancy-input" id="absoluteSettings" style="<%= currentGradingValue === 'absolute' ? '' : 'display: none; opacity: 0;' %>">
                                    <input type="number" name="editorData[absoluteTolerance]" id="absoluteTolerance" class="form-input-v2" placeholder=" " value="<%= lesson?.editorData?.absoluteTolerance ?? '2' %>" min="0" max="100" step="1">
                                    <label for="absoluteTolerance" class="form-label-v2">S·ªë l·ªói t·ªëi ƒëa cho ph√©p</label>
                                    <span class="input-focus-line"></span>
                                    <i class="fas fa-exclamation-circle input-icon"></i>
                                    <div class="validation-error" data-for="absoluteTolerance">Vui l√≤ng nh·∫≠p s·ªë nguy√™n kh√¥ng √¢m.</div>
                                </div>
                            </div>

                            <div class="essay-section">
                                <h4><i class="fas fa-question-circle"></i> C√¢u h·ªèi & ƒê√°p √°n m·∫´u</h4>
                                <div id="essayContainer" class="essay-editor-container">
                                     <p class="text-center text-muted initial-placeholder">ƒêang t·∫£i c√¢u h·ªèi...</p>
                                </div>
                                <button type="button" id="addEssayQuestionBtn" class="btn btn-secondary add-item-btn"><i class="fas fa-plus"></i> Th√™m C√¢u H·ªèi T·ª± Lu·∫≠n</button>
                            </div>
                             <%
                                let essayJsonString = "[]"; // Default empty array as string
                                if (currentMode === 'edit' && lesson?.editorData?.essay) {
                                    try {
                                          const essayDataObject = lesson.editorData.essay;
                                          if (typeof essayDataObject === 'string') {
                                              console.warn("Essay data in EJS was already a string. Using as is.");
                                              essayJsonString = essayDataObject;
                                          } else if (typeof essayDataObject === 'object' && essayDataObject !== null) {
                                               essayJsonString = JSON.stringify(essayDataObject);
                                          }
                                    } catch (e) {
                                        console.error("Error stringifying essay data in EJS:", e);
                                        essayJsonString = "[]";
                                    }
                                }
                            %>
                            <input type="hidden" name="editorData[essay]" id="essayData" class="hidden-data" value='<%- essayJsonString %>'>
                        </div> <%# End essay-panel %>

                    </div><!-- End .editor-area -->

                    <%# Step 2 Navigation Buttons %>
                    <div class="step-navigation">
                        <button type="button" class="btn btn-secondary-outline back-step-btn" data-prev-step="1">
                            <i class="fas fa-arrow-left me-1"></i> Quay l·∫°i
                        </button>
                        <button type="button" class="btn btn-primary next-step-btn" data-next-step="3">
                            Xem l·∫°i & Ho√†n t·∫•t <i class="fas fa-arrow-right ms-1"></i>
                        </button>
                    </div>
                </div> <%# End Step 2 %>

                <%# ===================================================== %>
                <%# STEP 3: Review & Submit                             %>
                <%# ===================================================== %>
                <div class="form-step" data-step-content="3">
                    <h3 class="step-title">Xem l·∫°i v√† G·ª≠i</h3>
                    <p class="review-prompt">Vui l√≤ng ki·ªÉm tra l·∫°i th√¥ng tin b√†i h·ªçc tr∆∞·ªõc khi g·ª≠i ƒëi.</p>

                    <%# Summary of Lesson Information (JS populates spans) %>
                    <div class="review-summary card shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title mb-3">T√≥m t·∫Øt B√†i h·ªçc</h5>
                            <p><strong>M√¥n h·ªçc:</strong> <span id="reviewSubject" class="text-primary">N/A</span></p>
                            <p><strong>Ti√™u ƒë·ªÅ:</strong> <span id="reviewTitle" class="fw-bold">N/A</span></p>
                            <p><strong>Th·ªÉ lo·∫°i:</strong> <span id="reviewCategory">N/A</span></p>
                            <p><strong>D·∫°ng b√†i h·ªçc:</strong> <span id="reviewType">N/A</span></p>
                            <p><strong>N·ªôi dung:</strong> <span id="reviewContentPreview" class="text-muted fst-italic">N/A</span></p>
                            <%# Only show PRO status if relevant %>
                            <% if (canSetPro || isCurrentlyPro) { %>
                                <p><strong>Ch·∫ø ƒë·ªô PRO:</strong> <span id="reviewProOnly" class="badge bg-warning text-dark">Kh√¥ng</span></p>
                            <% } %>
                        </div>
                    </div>

                    <%# Cloudflare Turnstile Widget Placeholder %>
                    <div class="turnstile-container my-4 d-flex justify-content-center">
                         <%# Replace YOUR_SITE_KEY with your actual key %>
                        <div class="cf-turnstile" data-sitekey="0x4AAAAAABBLlduN6HavujOQ" data-theme="light"></div>
                    </div>

                    <%# Save Progress Button (Only shown in 'add' mode) %>
                    <% if (currentMode === 'add') { %>
                       <div class="save-progress-container text-center mb-3">
                           <button type="button" id="saveProgressBtn" class="btn btn-secondary-outline btn-save-progress">
                               <i class="fas fa-save me-1"></i> L∆∞u Nh√°p T·∫°m Th·ªùi
                           </button>
                           <span class="save-status-indicator ms-2"></span> <%# Optional: For JS feedback %>
                           <small class="d-block text-muted mt-1">L∆∞u l·∫°i ti·∫øn tr√¨nh v√†o tr√¨nh duy·ªát n·∫øu b·∫°n mu·ªën ho√†n th√†nh sau.</small>
                       </div>
                    <% } %>

                    <%# Step 3 Navigation (Final Step) %>
                    <div class="step-navigation final-step-nav">
                         <button type="button" class="btn btn-secondary-outline back-step-btn" data-prev-step="2">
                             <i class="fas fa-arrow-left me-1"></i> S·ª≠a N·ªôi dung
                         </button>
                         <button type="submit" id="finalSubmitBtn" class="btn btn-submit-v2 final-submit-btn">
                             <span class="btn-text">
                                <i class="fas fa-check-circle me-1"></i> <%= currentMode === 'edit' ? 'C·∫≠p nh·∫≠t B√†i h·ªçc' : 'Ho√†n t·∫•t & Th√™m' %>
                             </span>
                         </button>
                     </div>
                </div>
            </div>
        </form>
    </div>
</section> 
                      
<%# ===================================================== %>
<%# Fullscreen Editor Modal (Initially Hidden)          %>
<%# ===================================================== %>
<div id="fullscreen-editor-modal" class="fullscreen-editor-modal" role="dialog" aria-modal="true" aria-labelledby="fullscreen-editor-context" aria-hidden="true">
    <div class="modal-backdrop"></div>
    <div class="modal-content" role="document">
        <div class="modal-header">
            <h3 id="fullscreen-editor-context" class="modal-title-context">ƒêang ch·ªânh s·ª≠a...</h3>
            <button type="button" class="btn-icon close-fullscreen-editor" title="ƒê√≥ng (ESC)" aria-label="ƒê√≥ng tr√¨nh so·∫°n th·∫£o">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div id="fullscreen-editor-container">
                <div class="editor-loading-placeholder">
                    <i class="fas fa-spinner fa-spin fa-3x"></i>
                    <p>ƒêang t·∫£i tr√¨nh so·∫°n th·∫£o...</p>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" id="save-and-close-editor" class="btn btn-primary">
                <i class="fas fa-check me-1"></i> L∆∞u & ƒê√≥ng
            </button>
        </div>
    </div>
</div>
<%# ===================================================== %>


<%# Include Footer %>
<%- include('partials/footer') %>

<%# ========================================================================= %>
<%# Load Your Custom JS file (MUST be AFTER the HTML content and libraries) %>
<%# ========================================================================= %>
<script type="module" src="/js/lessonEditorV3.js"></script>