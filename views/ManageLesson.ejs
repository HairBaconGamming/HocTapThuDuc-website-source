<%- include('partials/header') %>

<link rel="stylesheet" href="/css/styleStudio.css">
<link rel="stylesheet" href="https://unpkg.com/easymde/dist/easymde.min.css">
<script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<div class="container-fluid" style="padding: 0; background: var(--studio-bg);">
    
    <form id="lessonForm" action="/lesson/<%= (lesson) ? 'edit/'+lesson._id : 'add' %>" method="POST" class="studio-wrapper">
        
        <aside class="studio-panel left-panel">
            <div class="panel-header">
                <span><i class="fas fa-sitemap"></i> Cấu trúc</span>
                <span id="treeLoading" style="display:none;"><i class="fas fa-spinner fa-spin"></i></span>
            </div>
            
            <div class="panel-body">
                
                <div class="step-group">
                    <label class="step-label">1. Môn học</label>
                    <select id="selectSubject" class="studio-select" onchange="loadCourses(this.value)">
                        <option value="">-- Chọn Môn --</option>
                        <% subjects.forEach(s => { %>
                            <option value="<%= s._id %>"><%= s.name %></option>
                        <% }) %>
                    </select>
                </div>

                <div class="step-group" id="courseSelectGroup" style="display:none; margin-top:10px;">
                    <label class="step-label">2. Khóa học</label>
                    <div style="display:flex; gap:5px;">
                        <select id="selectCourse" class="studio-select" onchange="loadCurriculumByCourse(this.value)" style="flex-grow:1;">
                            <option value="">-- Chọn Khóa Học --</option>
                        </select>
                        
                        <button type="button" class="btn-icon-mini" onclick="promptCreateCourse()" title="Tạo khóa học mới">
                            <i class="fas fa-plus"></i>
                        </button>
                        
                        <button type="button" class="btn-icon-mini" onclick="openCourseSettings()" title="Cấu hình khóa học" style="color:#3b82f6; border-color:#93c5fd;">
                            <i class="fas fa-cog"></i>
                        </button>

                        <button type="button" class="btn-icon-mini delete-btn" onclick="deleteCurrentCourse()" title="Xóa khóa học" style="color:#ef4444; border-color:#fca5a5;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>

                <hr class="studio-divider">

                <div id="treeContainer" class="curriculum-tree">
                    <div class="empty-state">Vui lòng chọn khóa học.</div>
                </div>

                <button type="button" class="btn-add-unit-big" id="btnAddUnitMain" onclick="addTempUnit()" style="display:none;">
                    <i class="fas fa-plus-circle"></i> Thêm Chương Mới
                </button>

            </div>
        </aside>

        <input type="hidden" name="courseId" id="hiddenCourseId">
        <input type="hidden" name="subjectId" id="hiddenSubjectId" value="<%= lesson ? lesson.subjectId : '' %>">
        <input type="hidden" name="curriculumSnapshot" id="curriculumSnapshot">
        <div class="studio-workspace" style="display: contents;">
            
            <div id="emptyStatePanel" class="studio-panel center-panel" style="align-items: center; justify-content: center; text-align: center; display: flex;">
                <div>
                    <img src="https://cdn-icons-png.flaticon.com/512/7486/7486744.png" style="width: 150px; opacity: 0.5; margin-bottom: 20px;">
                    <h3 style="color: #999;">Chào mừng đến Content Studio</h3>
                    <p style="color: #bbb;">Vui lòng chọn một bài học bên trái để bắt đầu biên tập<br>hoặc tạo chương mới.</p>
                </div>
            </div>

            <div id="editorMainPanel" style="display: none; contents;">
                
                <main class="studio-panel center-panel">
                    <div class="panel-body" style="background: #fafafa;">
                        
                        <input type="text" name="title" id="mainTitleInput" class="editor-title-input" 
                            placeholder="Nhập tên bài học..." required autocomplete="off">
                        
                        <div class="type-tabs">
                            <div class="type-tab active"><i class="fas fa-cubes"></i> Block Editor</div>
                        </div>
                        
                        <input type="hidden" name="type" value="theory"> 
                        <input type="hidden" name="content" id="finalContentJSON">
                        <input type="hidden" name="quizData" id="quizDataInput">
                        
                        <div id="editorCanvas" class="block-container"></div>

                        <div class="add-block-placeholder" onclick="openBlockMenu(-1, event)">
                            <i class="fas fa-plus"></i> Thêm nội dung
                        </div>
                        
                        <div id="blockMenu" class="block-menu-popup">
                            <div class="menu-header">CHỌN LOẠI NỘI DUNG</div>
                            <div class="menu-grid">
                                <div class="menu-item" onclick="addBlock('text')">
                                    <div class="menu-icon" style="background:#e0f2fe; color:#0284c7"><i class="fab fa-markdown"></i></div>
                                    <span>Văn bản</span>
                                </div>
                                <div class="menu-item" onclick="addBlock('image')">
                                    <div class="menu-icon" style="background:#dcfce7; color:#16a34a"><i class="fas fa-image"></i></div>
                                    <span>Hình ảnh</span>
                                </div>
                                <div class="menu-item" onclick="addBlock('video')">
                                    <div class="menu-icon" style="background:#fee2e2; color:#dc2626"><i class="fab fa-youtube"></i></div>
                                    <span>Video Youtube</span>
                                </div>
                                <div class="menu-item" onclick="addBlock('question')">
                                    <div class="menu-icon" style="background:#fef3c7; color:#d97706"><i class="fas fa-question-circle"></i></div>
                                    <span>Câu hỏi & Bài tập</span>
                                </div>
                                <div class="menu-item" onclick="addBlock('callout')">
                                    <div class="menu-icon" style="background:#f3e8ff; color:#9333ea"><i class="fas fa-exclamation"></i></div>
                                    <span>Ghi chú</span>
                                </div>
                            </div>
                        </div>

                    </div>
                </main>

                <aside class="studio-panel right-panel">
                    <div class="panel-header">
                        <i class="fas fa-sliders-h"></i> Thiết lập
                        <span id="publishStatusBadge" class="status-badge <%= (lesson && lesson.isPublished) ? 'published' : 'draft' %>">
                            <%= (lesson && lesson.isPublished) ? 'ĐÃ ĐĂNG' : 'BẢN NHÁP' %>
                        </span>
                    </div>
                    
                    <div class="panel-body">
                        
                        <div class="control-item">
                            <span class="control-label">Quyền truy cập</span>
                            <div class="switch-wrapper">
                                <span>Yêu cầu VIP (PRO)</span>
                                <label class="switch-toggle">
                                    <input type="checkbox" name="isPro" id="isProInput" <%= (lesson && lesson.isPro) ? 'checked' : '' %>>
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>

                        <div class="control-item">
                            <span class="control-label">Thông tin</span>
                            <div style="font-size: 0.85rem; color: #666; margin-bottom: 8px;">
                                <i class="fas fa-user-edit"></i> Tác giả: <b><%= user.username %></b>
                            </div>
                            <div style="font-size: 0.85rem; color: #666;">
                                <i class="far fa-clock"></i> Cập nhật: <span id="lastSavedTime"><%= lesson ? new Date(lesson.updatedAt).toLocaleTimeString('vi-VN') : 'Chưa lưu' %></span>
                            </div>
                        </div>

                        <input type="hidden" name="currentEditingId" id="currentEditingId" value="<%= lesson ? lesson._id : '' %>">

                        <div style="margin-top: auto; display: flex; flex-direction: column; gap: 10px;">
                            
                            <button type="button" class="btn-studio btn-publish" onclick="submitLessonAJAX(true)">
                                <i class="fas fa-rocket"></i> ĐĂNG BÀI
                            </button>

                            <button type="button" class="btn-studio btn-draft" onclick="submitLessonAJAX(false)">
                                <i class="fas fa-save"></i> Lưu Nháp
                            </button>
                            
                            <button type="button" class="btn-studio btn-cancel" onclick="history.back()">
                                Thoát
                            </button>
                        </div>

                    </div>
                </aside>

            </div>
        </div>

    </form>

    <div id="courseSettingsModal" class="custom-modal" style="display:none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3><i class="fas fa-sliders-h"></i> Cấu hình Khóa học</h3>
                <span class="close-modal" onclick="closeCourseSettings()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group" style="margin-bottom:15px;">
                    <label>Tên khóa học</label>
                    <input type="text" id="settingCourseTitle" class="studio-input" placeholder="Nhập tên khóa học...">
                </div>

                <div class="form-group" style="margin-bottom:15px;">
                    <label>Ảnh bìa (Thumbnail URL)</label>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="settingCourseThumb" class="studio-input" placeholder="https://..." onchange="document.getElementById('thumbPreview').src = this.value">
                        <img id="thumbPreview" src="/img/default-course.jpg" style="width:50px; height:50px; object-fit:cover; border-radius:4px; border:1px solid #ddd;">
                    </div>
                </div>

                <div class="form-group" style="margin-bottom:15px;">
                    <label>Mô tả ngắn</label>
                    <textarea id="settingCourseDesc" class="studio-input" rows="4" placeholder="Giới thiệu về khóa học này..."></textarea>
                </div>

                <div style="display:flex; gap:20px; margin-bottom:20px;">
                    <label class="checkbox-container">
                        <input type="checkbox" id="settingCoursePro">
                        <span class="checkmark"></span>
                        <strong>Yêu cầu PRO (VIP)</strong>
                    </label>
                    
                    <label class="checkbox-container">
                        <input type="checkbox" id="settingCoursePublic">
                        <span class="checkmark"></span>
                        <strong>Công khai (Publish)</strong>
                    </label>
                </div>
                
                <div style="text-align:right;">
                    <button type="button" class="btn-secondary" onclick="closeCourseSettings()">Hủy</button>
                    <button type="button" class="btn-primary" onclick="saveCourseSettings()">Lưu thay đổi</button>
                </div>
            </div>
        </div>
    </div>
</div>

<%- include('partials/footer') %>

<script src="/js/lessonEditorV3.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Lấy dữ liệu content từ server (đã được EJS escape an toàn)
        // Nếu là bài mới thì là chuỗi rỗng
        // Nếu là bài cũ, nó có thể là JSON string hoặc Markdown string cũ
        const rawServerData = `<%- (lesson && lesson.content) ? lesson.content.replace(/\\/g, '\\\\').replace(/"/g, '\\"').replace(/\n/g, '\\n') : '' %>`;
        
        // Gọi hàm initBlocks trong lessonEditorV3.js
        if(typeof initBlocks === 'function') {
            initBlocks(rawServerData);
        }
    });
</script>