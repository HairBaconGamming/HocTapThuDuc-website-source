<%- include('partials/header') %>

<link rel="stylesheet" href="/css/styleStudio.css">
<link rel="stylesheet" href="https://unpkg.com/easymde/dist/easymde.min.css">
<script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />

<div class="container-fluid" style="padding: 0; background: var(--studio-bg);">
    
    <form id="lessonForm" action="/lesson/<%= (lesson) ? 'edit/'+lesson._id : 'add' %>" method="POST" class="studio-wrapper">
        
        <aside class="studio-panel left-panel">
            <div class="panel-header">
                <span><i class="fas fa-sitemap"></i> Cấu trúc</span>
                <span id="treeLoading" style="display:none;"><i class="fas fa-spinner fa-spin"></i></span>
            </div>
            
            <div class="panel-body">
                
                <div class="step-group">
                    <label class="step-label">1. Môn học</label>
                    <select id="selectSubject" class="studio-select" onchange="loadCourses(this.value)">
                        <option value="">-- Chọn Môn --</option>
                        <% subjects.forEach(s => { %>
                            <option value="<%= s._id %>"><%= s.name %></option>
                        <% }) %>
                    </select>
                </div>

                <div class="step-group" id="courseSelectGroup" style="display:none; margin-top:10px;">
                    <label class="step-label">2. Khóa học</label>
                    <div style="display:flex; gap:5px;">
                        <select id="selectCourse" class="studio-select" onchange="loadCurriculumByCourse(this.value)" style="flex-grow:1;">
                            <option value="">-- Chọn Khóa Học --</option>
                        </select>
                        
                        <button type="button" class="btn-icon-mini" onclick="promptCreateCourse()" title="Tạo khóa học mới">
                            <i class="fas fa-plus"></i>
                        </button>
                        
                        <button type="button" class="btn-icon-mini" onclick="selectCourse()" title="Cấu hình khóa học (Right Panel)" style="color:#3b82f6; border-color:#93c5fd;">
                            <i class="fas fa-cog"></i>
                        </button>

                        <button type="button" class="btn-icon-mini delete-btn" onclick="deleteCurrentCourse()" title="Xóa khóa học" style="color:#ef4444; border-color:#fca5a5;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>

                <hr class="studio-divider">

                <div id="treeContainer" class="curriculum-tree">
                    <div class="empty-state">Vui lòng chọn khóa học.</div>
                </div>

                <button type="button" class="btn-add-unit-big" id="btnAddUnitMain" onclick="addTempUnit()" style="display:none;">
                    <i class="fas fa-plus-circle"></i> Thêm Chương Mới
                </button>

            </div>
        </aside>

        <input type="hidden" name="courseId" id="hiddenCourseId">
        <input type="hidden" name="subjectId" id="hiddenSubjectId" value="<%= lesson ? lesson.subjectId : '' %>">
        <input type="hidden" name="curriculumSnapshot" id="curriculumSnapshot">
        <input type="hidden" name="currentEditingId" id="currentEditingId" value="<%= lesson ? lesson._id : '' %>">

        <div class="studio-workspace" style="display: contents;">
            
            <div id="emptyStatePanel" class="studio-panel center-panel" style="align-items: center; justify-content: center; text-align: center; display: flex;">
                <div>
                    <img src="https://cdn-icons-png.flaticon.com/512/7486/7486744.png" style="width: 150px; opacity: 0.5; margin-bottom: 20px;">
                    <h3 style="color: #999;">Content Studio</h3>
                    <p style="color: #bbb;">Chọn Khóa học, Chương hoặc Bài học<br>để bắt đầu chỉnh sửa.</p>
                </div>
            </div>

            <div id="editorMainPanel" style="display: none; contents;">
                
                <main class="studio-panel center-panel">
                    <div class="panel-body" style="background: #fafafa;">
                        
                        <input type="text" name="title" id="mainTitleInput" class="editor-title-input" 
                            placeholder="Nhập tên bài học..." required autocomplete="off">
                        
                        <div class="type-tabs">
                            <div class="type-tab active"><i class="fas fa-cubes"></i> Block Editor</div>
                        </div>
                        
                        <input type="hidden" name="type" value="theory"> 
                        <input type="hidden" name="content" id="finalContentJSON">
                        <input type="hidden" name="quizData" id="quizDataInput">
                        
                        <div id="editorCanvas" class="block-container"></div>

                        <div class="add-block-placeholder" onclick="openBlockMenu(-1, event)">
                            <i class="fas fa-plus"></i> Thêm nội dung
                        </div>
                        
                        <div id="blockMenu" class="block-menu-popup">
                            <div class="menu-header">CHỌN LOẠI NỘI DUNG</div>
                            <div class="menu-grid">
                                <div class="menu-item" onclick="addBlock('text')">
                                    <div class="menu-icon" style="background:#e0f2fe; color:#0284c7"><i class="fab fa-markdown"></i></div>
                                    <span>Văn bản</span>
                                </div>
                                <div class="menu-item" onclick="addBlock('image')">
                                    <div class="menu-icon" style="background:#dcfce7; color:#16a34a"><i class="fas fa-image"></i></div>
                                    <span>Hình ảnh</span>
                                </div>
                                <div class="menu-item" onclick="addBlock('video')">
                                    <div class="menu-icon" style="background:#fee2e2; color:#dc2626"><i class="fab fa-youtube"></i></div>
                                    <span>Video Youtube</span>
                                </div>
                                
                                <div class="menu-item" onclick="addBlock('html_preview')">
                                    <div class="menu-icon" style="background:#ffedd5; color:#ea580c"><i class="fab fa-html5"></i></div>
                                    <span>HTML Preview</span>
                                </div>
                                <div class="menu-item" onclick="addBlock('resource')">
                                    <div class="menu-icon" style="background:#f3f4f6; color:#4b5563"><i class="fas fa-link"></i></div>
                                    <span>Link Tài liệu</span>
                                </div>
                                <div class="menu-item" onclick="addBlock('code')">
                                    <div class="menu-icon" style="background:#1e293b; color:#38bdf8"><i class="fas fa-code"></i></div>
                                    <span>Code Snippet</span>
                                </div>
                                <div class="menu-item" onclick="addBlock('question')">
                                    <div class="menu-icon" style="background:#fef3c7; color:#d97706"><i class="fas fa-question-circle"></i></div>
                                    <span>Câu hỏi & Bài tập</span>
                                </div>
                                <div class="menu-item" onclick="addBlock('callout')">
                                    <div class="menu-icon" style="background:#f3e8ff; color:#9333ea"><i class="fas fa-exclamation"></i></div>
                                    <span>Ghi chú</span>
                                </div>
                            </div>
                        </div>

                    </div>
                </main>
            </div>
        </div>

        <aside class="studio-panel right-panel">
            <div class="panel-header" id="panelHeaderLabel">
                <i class="fas fa-sliders-h"></i> Thiết lập
            </div>
            
            <div class="panel-body">

                <div id="panel-course" class="context-panel" style="display:none;">
                    <div class="panel-section-title" style="color:#2563eb; background:#eff6ff; border:1px solid #dbeafe;">
                        <i class="fas fa-book"></i> THÔNG TIN KHÓA HỌC
                        <span id="courseStatusBadge" class="status-badge" style="margin-left:auto; font-size:0.7rem; background:#cbd5e1; color:#475569;">LOADING...</span>
                    </div>
                    
                    <div class="control-item">
                        <span class="control-label">Tên khóa học</span>
                        <input type="text" id="pCourseTitle" class="studio-input" placeholder="Nhập tên khóa...">
                    </div>

                    <div class="control-item">
                        <span class="control-label">Mô tả ngắn</span>
                        <textarea id="pCourseDesc" class="studio-input" rows="3" style="font-size:0.85rem"></textarea>
                    </div>

                    <div class="control-item">
                        <span class="control-label">Ảnh bìa (Thumbnail)</span>
                        <div style="display:flex; gap:5px; align-items:center;">
                            <img id="pCourseThumbPreview" src="/img/default-course.jpg" style="width:40px; height:40px; object-fit:cover; border-radius:4px; border:1px solid #eee;">
                            <input type="text" id="pCourseThumb" class="studio-input" placeholder="URL ảnh..." onchange="updateCourseThumbPreview()">
                        </div>
                    </div>

                    <div class="control-item">
                        <span class="control-label">Thiết lập nâng cao</span>
                        <div class="switch-wrapper">
                            <span>Yêu cầu VIP (PRO)</span>
                            <label class="switch-toggle">
                                <input type="checkbox" id="pCoursePro">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="control-item actions-area" style="margin-top:20px; padding-top:15px; border-top:1px dashed #eee;">
                        <button type="button" class="btn-studio btn-publish" onclick="saveCourseStatus(true)" style="width:100%; margin-bottom:8px;">
                            <i class="fas fa-globe"></i> ĐĂNG KHÓA HỌC
                        </button>
                        <button type="button" class="btn-studio btn-draft" onclick="saveCourseStatus(false)" style="width:100%;">
                            <i class="fas fa-save"></i> Lưu Nháp
                        </button>
                        
                        <div style="font-size:0.75rem; color:#666; margin-top:10px; text-align:center;">
                            *Hành động này sẽ lưu thông tin và đồng bộ toàn bộ cấu trúc chương (xóa các chương thừa).
                        </div>
                    </div>
                </div>

                <div id="panel-unit" class="context-panel" style="display:none;">
                    <div class="panel-section-title" style="color:#b45309; background:#fffbeb; border:1px solid #fcd34d;">
                        <i class="fas fa-folder-open"></i> CÀI ĐẶT CHƯƠNG
                    </div>

                    <div class="control-item">
                        <span class="control-label">Tên chương</span>
                        <input type="text" id="settingUnitTitle" class="studio-input" oninput="syncUnitTitleToTree(this)">
                    </div>

                    <div class="control-item">
                        <span class="control-label">Thao tác nhanh (Bulk Actions)</span>
                        <div style="display:flex; gap:5px; margin-top:5px;">
                            <button type="button" class="btn-secondary" onclick="saveUnitStatus(false)" style="flex:1; font-size:0.75rem; padding:8px;">
                                <i class="fas fa-pencil-ruler"></i> Nháp All
                            </button>
                            <button type="button" class="btn-primary" onclick="saveUnitStatus(true)" style="flex:1; font-size:0.75rem; padding:8px;">
                                <i class="fas fa-check-circle"></i> Đăng All
                            </button>
                        </div>
                        <div style="font-size:0.75rem; color:#888; margin-top:5px;">
                            *Áp dụng cho tất cả bài học trong chương này.
                        </div>
                    </div>
                   
                    <div class="control-item" style="border-top:1px dashed #eee; padding-top:10px; margin-top:10px;">
                        <button type="button" class="btn-icon-mini delete-btn" style="width:100%; justify-content:center; color:#ef4444; border:1px solid #fca5a5; background:#fef2f2;" onclick="triggerDeleteActiveUnit()">
                            <i class="fas fa-trash"></i> Xóa Chương Này
                        </button>
                    </div>
                </div>

                <div id="panel-lesson" class="context-panel" style="display:none;">
                    <div class="panel-section-title" style="color:#15803d; background:#dcfce7; border:1px solid #86efac;">
                        <i class="fas fa-file-alt"></i> CẤU HÌNH BÀI HỌC
                        <span id="publishStatusBadge" class="status-badge" style="margin-left:auto; font-size:0.7rem;">NHÁP</span>
                    </div>

                    <div class="control-item">
                        <span class="control-label">Quyền truy cập</span>
                        <div class="switch-wrapper">
                            <span>Yêu cầu VIP (PRO)</span>
                            <label class="switch-toggle">
                                <input type="checkbox" name="isPro" id="isProInput" <%= (lesson && lesson.isPro) ? 'checked' : '' %>>
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>

                    <div class="control-item">
                        <span class="control-label">Thông tin</span>
                        <div class="meta-info" style="font-size:0.85rem; color:#555;">
                            <div style="margin-bottom:5px;"><i class="fas fa-user-edit"></i> Tác giả: <b><%= user.username %></b></div>
                            <div><i class="far fa-clock"></i> <span id="lastSavedTime"><%= lesson ? new Date(lesson.updatedAt).toLocaleTimeString('vi-VN') : 'Chưa lưu' %></span></div>
                        </div>
                    </div>

                    <div class="control-item actions-area" style="margin-top:20px;">
                         <button type="button" class="btn-studio btn-publish" onclick="submitLessonAJAX(true)" style="width:100%; margin-bottom:8px;">
                            <i class="fas fa-rocket"></i> ĐĂNG BÀI
                        </button>
                        <button type="button" class="btn-studio btn-draft" onclick="submitLessonAJAX(false)" style="width:100%;">
                            <i class="fas fa-save"></i> Lưu Nháp
                        </button>
                        
                        <div style="display:flex; gap:5px; margin-top:15px; border-top:1px dashed #eee; padding-top:15px;">
                            <button type="button" class="btn-secondary" onclick="exportLessonJSON()" style="flex:1; font-size:0.8rem;"><i class="fas fa-download"></i> Xuất JSON</button>
                            <button type="button" class="btn-secondary" onclick="document.getElementById('importJsonInput').click()" style="flex:1; font-size:0.8rem;"><i class="fas fa-upload"></i> Nhập JSON</button>
                            <input type="file" id="importJsonInput" accept=".json" style="display:none" onchange="importLessonJSON(this)">
                        </div>

                        <div class="control-item" style="border-top:1px dashed #eee; margin-top:10px; padding-top:10px;">
                            <button type="button" class="btn-studio" onclick="openRevisionHistory()" style="width:100%; background:#f8fafc; color:#334155; border:1px solid #cbd5e1;">
                                <i class="fas fa-history"></i> Lịch sử phiên bản
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </aside>

    </form>

</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>

<script src="https://unpkg.com/mathlive"></script>
<style>
    /* CSS cho MathLive Modal */
    math-field {
        font-size: 20px;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        width: 100%;
        margin-bottom: 15px;
        background: #fff;
    }
    .math-modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 9999;
        display: none; align-items: center; justify-content: center;
    }
    .math-modal-box {
        background: #fff; width: 500px; padding: 20px;
        border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
</style>

<div id="mathLiveModal" class="math-modal-overlay">
    <div class="math-modal-box">
        <h3 style="margin-bottom:15px; display:flex; justify-content:space-between;">
            <span><i class="fas fa-square-root-alt"></i> Soạn công thức Toán</span>
            <span onclick="closeMathModal()" style="cursor:pointer; color:#999;">&times;</span>
        </h3>
        
        <math-field id="mathLiveInput" virtual-keyboard-mode="manual"></math-field>
        
        <div style="display:flex; justify-content:flex-end; gap:10px;">
            <button type="button" class="btn-secondary" onclick="insertMathToEditor(false)">Inline ($)</button>
            <button type="button" class="btn-primary" onclick="insertMathToEditor(true)">Block ($$)</button>
        </div>
    </div>
</div>

<div id="revisionModal" class="math-modal-overlay">
    <div class="math-modal-box" style="width: 600px; max-width: 95%;">
        <h3 style="margin-bottom:15px; display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding-bottom:10px;">
            <span><i class="fas fa-history"></i> Lịch sử chỉnh sửa (Max 50)</span>
            <span onclick="document.getElementById('revisionModal').style.display='none'" style="cursor:pointer; color:#999;">&times;</span>
        </h3>
        
        <div id="revisionList" style="max-height: 400px; overflow-y: auto;">
            <div class="text-center py-4"><i class="fas fa-spinner fa-spin"></i> Đang tải...</div>
        </div>
        
        <div style="text-align:right; margin-top:15px; font-size:0.8rem; color:#666;">
            *Khôi phục sẽ ghi đè lên nội dung hiện tại.
        </div>
    </div>
</div>

<%- include('partials/footer') %>

<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="/js/lessonEditorV3.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Lấy dữ liệu content từ server (đã được EJS escape an toàn)
        const rawServerData = `<%- (lesson && lesson.content) ? lesson.content.replace(/\\/g, '\\\\').replace(/"/g, '\\"').replace(/\n/g, '\\n') : '' %>`;
        
        // Gọi hàm initBlocks trong lessonEditorV3.js
        if(typeof initBlocks === 'function') {
            initBlocks(rawServerData);
        }
    });
</script>