<%- include('partials/header') %>
<link rel="stylesheet" href="/css/styleEditProfile.css">

<style>
    .gallery-tabs {
        display: flex;
        border-bottom: 2px solid #f3f4f6;
        margin-bottom: 20px;
    }
    .gallery-tab {
        padding: 10px 20px;
        cursor: pointer;
        font-weight: 600;
        color: #6b7280;
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
    }
    .gallery-tab:hover { color: #d97706; }
    .gallery-tab.active {
        color: #d97706;
        border-bottom: 2px solid #d97706;
    }
    .empty-state {
        grid-column: 1 / -1;
        text-align: center;
        padding: 20px;
        color: #9ca3af;
        font-style: italic;
    }
</style>

<section class="edit-profile-section">
    <div class="container">
        <div style="text-align: center; margin-bottom: 40px;" data-animate="fade-down">
            <h1 style="font-size: 2.5rem; font-weight: 800; color: var(--dark-ink);">H·ªì S∆° C·ªßa B·∫°n üõ†Ô∏è</h1>
            <p style="color: #666;">C·∫≠p nh·∫≠t th√¥ng tin ƒë·ªÉ "ng·∫ßu" h∆°n tr√™n b·∫£ng x·∫øp h·∫°ng nh√©!</p>
        </div>

        <form action="/profile/edit" method="POST" class="edit-grid">
            
            <div class="profile-card avatar-zone">
                <div class="avatar-wrapper">
                    <img src="<%= user.avatar || 'https://cdn-icons-png.flaticon.com/512/847/847969.png' %>" 
                         class="avatar-preview" id="avatarPreview">
                </div>
                
                <div class="user-display-name"><%= user.username %></div>
                <div class="user-role-badge">
                    <%= user.isPro ? 'üëë VIP Member' : 'üå± Newbie' %>
                </div>

                <div class="form-group" style="margin-top: 20px;">
                    <label style="font-weight: 600; color: #374151; margin-bottom: 8px; display: block; font-size: 0.9rem;">·∫¢nh ƒë·∫°i di·ªán</label>
                    
                    <div style="display: flex; gap: 10px; align-items: flex-start; flex-direction: column;">
                        <div class="input-group" style="display: flex; gap: 10px; width: 100%;">
                            <input type="text" 
                                   class="input-v3" 
                                   name="avatar" 
                                   id="avatarInput" 
                                   value="<%= user.avatar %>" 
                                   placeholder="Nh·∫≠p link ho·∫∑c ch·ªçn t·ª´ kho..." 
                                   oninput="document.getElementById('avatarPreview').src = this.value || 'https://cdn-icons-png.flaticon.com/512/847/847969.png'"
                                   style="flex: 1;">
                            
                            <button type="button" 
                                    onclick="openAvatarModal()" 
                                    style="background: #eef2ff; color: #4f46e5; border: 1px solid #c7d2fe; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 5px; white-space: nowrap; transition: 0.2s;">
                                <i class="fas fa-images"></i> Kho Avatar
                            </button>
                        </div>
                        <small style="color: #6b7280; font-size: 0.8rem;">B·∫°n c√≥ th·ªÉ ch·ªçn ·∫£nh m·∫´u mi·ªÖn ph√≠ ho·∫∑c ·∫£nh ƒë√£ t·∫£i l√™n (PRO).</small>
                    </div>
                </div>
            </div>

            <div class="profile-card form-zone">
                <h3 class="card-title"><i class="fas fa-info-circle"></i> Th√¥ng Tin C√° Nh√¢n</h3>
                
                <div class="input-group-v3">
                    <label class="label-v3">Email li√™n h·ªá</label>
                    <input type="email" name="email" class="input-v3" value="<%= user.email || '' %>" placeholder="v√≠ d·ª•: tenban@gmail.com">
                </div>

                <div class="input-group-v3">
                    <label class="label-v3">Ti·ªÉu s·ª≠ (Bio)</label>
                    <textarea name="bio" class="input-v3 textarea-v3" placeholder="H√£y vi·∫øt g√¨ ƒë√≥ th·∫≠t 'ch·∫•t' v·ªÅ b·∫£n th√¢n..."><%= user.bio || '' %></textarea>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="input-group-v3">
                        <label class="label-v3">L·ªõp</label>
                        <input type="text" name="class" class="input-v3" value="<%= user.class || '' %>" placeholder="VD: 12A1">
                    </div>
                    <div class="input-group-v3">
                        <label class="label-v3">Tr∆∞·ªùng</label>
                        <select name="school" class="input-v3">
                            <option value="" disabled <%= !user.school ? 'selected' : '' %>>Ch·ªçn tr∆∞·ªùng...</option>
                            <option value="THPT Th·ªß ƒê·ª©c" <%= user.school === 'THPT Th·ªß ƒê·ª©c' ? 'selected' : '' %>>THPT Th·ªß ƒê·ª©c</option>
                            <option value="THPT Nguy·ªÖn H·ªØu Hu√¢n" <%= user.school === 'THPT Nguy·ªÖn H·ªØu Hu√¢n' ? 'selected' : '' %>>THPT Nguy·ªÖn H·ªØu Hu√¢n</option>
                            <option value="Kh√°c" <%= user.school === 'Kh√°c' ? 'selected' : '' %>>Kh√°c...</option>
                        </select>
                    </div>
                </div>
                
                <div class="profile-card password-toggle-card" id="passwordCard">
                    <div class="toggle-header" id="pwToggleHeader">
                        <div class="toggle-title">
                            <i class="fas fa-lock-open"></i>
                            <h4>ƒê·ªïi M·∫≠t Kh·∫©u</h4>
                        </div>
                        <div class="toggle-status-icon">
                            <i class="fas fa-chevron-down toggle-arrow"></i>
                        </div>
                    </div>
                    
                    <div id="pwFields" class="password-content">
                        <div class="input-group-v3">
                            <label class="label-v3">M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
                            <div class="password-wrapper">
                                <input type="password" name="currentPassword" class="input-v3" placeholder="Nh·∫≠p m·∫≠t kh·∫©u c≈©..." disabled>
                                <button type="button" class="eye-btn"><i class="fas fa-eye"></i></button>
                            </div>
                        </div>
                        <div class="input-group-v3">
                            <label class="label-v3">M·∫≠t kh·∫©u m·ªõi</label>
                            <div class="password-wrapper">
                                <input type="password" name="newPassword" class="input-v3" placeholder="T·ªëi thi·ªÉu 8 k√Ω t·ª±..." disabled>
                                <button type="button" class="eye-btn"><i class="fas fa-eye"></i></button>
                            </div>
                        </div>
                        <div class="input-group-v3">
                            <label class="label-v3">X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi</label>
                            <input type="password" name="confirmNewPassword" class="input-v3" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi..." disabled>
                        </div>
                        <div id="pwMatchMessage" class="match-message"></div>
                    </div>
                </div>

                <div class="action-bar">
                    <a href="/profile" class="btn-cancel">H·ªßy</a>
                    <button type="submit" class="btn-save">
                        <i class="fas fa-save"></i> L∆∞u Thay ƒê·ªïi
                    </button>
                </div>
            </div>
        </form>
    </div>
</section>

<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script src="/js/profileEditor.js"></script>

<div id="avatarModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
    <div class="modal-content" style="background: white; width: 600px; max-width: 90%; border-radius: 12px; padding: 20px; position: relative; max-height: 80vh; overflow-y: auto;">
        <span onclick="closeAvatarModal()" style="position: absolute; right: 20px; top: 15px; font-size: 24px; cursor: pointer; color: #666;">&times;</span>
        
        <h3 style="margin-bottom: 0px; color: var(--dark-ink);">Ch·ªçn ·∫¢nh ƒê·∫°i Di·ªán</h3>
        
        <div class="gallery-tabs">
            <div class="gallery-tab active" onclick="switchTab('default')">M·∫´u c√≥ s·∫µn (Free)</div>
            <div class="gallery-tab" onclick="switchTab('uploaded')">·∫¢nh c·ªßa t√¥i (PRO)</div>
        </div>

        <div id="galleryGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px;">
            </div>

        <div id="uploadAction" style="display: none; margin-top: 15px; text-align: center; border-top: 1px dashed #ddd; padding-top: 15px;">
            <p style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">B·∫°n mu·ªën d√πng ·∫£nh kh√°c? H√£y t·∫£i l√™n kho ·∫£nh PRO.</p>
            <a href="/pro-images" target="_blank" class="btn-save" style="display: inline-block; text-decoration: none; font-size: 0.9rem;">
                <i class="fas fa-cloud-upload-alt"></i> Qu·∫£n l√Ω & T·∫£i ·∫£nh l√™n
            </a>
        </div>
    </div>
</div>

<script>
    // Bi·∫øn l∆∞u tr·∫°ng th√°i PRO c·ªßa user ƒë·ªÉ JS x·ª≠ l√Ω
    const isUserPro = <%= user.isPro %>; 
    let currentTab = 'default';

    // Danh s√°ch ·∫£nh m·∫´u (Public)
    const defaultImages = [
        { url: 'https://cdn-icons-png.flaticon.com/512/4140/4140048.png' },
        { url: 'https://cdn-icons-png.flaticon.com/512/4140/4140037.png' },
        { url: 'https://cdn-icons-png.flaticon.com/512/4140/4140047.png' },
        { url: 'https://cdn-icons-png.flaticon.com/512/924/924915.png' },
        { url: 'https://cdn-icons-png.flaticon.com/512/2922/2922506.png' },
        { url: 'https://cdn-icons-png.flaticon.com/512/2922/2922510.png' },
        { url: 'https://cdn-icons-png.flaticon.com/512/921/921071.png' },
        { url: 'https://cdn-icons-png.flaticon.com/512/1999/1999625.png' },
        { url: 'https://cdn-icons-png.flaticon.com/512/4140/4140061.png' },
        { url: 'https://cdn-icons-png.flaticon.com/512/4140/4140051.png' }
    ];

    // M·ªü Modal
    function openAvatarModal() {
        document.getElementById('avatarModal').style.display = 'flex';
        // M·∫∑c ƒë·ªãnh load tab default
        switchTab('default');
    }

    // ƒê√≥ng Modal
    function closeAvatarModal() {
        document.getElementById('avatarModal').style.display = 'none';
    }

    // Chuy·ªÉn Tab
    function switchTab(tabName) {
        currentTab = tabName;
        const grid = document.getElementById('galleryGrid');
        const uploadAction = document.getElementById('uploadAction');
        const tabs = document.querySelectorAll('.gallery-tab');

        // C·∫≠p nh·∫≠t UI Tabs
        tabs.forEach(t => t.classList.remove('active'));
        if(tabName === 'default') tabs[0].classList.add('active');
        else tabs[1].classList.add('active');

        grid.innerHTML = '<p style="grid-column: 1/-1; text-align:center;">ƒêang t·∫£i...</p>';

        if (tabName === 'default') {
            uploadAction.style.display = 'none';
            renderImages(defaultImages);
        } else {
            // Tab Uploaded (PRO only)
            if (!isUserPro) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-lock" style="font-size: 2rem; color: #d97706; margin-bottom: 10px;"></i><br>
                        T√≠nh nƒÉng n√†y ch·ªâ d√†nh cho t√†i kho·∫£n <b>VIP Member</b>.<br>
                        <a href="/upgrade" target="_blank" style="color: #4f46e5; font-weight: bold;">N√¢ng c·∫•p ngay</a> ƒë·ªÉ t·∫£i ·∫£nh ri√™ng c·ªßa b·∫°n!
                    </div>
                `;
                uploadAction.style.display = 'none';
                return;
            }
            
            uploadAction.style.display = 'block';
            fetchUploadedImages();
        }
    }

    // Render ·∫£nh ra Grid
    function renderImages(images) {
        const grid = document.getElementById('galleryGrid');
        grid.innerHTML = '';

        if (!images || images.length === 0) {
            grid.innerHTML = '<div class="empty-state">Ch∆∞a c√≥ ·∫£nh n√†o.</div>';
            return;
        }

        images.forEach(img => {
            const imgEl = document.createElement('img');
            imgEl.src = img.url;
            imgEl.title = img.displayName || img.tag || 'Avatar';
            imgEl.style.cssText = "width: 100%; aspect-ratio: 1/1; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: all 0.2s ease; object-fit: cover; background: #f9fafb;";
            
            // Hover effect
            imgEl.onmouseover = () => { imgEl.style.border = "2px solid #d97706"; imgEl.style.transform = "scale(1.1)"; };
            imgEl.onmouseout = () => { imgEl.style.border = "2px solid transparent"; imgEl.style.transform = "scale(1)"; };

            // Select action
            imgEl.onclick = () => {
                document.getElementById('avatarInput').value = img.url;
                document.getElementById('avatarPreview').src = img.url;
                closeAvatarModal();
            };

            grid.appendChild(imgEl);
        });
    }

    // G·ªçi API l·∫•y ·∫£nh PRO
    async function fetchUploadedImages() {
        try {
            // G·ªçi route /api/pro-images/list m√† b·∫°n ƒë√£ ƒë·ªãnh nghƒ©a trong proImages.js
            const res = await fetch('/api/pro-images/list');
            if (res.status === 403 || res.status === 401) {
                // X·ª≠ l√Ω tr∆∞·ªùng h·ª£p h·∫øt phi√™n ho·∫∑c m·∫•t quy·ªÅn
                alert('Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i ƒë·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng n√†y.');
                return;
            }
            const data = await res.json();
            renderImages(data);
        } catch (error) {
            console.error(error);
            document.getElementById('galleryGrid').innerHTML = '<p style="color:red; grid-column: 1/-1; text-align:center;">L·ªói t·∫£i ·∫£nh.</p>';
        }
    }

    // ƒê√≥ng modal khi click ra ngo√†i
    window.onclick = function(event) {
        const modal = document.getElementById('avatarModal');
        if (event.target == modal) {
            closeAvatarModal();
        }
    }
</script>

<%- include('partials/footer') %>