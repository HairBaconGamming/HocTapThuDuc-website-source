<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Học Tập Thủ Đức</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #4f46e5; --dark: #1e293b; --light: #f8fafc; --danger: #ef4444; --success: #22c55e; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        body { display: flex; height: 100vh; background: var(--light); overflow: hidden; }
        
        /* SIDEBAR */
        .sidebar { width: 250px; background: var(--dark); color: white; display: flex; flex-direction: column; }
        .brand { padding: 20px; font-size: 1.2rem; font-weight: bold; border-bottom: 1px solid #334155; }
        .menu { flex: 1; padding: 10px; }
        .menu-item { display: block; padding: 12px 15px; color: #94a3b8; text-decoration: none; border-radius: 6px; margin-bottom: 5px; cursor: pointer; transition: 0.2s; }
        .menu-item:hover, .menu-item.active { background: var(--primary); color: white; }
        .menu-item i { width: 25px; }

        /* MAIN CONTENT */
        .main { flex: 1; padding: 20px; overflow-y: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        
        /* SECTIONS (TABS) */
        .section { display: none; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* DASHBOARD CARDS */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 4px solid var(--primary); }
        .card h3 { font-size: 2rem; color: var(--dark); }
        .card p { color: #64748b; }

        /* TABLES */
        .table-container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        th { background: #f1f5f9; font-weight: 600; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; }
        .bg-green { background: #dcfce7; color: #166534; }
        .bg-red { background: #fee2e2; color: #991b1b; }
        
        /* FORMS & MODALS */
        .btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; color: white; font-size: 0.9rem; text-decoration: none; display: inline-block; }
        .btn-primary { background: var(--primary); }
        .btn-danger { background: var(--danger); }
        .btn-edit { background: #f59e0b; }
        
        /* Custom Input Styling */
        input[type="text"], input[type="password"], textarea, select { width: 100%; padding: 8px; margin: 5px 0 15px; border: 1px solid #cbd5e1; border-radius: 4px; }
        
        /* Modal Popup (ẩn mặc định) */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 10px; width: 400px; max-width: 90%; }
        .close { float: right; cursor: pointer; font-size: 1.5rem; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="brand"><i class="fas fa-user-shield"></i> Admin Panel</div>
        <nav class="menu">
            <a class="menu-item active" onclick="showTab('dashboard')"><i class="fas fa-chart-line"></i> Dashboard</a>
            <a class="menu-item" onclick="showTab('users')"><i class="fas fa-users"></i> Người dùng</a>
            <a class="menu-item" onclick="showTab('courses')"><i class="fas fa-book"></i> Khóa học</a>
            <a class="menu-item" onclick="showTab('news')"><i class="fas fa-newspaper"></i> Tin tức</a>
            <a href="/" class="menu-item"><i class="fas fa-sign-out-alt"></i> Về trang chủ</a>
        </nav>
    </div>

    <div class="main">
        <div class="header">
            <h2>Xin chào, <%= user.username %></h2>
        </div>

        <div id="dashboard" class="section active">
            <div class="stats-grid">
                <div class="card">
                    <h3><%= stats.totalUsers %></h3>
                    <p>Tổng thành viên</p>
                </div>
                <div class="card" style="border-color: #22c55e;">
                    <h3><%= stats.totalCourses %></h3>
                    <p>Khóa học</p>
                </div>
                <div class="card" style="border-color: #f59e0b;">
                    <h3><%= stats.totalLessons %></h3>
                    <p>Bài học</p>
                </div>
                <div class="card" style="border-color: #ef4444;">
                    <h3><%= stats.totalNews %></h3>
                    <p>Bài viết tin tức</p>
                </div>
            </div>
        </div>

        <div id="users" class="section">
            <div class="table-container">
                <h3>Quản lý người dùng</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Loại TK</th>
                            <th>Hành động</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% users.forEach(u => { %>
                        <tr>
                            <td><%= u.username %></td>
                            <td><%= u.email %></td>
                            <td><%= u.role %></td>
                            <td>
                                <% if(u.isPro) { %><span class="badge bg-green">PRO</span><% } %>
                                <% if(u.isTeacher) { %><span class="badge bg-green">GV</span><% } %>
                            </td>
                            <td>
                                <button class="btn btn-edit" onclick="openUserModal('<%= u._id %>', '<%= u.username %>', '<%= u.role %>', <%= u.isPro %>, <%= u.isTeacher %>, '<%= u.proSecretKey || '' %>')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <form action="/admin/user/delete" method="POST" style="display:inline;" onsubmit="return confirm('Xóa user này?');">
                                    <input type="hidden" name="userId" value="<%= u._id %>">
                                    <button class="btn btn-danger"><i class="fas fa-trash"></i></button>
                                </form>
                            </td>
                        </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="courses" class="section">
            <div class="table-container">
                <h3>Quản lý khóa học</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Tên khóa</th>
                            <th>Tác giả</th>
                            <th>Trạng thái</th>
                            <th>Hành động</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% courses.forEach(c => { %>
                        <tr>
                            <td><%= c.title %></td>
                            <td><%= c.author ? c.author.username : 'Unknown' %></td>
                            <td>
                                <span class="badge <%= c.isPublished ? 'bg-green' : 'bg-red' %>">
                                    <%= c.isPublished ? 'Đã đăng' : 'Nháp' %>
                                </span>
                            </td>
                            <td>
                                <form action="/admin/course/approve" method="POST" style="display:inline;">
                                    <input type="hidden" name="courseId" value="<%= c._id %>">
                                    <label>
                                        <input type="checkbox" name="isPublished" onchange="this.form.submit()" <%= c.isPublished ? 'checked' : '' %>>
                                        Public
                                    </label>
                                </form>
                                <form action="/admin/course/delete" method="POST" style="display:inline; margin-left: 10px;" onsubmit="return confirm('Xóa khóa học này?');">
                                    <input type="hidden" name="courseId" value="<%= c._id %>">
                                    <button class="btn btn-danger btn-sm"><i class="fas fa-trash"></i></button>
                                </form>
                            </td>
                        </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="news" class="section">
            <div class="table-container">
                <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                    <h3>Quản lý Tin tức</h3>
                    <button class="btn btn-primary" onclick="document.getElementById('modalNews').style.display='flex'">
                        <i class="fas fa-plus"></i> Viết bài mới
                    </button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Tiêu đề</th>
                            <th>Ngày đăng</th>
                            <th>Hành động</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% news.forEach(post => { %>
                        <tr>
                            <td><%= post.title %></td>
                            <td><%= new Date(post.createdAt).toLocaleDateString('vi-VN') %></td>
                            <td>
                                <form action="/admin/news/delete" method="POST" onsubmit="return confirm('Xóa bài này?');">
                                    <input type="hidden" name="newsId" value="<%= post._id %>">
                                    <button class="btn btn-danger"><i class="fas fa-trash"></i></button>
                                </form>
                            </td>
                        </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <div id="modalUser" class="modal">
        <div class="modal-content">
            <span class="close" onclick="document.getElementById('modalUser').style.display='none'">&times;</span>
            <h3>Chỉnh sửa User: <span id="editUsername"></span></h3>
            <form action="/admin/user/update" method="POST">
                <input type="hidden" name="userId" id="editUserId">
                
                <label>Vai trò (Role):</label>
                <select name="role" id="editRole">
                    <option value="user">User</option>
                    <option value="admin">Admin</option>
                </select>

                <label>
                    <input type="checkbox" name="isPro" id="editIsPro"> Tài khoản PRO
                </label>
                <br>
                <label>
                    <input type="checkbox" name="isTeacher" id="editIsTeacher"> Giáo viên (Teacher)
                </label>

                <label style="display:block; margin-top:10px;">PRO Secret Key:</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" name="proSecretKey" id="editProKey" 
                        placeholder="Nhập key riêng hoặc bấm tạo..." 
                        style="flex: 1; margin-bottom: 0;"> <button type="button" class="btn btn-edit" onclick="generateKey()" title="Tạo mã ngẫu nhiên">
                        <i class="fas fa-magic"></i> Random
                    </button>
                </div>
                <small style="color: #64748b; font-style: italic;">Mã bí mật dùng để kích hoạt hoặc xác thực riêng.</small>

                <button type="submit" class="btn btn-primary" style="width:100%">Lưu thay đổi</button>
            </form>
        </div>
    </div>

    <div id="modalNews" class="modal">
        <div class="modal-content" style="width: 600px;">
            <span class="close" onclick="document.getElementById('modalNews').style.display='none'">&times;</span>
            <h3>Đăng bài viết mới</h3>
            <form action="/admin/news/create" method="POST">
                <label>Tiêu đề:</label>
                <input type="text" name="title" required>

                <label>Link ảnh Thumbnail:</label>
                <input type="text" name="thumbnail" placeholder="https://...">

                <label>Nội dung:</label>
                <textarea name="content" rows="5" required></textarea>

                <button type="submit" class="btn btn-primary" style="width:100%">Đăng bài</button>
            </form>
        </div>
    </div>

    <script>
        // Hàm tạo chuỗi ngẫu nhiên
        function generateKey() {
            // Độ dài key mong muốn
            const length = 16;
            const charset = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
            let retVal = "";
            
            // Tạo chuỗi ngẫu nhiên
            for (let i = 0, n = charset.length; i < length; ++i) {
                retVal += charset.charAt(Math.floor(Math.random() * n));
            }
            
            // Thêm tiền tố PRO- cho ngầu và dễ nhận diện
            const finalKey = "PRO-" + retVal.toUpperCase();
            
            // Gán vào ô input
            document.getElementById('editProKey').value = finalKey;
        }
        // Tab switching logic
        function showTab(tabId) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            
            document.getElementById(tabId).classList.add('active');
            // Tìm thẻ a chứa onclick tương ứng để active (cách đơn giản)
            event.currentTarget.classList.add('active');
            
            // Cập nhật URL param để khi reload vẫn ở tab đó
            const url = new URL(window.location);
            url.searchParams.set('tab', tabId);
            window.history.pushState({}, '', url);
        }

        // Check URL param on load
        window.onload = function() {
            const params = new URLSearchParams(window.location.search);
            const tab = params.get('tab');
            if(tab && document.getElementById(tab)) {
                // Giả lập click vào menu tương ứng
                const menus = document.querySelectorAll('.menu-item');
                if(tab === 'dashboard') menus[0].click();
                if(tab === 'users') menus[1].click();
                if(tab === 'courses') menus[2].click();
                if(tab === 'news') menus[3].click();
            }
        }

        // Modal Edit User logic
        function openUserModal(id, username, role, isPro, isTeacher, key) {
            document.getElementById('editUserId').value = id;
            document.getElementById('editUsername').innerText = username;
            document.getElementById('editRole').value = role;
            document.getElementById('editIsPro').checked = isPro;
            document.getElementById('editIsTeacher').checked = isTeacher;
            document.getElementById('editProKey').value = key;
            
            document.getElementById('modalUser').style.display = 'flex';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = "none";
            }
        }
    </script>
</body>
</html>