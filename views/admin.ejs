<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | HTTD</title>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/styleAdminV2.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div class="admin-wrapper">
    
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="brand-logo">
                <i class="fas fa-meteor"></i> HTTD <span class="brand-suffix">Admin</span>
            </div>
            <div class="brand-badge">PRO v2.0</div>
        </div>

        <nav class="sidebar-nav">
            <p class="nav-label">QU·∫¢N L√ù CHUNG</p>
            
            <div class="menu-item active" onclick="showTab('dashboard', this)">
                <div class="icon-box"><i class="fas fa-chart-pie"></i></div>
                <span>Dashboard</span>
            </div>

            <p class="nav-label">D·ªÆ LI·ªÜU</p>

            <div class="menu-item" onclick="showTab('users', this)">
                <div class="icon-box"><i class="fas fa-users"></i></div>
                <span>C∆∞ d√¢n (Users)</span>
            </div>
            
            <div class="menu-item" onclick="showTab('lessons', this)">
                <div class="icon-box"><i class="fas fa-book-open"></i></div>
                <span>Kho b√†i h·ªçc</span>
            </div>
            
            <div class="menu-item" onclick="showTab('news', this)">
                <div class="icon-box"><i class="far fa-newspaper"></i></div>
                <span>Tin t·ª©c & Event</span>
            </div>

            <div class="menu-item" onclick="showTab('units', this)">
                <div class="icon-box"><i class="fas fa-layer-group"></i></div>
                <span>Ch∆∞∆°ng (Units)</span>
            </div>

            <p class="nav-label">H·ªÜ TH·ªêNG</p>
            
            <div class="menu-item" onclick="alert('T√≠nh nƒÉng ƒëang ph√°t tri·ªÉn!')">
                <div class="icon-box"><i class="fas fa-cogs"></i></div>
                <span>C√†i ƒë·∫∑t</span>
            </div>
        </aside>

        <div class="sidebar-footer">
            <div class="user-mini-profile">
                <img src="<%= user.avatar || 'https://cdn-icons-png.flaticon.com/512/847/847969.png' %>" class="mini-avatar">
                <div class="mini-info">
                    <div class="mini-name"><%= user.username %></div>
                    <div class="mini-role">Administrator</div>
                </div>
            </div>
            <button class="btn-mini-logout" onclick="location.href='/logout'" title="ƒêƒÉng xu·∫•t">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>
    </aside>

    <main class="main-content">
        
        <div class="top-bar">
            <div>
                <h1 class="page-title">Xin ch√†o, <%= user.username %> üëã</h1>
                <p style="color: #6b7280;">H√¥m nay h·ªá th·ªëng ho·∫°t ƒë·ªông th·∫ø n√†o?</p>
            </div>
            <div style="display: flex; gap: 15px;">
                <button class="btn-action-sm" style="background:white; width: 40px; height: 40px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                    <i class="fas fa-bell"></i>
                </button>
                <img src="<%= user.avatar || 'https://cdn-icons-png.flaticon.com/512/847/847969.png' %>" 
                     style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
            </div>
        </div>

        <div id="tab-dashboard" class="tab-pane active">
            <div class="stats-grid">
                <div class="stat-card sc-blue">
                    <div class="stat-info">
                        <h3><%= stats.totalUsers %></h3>
                        <p>T·ªïng Th√†nh vi√™n</p>
                    </div>
                    <i class="fas fa-user-friends stat-icon"></i>
                </div>
                <div class="stat-card sc-orange">
                    <div class="stat-info">
                        <h3><%= stats.proUsers %></h3>
                        <p>Th√†nh vi√™n VIP</p>
                    </div>
                    <i class="fas fa-crown stat-icon"></i>
                </div>
                <div class="stat-card sc-green">
                    <div class="stat-info">
                        <h3><%= stats.totalLessons %></h3>
                        <p>B√†i h·ªçc</p>
                    </div>
                    <i class="fas fa-book-open stat-icon"></i>
                </div>
                <div class="stat-card sc-red">
                    <div class="stat-info">
                        <h3><%= stats.totalNews %></h3>
                        <p>Tin t·ª©c</p>
                    </div>
                    <i class="far fa-newspaper stat-icon"></i>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
                <div class="table-card">
                    <h3 style="margin-bottom: 20px;">üìà Truy c·∫≠p tu·∫ßn qua</h3>
                    <canvas id="trafficChart"></canvas>
                </div>
                <div class="table-card">
                    <h3 style="margin-bottom: 20px;">üç∞ T·ªâ l·ªá VIP</h3>
                    <canvas id="userChart"></canvas>
                </div>
            </div>
        </div>

        <div id="tab-users" class="tab-pane">
            <div class="table-card">
                <div class="table-header">
                    <h3>Danh s√°ch C∆∞ d√¢n</h3>
                    <input type="text" class="search-input" placeholder="T√¨m theo t√™n, email..." onkeyup="searchTable('userTable', this.value)">
                </div>
                <div style="overflow-x: auto;">
                    <table class="admin-table" id="userTable">
                        <thead>
                            <tr>
                                <th>Avatar</th>
                                <th>T√™n hi·ªÉn th·ªã</th>
                                <th>Email</th>
                                <th>G√≥i</th>
                                <th>ƒêi·ªÉm</th>
                                <th>H√†nh ƒë·ªông</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% users.forEach(u => { %>
                                <tr>
                                    <td><img src="<%= u.avatar || '/default.png' %>" style="width: 35px; height: 35px; border-radius: 50%;"></td>
                                    <td><b><%= u.username %></b></td>
                                    <td><%= u.email %></td>
                                    <td>
                                        <span class="badge <%= u.isPro ? 'badge-pro' : 'badge-free' %>">
                                            <%= u.isPro ? 'PRO' : 'Free' %>
                                        </span>
                                    </td>
                                    <td><%= u.points %></td>
                                    <td>
                                        <button class="btn-action-sm btn-edit" 
                                                onclick="openEditUser('<%= u._id %>', '<%= u.username %>', '<%= u.points %>', <%= u.isPro %>, <%= u.isBanned %>)">
                                            <i class="fas fa-pen"></i>
                                        </button>

                                        <button class="btn-action-sm btn-delete" 
                                                onclick="confirmDelete('users', '<%= u._id %>')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-lessons" class="tab-pane">
            <div class="table-card">
                <div class="table-header">
                    <h3>Kho b√†i h·ªçc</h3>
                    <div>
                        <input type="text" class="search-input" placeholder="T√¨m b√†i h·ªçc..." onkeyup="searchTable('lessonTable', this.value)">
                        <a href="/lesson/add" class="badge badge-pro" style="margin-left: 10px; text-decoration: none; font-size: 0.9rem; padding: 10px 15px;">+ Th√™m m·ªõi</a>
                    </div>
                </div>
                <table class="admin-table" id="lessonTable">
                    <thead>
                        <tr>
                            <th>Ti√™u ƒë·ªÅ</th>
                            <th>T√°c gi·∫£</th>
                            <th>Lo·∫°i</th>
                            <th>Ng√†y t·∫°o</th>
                            <th>H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% lessons.forEach(l => { %>
                            <tr>
                                <td style="max-width: 300px;"><%= l.title %></td>
                                <td><%= l.author ? l.author.username : 'Unknown' %></td>
                                <td><span class="badge" style="background:#e0e7ff; color:#3730a3"><%= l.type %></span></td>
                                <td><%= new Date(l.createdAt).toLocaleDateString('vi-VN') %></td>
                                <td>
                                    <a href="/lesson/<%= l._id %>/edit" class="btn-action-sm btn-edit"><i class="fas fa-pen"></i></a>

                                    <button class="btn-action-sm btn-delete" onclick="confirmDelete('lessons', '<%= l._id %>')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="tab-news" class="tab-pane">
            <div class="table-card">
                <div class="table-header">
                    <h3>Qu·∫£n l√Ω Tin t·ª©c</h3>
                    <input type="text" class="search-input" placeholder="T√¨m tin t·ª©c..." onkeyup="searchTable('newsTable', this.value)">
                </div>
                <table class="admin-table" id="newsTable">
                    <thead>
                        <tr>
                            <th>·∫¢nh</th>
                            <th>Ti√™u ƒë·ªÅ</th>
                            <th>Chuy√™n m·ª•c</th>
                            <th>H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% newsList.forEach(n => { %>
                            <tr>
                                <td><img src="<%= n.image %>" style="width: 50px; height: 30px; object-fit: cover; border-radius: 5px;"></td>
                                <td style="max-width: 350px;"><%= n.title %></td>
                                <td><%= n.category %></td>
                                <td>
                                    <a href="/news/<%= n._id %>/edit" class="btn-action-sm btn-edit"><i class="fas fa-pen"></i></a>

                                    <button class="btn-action-sm btn-delete" onclick="confirmDelete('news', '<%= n._id %>')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="tab-units" class="tab-pane">
            <div class="table-card">
                <div class="table-header">
                    <h3>C·∫•u tr√∫c Ch∆∞∆°ng h·ªçc</h3>
                    <button class="badge badge-pro" style="border:none; cursor:pointer; font-size: 0.9rem; padding: 10px 15px;" onclick="openCreateUnitModal()">
                        + Th√™m Ch∆∞∆°ng M·ªõi
                    </button>
                </div>
                <table class="admin-table" id="unitTable">
                    <thead>
                        <tr>
                            <th>T√™n Ch∆∞∆°ng</th>
                            <th>Thu·ªôc M√¥n</th>
                            <th>Th·ª© t·ª±</th>
                            <th>H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if(units && units.length > 0) { %>
                            <% units.forEach(u => { %>
                                <tr>
                                    <td><b><%= u.title %></b></td>
                                    <td><span class="badge" style="background:#e0f2fe; color:#0284c7"><%= u.subjectId ? u.subjectId.name : 'Unknown' %></span></td>
                                    <td><%= u.order %></td>
                                    <td>
                                        <button class="btn-action-sm btn-delete" onclick="confirmDelete('units', '<%= u._id %>')"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>
                            <% }) %>
                        <% } else { %>
                            <tr><td colspan="4" style="text-align:center;">Ch∆∞a c√≥ d·ªØ li·ªáu ch∆∞∆°ng.</td></tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <div id="editUserModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-user-cog"></i> Ch·ªânh s·ª≠a C∆∞ d√¢n</h3>
                <button class="btn-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
            </div>
            
            <form id="editUserForm">
                <input type="hidden" id="editUserId">
                
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="editUsername" disabled style="background: #eee; cursor: not-allowed;">
                </div>

                <div class="form-group">
                    <label>ƒêi·ªÉm s·ªë (Points)</label>
                    <input type="number" id="editPoints" class="admin-input">
                </div>

                <div class="form-row">
                    <label class="switch-label">
                        <input type="checkbox" id="editIsPro">
                        <span class="slider round"></span>
                        <span class="label-text">T√†i kho·∫£n PRO</span>
                    </label>

                    <label class="switch-label">
                        <input type="checkbox" id="editIsBanned">
                        <span class="slider round red"></span>
                        <span class="label-text" style="color: var(--danger)">C·∫•m (Ban)</span>
                    </label>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-cancel" onclick="closeModal()">H·ªßy</button>
                    <button type="submit" class="btn-save">L∆∞u thay ƒë·ªïi</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="createUnitModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-plus-circle"></i> Th√™m Ch∆∞∆°ng M·ªõi</h3>
            <button class="btn-close" onclick="closeUnitModal()"><i class="fas fa-times"></i></button>
        </div>
        <form id="createUnitForm">
            <div class="form-group">
                <label>Thu·ªôc M√¥n H·ªçc</label>
                <select id="unitSubjectId" class="admin-input" required>
                    <option value="">-- Ch·ªçn m√¥n h·ªçc --</option>
                    <% if(subjects) { %>
                        <% subjects.forEach(s => { %>
                            <option value="<%= s._id %>"><%= s.name %></option>
                        <% }) %>
                    <% } %>
                </select>
            </div>
            <div class="form-group">
                <label>T√™n Ch∆∞∆°ng (V√≠ d·ª•: Ch∆∞∆°ng 1 - H√†m s·ªë)</label>
                <input type="text" id="unitTitle" class="admin-input" required>
            </div>
            <div class="form-group">
                <label>Th·ª© t·ª± hi·ªÉn th·ªã (S·ªë)</label>
                <input type="number" id="unitOrder" class="admin-input" value="1">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="closeUnitModal()">H·ªßy</button>
                <button type="submit" class="btn-save">T·∫°o ngay</button>
            </div>
        </form>
    </div>
</div>

<script>
    // Logic Modal Unit
    const unitModal = document.getElementById('createUnitModal');
    function openCreateUnitModal() { unitModal.classList.add('active'); }
    function closeUnitModal() { unitModal.classList.remove('active'); }

    document.getElementById('createUnitForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = {
            subjectId: document.getElementById('unitSubjectId').value,
            title: document.getElementById('unitTitle').value,
            order: document.getElementById('unitOrder').value
        };
        
        try {
            const res = await fetch('/admin/units', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            const result = await res.json();
            if(result.success) {
                Swal.fire('Th√†nh c√¥ng', result.message, 'success').then(() => location.reload());
            } else {
                Swal.fire('L·ªói', result.error, 'error');
            }
        } catch(err) { Swal.fire('L·ªói', 'L·ªói k·∫øt n·ªëi', 'error'); }
    });
</script>

<script>
    // 1. Tab Switching Logic
    function showTab(tabId, btnElement) {
        // Hide all tabs
        document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
        // Show target tab
        document.getElementById('tab-' + tabId).classList.add('active');
        
        // Update sidebar active state
        document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
        btnElement.classList.add('active');
    }

    // 2. Client-side Search Function
    function searchTable(tableId, query) {
        const filter = query.toUpperCase();
        const table = document.getElementById(tableId);
        const tr = table.getElementsByTagName("tr");

        for (let i = 1; i < tr.length; i++) { // Skip header
            let visible = false;
            const tds = tr[i].getElementsByTagName("td");
            for (let j = 0; j < tds.length; j++) {
                if (tds[j]) {
                    if (tds[j].textContent.toUpperCase().indexOf(filter) > -1) {
                        visible = true;
                        break;
                    }
                }
            }
            tr[i].style.display = visible ? "" : "none";
        }
    }

    // 3. Chart.js Initialization
    document.addEventListener("DOMContentLoaded", () => {
        // Traffic Chart (Line)
        const ctxTraffic = document.getElementById('trafficChart').getContext('2d');
        new Chart(ctxTraffic, {
            type: 'line',
            data: {
                labels: ['Th·ª© 2', 'Th·ª© 3', 'Th·ª© 4', 'Th·ª© 5', 'Th·ª© 6', 'Th·ª© 7', 'CN'],
                datasets: [{
                    label: 'L∆∞·ª£t truy c·∫≠p',
                    data: [12, 19, 3, 5, 2, 3, 10], // D·ªØ li·ªáu gi·∫£ l·∫≠p
                    borderColor: '#3b82f6',
                    tension: 0.4,
                    fill: true,
                    backgroundColor: 'rgba(59, 130, 246, 0.1)'
                }]
            },
            options: { responsive: true, plugins: { legend: { display: false } } }
        });

        // User Ratio Chart (Doughnut)
        const ctxUser = document.getElementById('userChart').getContext('2d');
        new Chart(ctxUser, {
            type: 'doughnut',
            data: {
                labels: ['Free', 'PRO'],
                datasets: [{
                    data: [<%= stats.totalUsers - stats.proUsers %>, <%= stats.proUsers %>],
                    backgroundColor: ['#e5e7eb', '#f59e0b']
                }]
            }
        });
    });
</script>

<script>
    // --- 1. X·ª¨ L√ù MODAL EDIT USER ---
    const modal = document.getElementById('editUserModal');
    
    function openEditUser(id, username, points, isPro, isBanned) {
        // ƒêi·ªÅn d·ªØ li·ªáu v√†o form
        document.getElementById('editUserId').value = id;
        document.getElementById('editUsername').value = username;
        document.getElementById('editPoints').value = points;
        document.getElementById('editIsPro').checked = isPro; // true/false
        document.getElementById('editIsBanned').checked = isBanned; // true/false
        
        // Hi·ªán modal
        modal.classList.add('active');
    }

    function closeModal() {
        modal.classList.remove('active');
    }

    // X·ª≠ l√Ω Submit Form S·ª≠a User
    document.getElementById('editUserForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const id = document.getElementById('editUserId').value;
        const data = {
            points: document.getElementById('editPoints').value,
            isPro: document.getElementById('editIsPro').checked,
            isBanned: document.getElementById('editIsBanned').checked
        };

        try {
            const res = await fetch(`/admin/users/${id}`, { // Route n√†y ph·∫£i kh·ªõp v·ªõi Controller
                method: 'POST', // Ho·∫∑c PUT t√πy route c·ªßa b·∫°n
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await res.json();

            if (result.success) {
                Swal.fire('Th√†nh c√¥ng!', 'C·∫≠p nh·∫≠t user th√†nh c√¥ng.', 'success')
                .then(() => location.reload());
            } else {
                Swal.fire('L·ªói!', result.error || 'C√≥ l·ªói x·∫£y ra.', 'error');
            }
        } catch (err) {
            Swal.fire('L·ªói!', 'Kh√¥ng th·ªÉ k·∫øt n·ªëi server.', 'error');
        }
    });

    // --- 2. X·ª¨ L√ù X√ìA (DELETE) CHUNG ---
    function confirmDelete(type, id) {
        // type: 'users', 'lessons', ho·∫∑c 'news'
        let textWarning = "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a kh√¥ng?";
        if(type === 'users') textWarning = "H√†nh ƒë·ªông n√†y s·∫Ω x√≥a vƒ©nh vi·ªÖn t√†i kho·∫£n n√†y!";

        Swal.fire({
            title: 'X√°c nh·∫≠n x√≥a?',
            text: textWarning,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ef4444',
            cancelButtonColor: '#6b7280',
            confirmButtonText: 'X√≥a ngay',
            cancelButtonText: 'H·ªßy'
        }).then(async (result) => {
            if (result.isConfirmed) {
                try {
                    const res = await fetch(`/admin/${type}/${id}`, {
                        method: 'DELETE'
                    });
                    const data = await res.json();

                    if (data.success) {
                        Swal.fire('ƒê√£ x√≥a!', data.message, 'success')
                        .then(() => location.reload()); // Load l·∫°i trang ƒë·ªÉ c·∫≠p nh·∫≠t b·∫£ng
                    } else {
                        Swal.fire('L·ªói!', data.error || 'Kh√¥ng th·ªÉ x√≥a.', 'error');
                    }
                } catch (err) {
                    Swal.fire('L·ªói!', 'L·ªói k·∫øt n·ªëi server.', 'error');
                }
            }
        });
    }
</script>

</body>
</html>