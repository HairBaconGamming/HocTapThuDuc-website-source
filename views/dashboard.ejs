<%- include('partials/header') %>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

<link rel="stylesheet" href="/css/styleDashboard.css">

<script>
    // Inject weekly activity data t·ª´ server
    const weeklyActivity = <%= weeklyActivity %>;
</script>

<div class="dashboard-container">
    <div class="dashboard-hero animate__animated animate__fadeInDown">
        <div class="hero-content">
            <h1>Ch√†o bu·ªïi s√°ng, <%= user.username %>! üëã</h1>
            <p>H√¥m nay l√† m·ªôt ng√†y tuy·ªát v·ªùi ƒë·ªÉ h·ªçc th√™m ƒëi·ªÅu m·ªõi.</p>
            
            <div class="level-bar-wrapper">
                <div class="d-flex justify-content-between text-white mb-1 small fw-bold">
                    <span>C·∫•p ƒë·ªô <%= user.level || 1 %></span>
                    <span><%= user.xp || 0 %> / <%= (user.level || 1) * 1000 %> XP</span>
                </div>
                <div class="progress" style="height: 8px; background: rgba(255,255,255,0.2);">
                    <% 
                        const maxXP = (user.level || 1) * 1000;
                        const currentXP = user.xp || 0;
                        const percent = Math.min((currentXP / maxXP) * 100, 100);
                    %>
                    <div class="progress-bar bg-warning" role="progressbar" style="width: <%= percent %>%"></div>
                </div>
            </div>
        </div>
        <div class="hero-image">
            <img src="/img/dashboard-hero.svg" alt="Learning" onerror="this.src='https://cdn-icons-png.flaticon.com/512/2936/2936719.png'">
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <a href="/my-garden" class="action-btn action-garden" title="V√†o khu v∆∞·ªùn">
            <i class="fas fa-seedling"></i>
            <span>V∆∞·ªùn c·ªßa t√¥i</span>
        </a>
        <a href="/lesson/add" class="action-btn action-create" title="So·∫°n b√†i m·ªõi">
            <i class="fas fa-pen-fancy"></i>
            <span>T·∫°o b√†i h·ªçc</span>
        </a>
        <a href="/courses" class="action-btn action-explore" title="Kh√°m ph√° kh√≥a h·ªçc">
            <i class="fas fa-book"></i>
            <span>Kh√°m ph√°</span>
        </a>
        <a href="/news/post" class="action-btn action-news" title="ƒêƒÉng tin t·ª©c">
            <i class="fas fa-newspaper"></i>
            <span>ƒêƒÉng b√†i</span>
        </a>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="icon-box bg-primary-subtle text-primary"><i class="fas fa-book-open"></i></div>
            <div>
                <h3><%= enrolledCourses ? enrolledCourses.length : 0 %></h3>
                <p>Kh√≥a ƒëang h·ªçc</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="icon-box bg-success-subtle text-success"><i class="fas fa-check-circle"></i></div>
            <div>
                <h3><%= completedLessonsCount || 0 %></h3>
                <p>B√†i ho√†n th√†nh</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="icon-box bg-warning-subtle text-warning"><i class="fas fa-bolt"></i></div>
            <div>
                <h3><%= user.points || 0 %></h3>
                <p>ƒêi·ªÉm t√≠ch l≈©y</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="icon-box bg-danger-subtle text-danger"><i class="fas fa-fire"></i></div>
            <div>
                <h3><%= user.streak || 0 %> Ng√†y</h3>
                <p>Chu·ªói li√™n t·ª•c</p>
            </div>
        </div>
    </div>

    <div class="main-layout">
        <div class="layout-left">
            
            <% if (recentCourse) { %>
            <div class="section-block">
                <div class="section-header">
                    <h2><i class="fas fa-play-circle text-primary me-2"></i> Ti·∫øp t·ª•c h·ªçc</h2>
                </div>
                <div class="continue-card">
                    <img src="<%= recentCourse.image || '/img/default-course.png' %>" alt="Course">
                    <div class="continue-info">
                        <h4><%= recentCourse.title %></h4>
                        <div class="progress mt-2" style="height: 6px;">
                            <div class="progress-bar" style="width: <%= recentCourse.progress %>%"></div>
                        </div>
                        <small class="text-muted"><%= recentCourse.progress %>% ho√†n th√†nh</small>
                    </div>
                    <a href="/course/<%= recentCourse._id %>" class="btn btn-primary btn-sm rounded-pill px-4">H·ªçc ngay</a>
                </div>
            </div>
            <% } %>

            <div class="section-block">
                <div class="section-header">
                    <h2><i class="fas fa-chart-line text-success me-2"></i> Ho·∫°t ƒë·ªông tu·∫ßn n√†y</h2>
                </div>
                <div class="chart-wrapper">
                    <canvas id="activityChart"></canvas>
                </div>
            </div>

            <div class="section-block">
                <div class="section-header">
                    <h2><i class="fas fa-graduation-cap text-warning me-2"></i> Kh√≥a h·ªçc c·ªßa t√¥i</h2>
                    <a href="/courses" class="text-primary text-decoration-none small fw-bold">Xem t·∫•t c·∫£</a>
                </div>
                
                <div class="course-list">
                    <% if (enrolledCourses && enrolledCourses.length > 0) { %>
                        <% enrolledCourses.forEach(course => { %>
                        <div class="course-item">
                            <img src="<%= course.image || '/img/default-course.png' %>" class="course-thumb">
                            <div class="course-details">
                                <h5><a href="/course/<%= course._id %>"><%= course.title %></a></h5>
                                <div class="d-flex justify-content-between small text-muted mb-1">
                                    <span><%= course.completedLessons %>/<%= course.totalLessons %> b√†i</span>
                                    <span><%= course.progress %>%</span>
                                </div>
                                <div class="progress" style="height: 5px;">
                                    <div class="progress-bar bg-success" style="width: <%= course.progress %>%"></div>
                                </div>
                            </div>
                        </div>
                        <% }); %>
                    <% } else { %>
                        <div class="text-center py-4 text-muted">
                            <img src="https://cdn-icons-png.flaticon.com/512/7486/7486744.png" width="60" class="mb-3 opacity-50">
                            <p>B·∫°n ch∆∞a ƒëƒÉng k√Ω kh√≥a h·ªçc n√†o.</p>
                            <a href="/courses" class="btn btn-outline-primary btn-sm">Kh√°m ph√° ngay</a>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>

        <div class="layout-right">
            
            <div class="widget-card garden-widget">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="m-0 fw-bold"><i class="fas fa-seedling text-success"></i> Khu v∆∞·ªùn</h5>
                    <a href="/my-garden" class="btn btn-xs btn-light rounded-pill">V√†o v∆∞·ªùn</a>
                </div>
                <div class="text-center">
                    <img src="/img/garden-preview.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/15170/15170366.png'" width="80" class="mb-2">
                    <p class="small text-muted mb-2">ChƒÉm s√≥c c√¢y ƒë·ªÉ nh·∫≠n th√™m XP!</p>
                    <div class="d-flex justify-content-center gap-3">
                        <span class="badge bg-primary-subtle text-primary"><i class="fas fa-tint"></i> <%= gardenData ? (gardenData.water || 0) : 0 %> N∆∞·ªõc</span>
                        <span class="badge bg-warning-subtle text-warning"><i class="fas fa-coins"></i> <%= gardenData ? (gardenData.gold || 0) : 0 %> V√†ng</span>
                    </div>
                </div>
            </div>

            
        </div>
    </div>
</div>

<style>
.achievements-grid-mini .achievement-mini {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 12px;
    text-align: center;
    transition: all 0.2s ease;
    cursor: pointer;
}

.achievements-grid-mini .achievement-mini:hover {
    border-color: #cbd5e1;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    transform: translateY(-2px);
}

.achievement-mini-icon {
    font-size: 2rem;
    margin-bottom: 8px;
}

.achievement-mini-name {
    font-size: 0.8rem;
    font-weight: 600;
    color: #0f172a;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.achievement-mini-date {
    font-size: 0.75rem;
    color: #94a3b8;
    margin-top: 4px;
}
</style>

<script>
async function loadDashboardAchievements() {
    try {
        const response = await fetch('/api/achievements/my-achievements');
        const data = await response.json();
        
        if (data.success) {
            const container = document.getElementById('dashboard-achievements');
            const recent = data.achievements.slice(0, 4); // Show latest 4
            
            if (recent.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; color: #94a3b8; padding: 20px;">
                        <p style="margin: 0;">Ch∆∞a c√≥ th√†nh t√≠ch n√†o. H√£y b·∫Øt ƒë·∫ßu h·ªçc!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = recent.map(a => {
                const achievement = a.achievementId || a.achievement;
                const name = achievement?.name || 'Th√†nh t√≠ch';
                const icon = achievement?.icon || 'üèÜ';
                const description = achievement?.description || 'Th√†nh t√≠ch';
                return `
                    <div class="achievement-mini" title="${description}">
                        <div class="achievement-mini-icon">${icon}</div>
                        <div class="achievement-mini-name">${name}</div>
                        <div class="achievement-mini-date">${new Date(a.unlockedAt).toLocaleDateString('vi-VN')}</div>
                    </div>
                `;
            }).join('');
        }
    } catch (err) {
        console.error('Load achievements error:', err);
    }
}

// Load achievements when dashboard loads
document.addEventListener('DOMContentLoaded', loadDashboardAchievements);
</script>

<script src="/js/dashboard.js"></script>
<%- include('partials/footer') %>