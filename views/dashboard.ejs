<%- include('partials/header') %>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
<link rel="stylesheet" href="/css/styleDashboard.css">

<script>
    // D·ªØ li·ªáu bi·ªÉu ƒë·ªì t·ª´ Server (M·∫£ng 7 s·ªë th·ª±c)
    // N·∫øu m·∫£ng r·ªóng ho·∫∑c to√†n 0, UI s·∫Ω hi·ªÉn th·ªã bi·ªÉu ƒë·ªì ph·∫≥ng (ƒë√∫ng th·ª±c t·∫ø)
    window.WEEKLY_ACTIVITY = <%- weeklyActivity || '[0,0,0,0,0,0,0]' %>;
</script>

<div class="dashboard-wrapper">
    <div class="dashboard-container">
        
        <div class="dash-header animate__animated animate__fadeInDown">
            <div class="user-welcome">
                <div class="avatar-container">
                    <img src="<%= user.avatar || 'https://ui-avatars.com/api/?name=' + user.username + '&background=random' %>" alt="Avatar">
                    <span class="level-badge">LV.<%= user.level || 1 %></span>
                </div>
                <div class="welcome-text">
                    <h1>Ch√†o, <%= user.username %>! <span class="wave">üëã</span></h1>
                    
                    <% 
                        const currentLevel = user.level || 1;
                        const currentXP = user.xp || 0;
                        const nextLevelXP = currentLevel * 1000; 
                        const percentXP = Math.min((currentXP / nextLevelXP) * 100, 100);
                    %>
                    <div class="xp-bar-container" title="<%= currentXP %> / <%= nextLevelXP %> XP">
                        <div class="xp-bar-fill" style="width: <%= percentXP %>%;"></div>
                        <span class="xp-text"><%= currentXP %> / <%= nextLevelXP %> XP</span>
                    </div>
                </div>
            </div>

            <div class="header-stats">
                <div class="h-stat-item">
                    <i class="fas fa-fire text-danger"></i>
                    <div>
                        <span class="stat-val"><%= user.streak || 0 %></span>
                        <span class="stat-lbl">Streak</span>
                    </div>
                </div>
                <div class="h-stat-item">
                    <i class="fas fa-bolt text-warning"></i>
                    <div>
                        <span class="stat-val"><%= user.points || 0 %></span>
                        <span class="stat-lbl">ƒêi·ªÉm</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="dash-grid">
            <div class="dash-main">
                
                <% if (recentCourse) { %>
                    <div class="section-card highlight-card animate__animated animate__fadeInUp">
                        <div class="card-header">
                            <h3><i class="fas fa-history"></i> Ti·∫øp t·ª•c h·ªçc</h3>
                        </div>
                        <div class="recent-course-box">
                            <div class="rc-thumb">
                                <img src="<%= recentCourse.image %>" onerror="this.src='https://i.ibb.co/BVnNtLhp/default-course.png'">
                                <div class="play-overlay"><i class="fas fa-play"></i></div>
                            </div>
                            <div class="rc-info">
                                <h4><%= recentCourse.title %></h4>
                                <div class="progress-wrapper">
                                    <div class="progress-bar" style="width: <%= recentCourse.progress %>%"></div>
                                </div>
                                <div class="rc-meta">
                                    <span>ƒê√£ ho√†n th√†nh <%= recentCourse.progress %>%</span>
                                    <a href="/course/<%= recentCourse._id %>" class="btn-continue">V√†o h·ªçc <i class="fas fa-arrow-right ms-1"></i></a>
                                </div>
                            </div>
                        </div>
                    </div>
                <% } %>

                <div class="section-card animate__animated animate__fadeInUp" style="animation-delay: 0.1s">
                    <div class="card-header">
                        <h3><i class="fas fa-chart-line"></i> Gi·ªù h·ªçc tu·∫ßn n√†y</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="learningChart"></canvas>
                    </div>
                </div>

                <div class="section-card animate__animated animate__fadeInUp" style="animation-delay: 0.2s">
                    <div class="card-header space-between">
                        <h3><i class="fas fa-layer-group"></i> Kh√≥a h·ªçc c·ªßa t√¥i</h3>
                        <% if(enrolledCourses && enrolledCourses.length > 0) { %>
                            <span class="badge-count"><%= enrolledCourses.length %></span>
                        <% } %>
                    </div>
                    
                    <div class="my-courses-list">
                        <% if (enrolledCourses && enrolledCourses.length > 0) { %>
                            <% enrolledCourses.forEach(course => { %>
                                <a href="/course/<%= course._id %>" class="mc-item">
                                    <img src="<%= course.image %>" onerror="this.src='https://i.ibb.co/BVnNtLhp/default-course.png'">
                                    <div class="mc-info">
                                        <h5><%= course.title %></h5>
                                        <div class="mc-progress-mini">
                                            <div class="bar" style="width: <%= course.progress %>%"></div>
                                        </div>
                                        <span class="mc-stat"><%= course.completedLessons %>/<%= course.totalLessons %> b√†i</span>
                                    </div>
                                    <div class="mc-arrow"><i class="fas fa-chevron-right"></i></div>
                                </a>
                            <% }) %>
                        <% } else { %>
                            <div class="text-center py-5">
                                <p class="text-muted mb-3">B·∫°n ch∆∞a tham gia kh√≥a h·ªçc n√†o.</p>
                                <a href="/courses" class="btn-continue">Kh√°m ph√° ngay</a>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>

            <div class="dash-sidebar">
                
                <div class="widget-card garden-widget animate__animated animate__fadeInRight">
                    <div class="widget-header">
                        <h3><i class="fas fa-seedling text-success"></i> N√¥ng tr·∫°i</h3>
                    </div>
                    <div class="garden-minimal">
                        <div class="garden-stats-row">
                            <div class="gs-item">
                                <i class="fas fa-tint text-primary"></i>
                                <span class="gs-value"><%= gardenData ? gardenData.water : 0 %></span>
                                <span class="gs-label">N∆∞·ªõc</span>
                            </div>
                            <div class="gs-divider"></div>
                            <div class="gs-item">
                                <i class="fas fa-coins text-warning"></i>
                                <span class="gs-value"><%= gardenData ? gardenData.gold : 0 %></span>
                                <span class="gs-label">V√†ng</span>
                            </div>
                        </div>
                        <a href="/my-garden" class="btn-garden-go">
                            V√†o chƒÉm s√≥c <i class="fas fa-arrow-right ms-1"></i>
                        </a>
                    </div>
                </div>

                <div class="widget-card animate__animated animate__fadeInRight" style="animation-delay: 0.1s">
                    <div class="widget-header">
                        <h3><i class="fas fa-trophy text-warning"></i> Th√†nh t√≠ch</h3>
                    </div>
                    <div class="achievements-list">
                        <% if (userAchievements && userAchievements.length > 0) { %>
                            <% userAchievements.forEach(ua => { 
                                const ach = ua.achievementId || {}; 
                            %>
                                <div class="ach-row">
                                    <div class="ach-icon"><%= ach.icon || 'üèÜ' %></div>
                                    <div class="ach-details">
                                        <span class="ach-name"><%= ach.name %></span>
                                        <span class="ach-date"><%= new Date(ua.unlockedAt).toLocaleDateString('vi-VN') %></span>
                                    </div>
                                </div>
                            <% }) %>
                        <% } else { %>
                            <div class="text-center py-3 text-muted small">
                                Ch∆∞a c√≥ th√†nh t√≠ch n√†o.
                            </div>
                        <% } %>
                        <a href="/achievements" class="btn-view-all">Xem t·∫•t c·∫£</a>
                    </div>
                </div>

                <div class="widget-card animate__animated animate__fadeInRight" style="animation-delay: 0.2s">
                    <div class="widget-header"><h3>L·ªëi t·∫Øt</h3></div>
                    <div class="shortcuts-grid">
                        <a href="/courses" class="sc-btn"><i class="fas fa-search"></i> Kh√≥a h·ªçc</a>
                        <a href="/leaderboard" class="sc-btn"><i class="fas fa-chart-bar"></i> BXH</a>
                        <a href="/profile/edit" class="sc-btn"><i class="fas fa-user-cog"></i> H·ªì s∆°</a>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<script src="/js/dashboard.js"></script>
<%- include('partials/footer') %>