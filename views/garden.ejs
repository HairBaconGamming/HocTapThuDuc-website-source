<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pixel Farm üöú</title>
    
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <link rel="stylesheet" href="/css/styleGarden.css">
</head>
<body>

    <div id="garden-game-container"></div>

    <div class="pixel-ui">
        
        <div class="hud-top">
            <% 
                let backLink = '/profile';
                if (!isOwner && garden.user) { backLink = '/profile/view/' + garden.user._id; }
            %>
            <a href="<%= backLink %>" class="pixel-btn btn-back" title="Quay l·∫°i">
                <i class="fas fa-arrow-left"></i>
            </a>

            <% if (!isOwner) { %>
                <div class="visitor-badge" style="background: rgba(0,0,0,0.7); color: #fff; padding: 5px 10px; border-radius: 4px; border: 2px solid #ff9800; font-family: 'VT323'; margin-right: 10px;">
                    üëÄ V∆∞·ªùn c·ªßa: <strong style="color: #ffb74d;"><%= garden.user ? garden.user.username : 'H√†ng X√≥m' %></strong>
                </div>
            <% } %>

            <div class="pixel-panel player-stats-compact">
                <div class="stat-level-box">
                    <span class="lbl">LV</span>
                    <span class="val" id="ui-level"><%= garden.userLevel %></span>
                </div>
                
                <div class="stat-info-col">
                    <div class="realm-badge" id="ui-realm"><%= garden.levelName %></div>
                    <div class="xp-progress-wrapper">
                        <% 
                            // [FIX] T√≠nh to√°n EJS an to√†n
                            const curXP = garden.currentXP || 0;
                            const maxXP = garden.nextLevelXP || 100;
                            const xpPct = (maxXP > 0) ? Math.min(100, (curXP / maxXP) * 100) : 0;
                        %>
                        <div class="xp-fill" id="ui-xp-bar" style="width: <%= xpPct %>%;"></div>
                        <span class="xp-text" id="ui-xp-text"><%= curXP %>/<%= maxXP %></span>
                    </div>
                </div>
            </div>

            <div class="pixel-panel resources">
                <div class="res-item" title="N∆∞·ªõc">
                    <img src="https://cdn-icons-png.flaticon.com/512/427/427112.png" class="pixel-icon">
                    <span id="ui-water"><%= garden.water %></span>
                </div>
                <div class="res-item" title="V√†ng">
                    <img src="https://cdn-icons-png.flaticon.com/512/217/217853.png" class="pixel-icon">
                    <span id="ui-gold"><%= garden.gold %></span>
                </div>
            </div>
        </div>

        <div id="plantingModeUI" class="planting-ui" style="display: none;">
            <div class="planting-label">üå± ƒêang tr·ªìng...</div>
            <div class="planting-item-name" id="plantingItemName">H·∫°t Gi·ªëng</div>
            <button class="pixel-btn btn-cancel-plant" onclick="window.cancelPlanting()">
                H·ªßy (X)
            </button>
        </div>

        <div id="mobileMoveBtn" class="mobile-action-btn" onclick="toggleMoveMode()" style="display: none;">
            <i class="fas fa-arrows-alt"></i>
        </div>

        <div id="ui-coords-bar" class="coords-badge">
            üìç <span id="ui-coords-x">0</span>, <span id="ui-coords-y">0</span>
        </div>

        <div class="pixel-panel plant-info-panel" id="plantStats">
            <div class="info-header">
                <div class="info-thumb">
                    <img id="statImg" src="" class="pixel-img">
                </div>
                <div class="info-text">
                    <h3 id="statName">...</h3>
                    <div id="statStageBadge" class="pixel-badge">...</div>
                </div>
                <button class="pixel-btn-close" onclick="hidePlantStats()">X</button>
            </div>
            
            <div class="info-body">
                <div class="stat-row">
                    <label><i class="fas fa-tint text-blue"></i> ƒê·ªô ·∫©m</label>
                    <div class="pixel-progress-track">
                        <div id="statWitherBar" class="pixel-progress-fill fill-water"></div>
                    </div>
                    <span id="statWitherVal" class="stat-val">--%</span>
                </div>

                <div class="stat-row">
                    <label><i class="fas fa-seedling text-green"></i> L·ªõn</label>
                    <div class="pixel-progress-track">
                        <div id="statGrowthBar" class="pixel-progress-fill fill-growth"></div>
                    </div>
                    <span id="statTimeProgress" class="stat-val">--%</span>
                </div>

                <div class="info-grid">
                    <div class="info-cell">
                        <small>‚è≥ C√≤n l·∫°i</small>
                        <strong id="statTotalTime">--</strong>
                    </div>
                    <div class="info-cell">
                        <small>üí∞ Gi√° tr·ªã</small>
                        <strong id="statPrice" class="text-gold">--</strong>
                    </div>
                </div>
                
                <div class="info-footer">
                    <small id="statSoilStatus">---</small>
                </div>
            </div>
        </div>

        <div class="hud-bottom" id="mainToolbar">
            <div class="pixel-panel toolbar">
                <div class="tool-slot" onclick="selectTool('move')" data-tool="move" title="Di chuy·ªÉn">
                    <img src="<%= assets.FARMING.tools.move.icon %>">
                    <span class="key-hint">1</span>
                </div>
                
                <div class="tool-slot active" onclick="selectTool('cursor')" data-tool="cursor" title="Xem info">
                    <img src="<%= assets.FARMING.tools.cursor.icon %>">
                    <span class="key-hint">2</span>
                </div>

                <% if (isOwner) { %>
                    <div class="tool-slot" onclick="selectTool('hoe')" data-tool="hoe" title="Cu·ªëc ƒë·∫•t">
                        <img src="<%= assets.FARMING.tools.hoe.icon %>">
                        <span class="key-hint">3</span>
                    </div>
                    
                    <div class="tool-slot" onclick="selectTool('water')" data-tool="water" title="T∆∞·ªõi n∆∞·ªõc">
                        <img src="<%= assets.FARMING.tools.water.icon %>">
                        <span class="key-hint">4</span>
                    </div>
                    
                    <div class="tool-slot shop-slot" onclick="openShopHTML('plant')" data-tool="shop" title="C·ª≠a h√†ng">
                        <img src="/api/pro-images/1767285084901-romnys.png">
                        <span class="key-hint">F</span>
                    </div>

                    <div class="tool-slot" onclick="selectTool('basket')" data-tool="basket" title="Thu ho·∫°ch">
                        <img src="<%= assets.FARMING.tools.basket.icon %>">
                        <span class="key-hint">5</span>
                    </div>
                    
                    <div class="tool-slot" onclick="selectTool('shovel')" data-tool="shovel" title="X√≥a b·ªè">
                        <img src="<%= assets.FARMING.tools.shovel.icon %>">
                        <span class="key-hint">6</span>
                    </div>
                <% } %>
            </div>
        </div>

    </div>

    <div id="shopOverlay" class="pixel-modal-overlay" style="display:none;" 
        onwheel="event.stopPropagation()" onmousedown="event.stopPropagation()" ontouchstart="event.stopPropagation()">
        
        <div class="pixel-window shop-window">
            <div class="window-header">
                <div class="win-title">üõí T·∫°p H√≥a Th√¥n Qu√™</div>
                <button class="pixel-btn-close red" onclick="closeShop()">X</button>
            </div>
            
            <div class="window-body">
                <div class="shop-list-col">
                    <div class="shop-tabs">
                        <button class="pixel-tab active" onclick="renderShopItems('plant')" id="tab-plant">H·∫°t Gi·ªëng</button>
                        <button class="pixel-tab" onclick="renderShopItems('decor')" id="tab-decor">Trang Tr√≠</button>
                        <button class="pixel-tab" onclick="renderShopItems('plot')" id="tab-plot">ƒê·∫•t ƒêai</button>
                    </div>
                    <div class="shop-grid-container">
                        <div class="shop-grid" id="shopGrid">
                            </div>
                    </div>
                </div>

                <div class="shop-detail-col">
                    
                    <div id="shop-npc-state" class="npc-state">
                        <div class="npc-dialog">
                            "Ch√†o m·ª´ng ƒê·∫°o H·ªØu! <br> H√£y ch·ªçn h·∫°t gi·ªëng ƒë·ªÉ xem chi ti·∫øt nh√©."
                        </div>
                        <img src="/api/pro-images/1767353474437-ddk8r4.png" class="npc-img-lg">
                    </div>

                    <div id="shop-item-state" class="item-detail-state">
                        <div class="detail-header">
                            <img id="d-img" src="" class="detail-img">
                            <h3 id="d-name" class="detail-name">T√™n V·∫≠t Ph·∫©m</h3>
                            <span id="d-type" class="detail-type">LO·∫†I</span>
                        </div>

                        <div class="detail-body-wrapper">
                            <div class="detail-stats">
                                <div class="d-row">
                                    <span class="d-label">Y√™u c·∫ßu:</span>
                                    <span class="d-val" id="d-level">C·∫•p 1</span>
                                </div>
                                <div class="d-row">
                                    <span class="d-label">Th·ªùi gian:</span>
                                    <span class="d-val time" id="d-time">--</span>
                                </div>
                                <div class="d-row">
                                    <span class="d-label">Ph·∫ßn th∆∞·ªüng:</span>
                                    <span class="d-val xp" id="d-xp">-- XP</span>
                                </div>
                                <div class="d-row">
                                    <span class="d-label">Gi√°:</span>
                                    <span class="d-val" id="d-price" style="color: #e65100; font-weight:900;">-- Xu</span>
                                </div>
                            </div>

                            <div class="detail-actions">
                                <button id="btn-confirm-buy" class="btn-buy-action" onclick="confirmBuy()">
                                    MUA & TR·ªíNG
                                </button>
                                <div class="user-balance">
                                    V√≠ c·ªßa b·∫°n: <b style="color:#e65100;"><span id="shop-user-gold">0</span> Xu</b>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script type="application/json" id="gardenAssets"><%- JSON.stringify(assets) %></script>
    <script type="application/json" id="gardenData"><%- JSON.stringify(garden) %></script>
    <script>
        window.isOwner = <%= typeof isOwner !== "undefined" ? isOwner : true %>;
        window.gardenAssets = JSON.parse(document.getElementById('gardenAssets').textContent);
        window.gardenData = JSON.parse(document.getElementById('gardenData').textContent);
        
        // Fallback n·∫øu d·ªØ li·ªáu c≈© ch∆∞a c√≥
        if (!window.gardenData.userLevel) window.gardenData.userLevel = 1;
        if (!window.gardenData.currentXP) window.gardenData.currentXP = 0;
        if (!window.gardenData.nextLevelXP) window.gardenData.nextLevelXP = 100;
        if (!window.gardenData.userLevel) window.gardenData.userLevel = 1;
        if (!window.gardenData.gold) window.gardenData.gold = 0;
    </script>

    <script src="/js/gardenPhaser.js"></script>

    <script>
        // --- UI FUNCTIONS ---
        
        // 1. Toggle Planting Mode UI (ƒê∆∞·ª£c g·ªçi t·ª´ Phaser)
        window.togglePlantingUI = function(active, itemName = '') {
            const ui = document.getElementById('plantingModeUI');
            const toolbar = document.getElementById('mainToolbar');
            
            if (active) {
                ui.style.display = 'flex';
                document.getElementById('plantingItemName').innerText = itemName;
                toolbar.classList.add('disabled-toolbar'); // L√†m m·ªù toolbar
                window.hidePlantStats();
            } else {
                ui.style.display = 'none';
                toolbar.classList.remove('disabled-toolbar');
            }
        }

        // 2. Stats Panel Logic
        let statsInterval = null;
        window.showPlantStats = function(itemData) {
            const panel = document.getElementById('plantStats');
            if (statsInterval) clearInterval(statsInterval);

            // [FIX] X·ª≠ l√Ω tr∆∞·ªùng h·ª£p ƒê·∫•t (kh√¥ng c√≥ trong PLANTS config)
            const isPlot = itemData.type === 'plot';
            const config = isPlot ? null : window.gardenAssets.PLANTS[itemData.itemId];

            // N·∫øu kh√¥ng ph·∫£i ƒë·∫•t v√† kh√¥ng t√¨m th·∫•y config c√¢y -> ·∫®n
            if (!isPlot && !config) { window.hidePlantStats(); return; }

            panel.classList.add('active'); // Hi·ªán b·∫£ng

            const render = () => {
                // ... (Logic render gi·ªØ nguy√™n t·ª´ b·∫£n tr∆∞·ªõc) ...
                if (isPlot) {
                    document.getElementById('statName').innerText = "√î ƒê·∫•t Tr·ªëng";
                    document.getElementById('statImg').src = "/api/pro-images/1767291175911-ytf6vu.png";
                    document.getElementById('statStageBadge').innerText = "S·∫µn s√†ng";
                    document.getElementById('statStageBadge').className = "pixel-badge grey";
                    
                    document.getElementById('statGrowthBar').style.width = "0%";
                    document.getElementById('statWitherBar').style.width = "0%";
                    document.getElementById('statTotalTime').innerText = "---";
                    document.getElementById('statPrice').innerText = "---";
                    document.getElementById('statSoilStatus').innerText = "ƒê·∫•t tr·ªëng";
                } else {
                    document.getElementById('statName').innerText = config.name;
                    document.getElementById('statImg').src = config.stages[itemData.stage || 0];
                    document.getElementById('statPrice').innerText = config.rewardGold.min + "-" + config.rewardGold.max;

                    // T√≠nh to√°n th·ªùi gian
                    const now = Date.now();
                    const lastUpdate = itemData.lastUpdated ? new Date(itemData.lastUpdated).getTime() : new Date(itemData.plantedAt).getTime();
                    const elapsed = now - lastUpdate;

                    // Check ƒë·∫•t ∆∞·ªõt (T√¨m item ƒë·∫•t t∆∞∆°ng ·ª©ng trong data global)
                    let plot = window.gardenData.items.find(i => i.type === 'plot' && i.x === itemData.x && i.y === itemData.y);
                    let isWet = false;
                    if (plot && plot.lastWatered && (now - new Date(plot.lastWatered).getTime() < 24*3600000)) isWet = true;

                    document.getElementById('statSoilStatus').innerText = isWet ? "üíß ƒê·∫•t ·∫©m" : "üåµ ƒê·∫•t kh√¥";
                    document.getElementById('statSoilStatus').style.color = isWet ? "#29b6f6" : "#ef5350";

                    // Growth Progress & Wither logic (gi·ªØ nguy√™n code t√≠nh to√°n)
                    // ... (Code t√≠nh to√°n % nh∆∞ c≈©)
                    const currentProgress = (itemData.growthProgress || 0) + (isWet ? elapsed : 0);
                    const timePerStage = parseDuration(config.growthTime);
                    const maxStage = config.maxStage || 3;
                    const stage = Math.min(Math.floor(currentProgress / timePerStage), maxStage);
                    const pct = Math.min(100, ((currentProgress % timePerStage) / timePerStage) * 100);
                    
                    if (stage >= maxStage) {
                        document.getElementById('statGrowthBar').style.width = "100%";
                        document.getElementById('statTimeProgress').innerText = "MAX";
                        document.getElementById('statStageBadge').innerText = "ƒê√É CH√çN";
                        document.getElementById('statStageBadge').className = "pixel-badge green";
                        document.getElementById('statTotalTime').innerText = "Thu ho·∫°ch!";
                    } else {
                        document.getElementById('statGrowthBar').style.width = pct + "%";
                        document.getElementById('statTimeProgress').innerText = Math.floor(pct) + "%";
                        document.getElementById('statStageBadge').innerText = `C·∫•p ${stage+1}/${maxStage+1}`;
                        document.getElementById('statStageBadge').className = "pixel-badge yellow";
                        const remaining = timePerStage - (currentProgress % timePerStage);
                        document.getElementById('statTotalTime').innerText = formatTime(remaining);
                    }
                    
                    // Wither Bar update...
                    const witherTime = parseDuration(config.witherTime || '30 ph√∫t');
                    let realWither = itemData.witherProgress || 0;
                    if (!isWet) realWither += elapsed; else realWither = Math.max(0, realWither - elapsed);
                    const healthPct = Math.max(0, 100 - (realWither / witherTime * 100));
                    document.getElementById('statWitherBar').style.width = healthPct + "%";
                    document.getElementById('statWitherVal').innerText = Math.floor(healthPct) + "%";
                }
            };
            
            render();
            statsInterval = setInterval(render, 1000);
        };

        window.hidePlantStats = function() {
            if (statsInterval) clearInterval(statsInterval);
            document.getElementById('plantStats').classList.remove('active');
        };

        // 3. Shop UI Logic
        let selectedShopItem = null; // Bi·∫øn l∆∞u item ƒëang ch·ªçn

        // M·ªü Shop (Reset v·ªÅ tab Plant & hi·ªán NPC)
        function openShopHTML(tab = 'plant') {
            document.getElementById('shopOverlay').style.display = 'flex';
            // Reset giao di·ªán ph·∫£i v·ªÅ NPC
            document.getElementById('shop-npc-state').style.display = 'flex';
            document.getElementById('shop-item-state').style.display = 'none';
            selectedShopItem = null;
            
            // C·∫≠p nh·∫≠t s·ªë ti·ªÅn hi·ªán t·∫°i
            document.getElementById('shop-user-gold').innerText = window.gardenData.gold;
            
            renderShopItems(tab);
        }

        function closeShop() { document.getElementById('shopOverlay').style.display = 'none'; }

        function renderShopItems(type) {
            // Active Tab UI
            document.querySelectorAll('.pixel-tab').forEach(t => t.classList.remove('active'));
            const tabBtn = document.getElementById(`tab-${type}`);
            if(tabBtn) tabBtn.classList.add('active');

            const container = document.getElementById('shopGrid');
            container.innerHTML = '';

            let items = [];
            const userLevel = window.gardenData.userLevel || 1;

            // [FIX] Chu·∫©n h√≥a d·ªØ li·ªáu: Map 'price' t·ª´ config sang 'buyPrice' ƒë·ªÉ d√πng chung
            if (type === 'plant') {
                Object.entries(window.gardenAssets.PLANTS || {}).forEach(([key, val]) => {
                    items.push({ 
                        id: key, 
                        ...val, 
                        buyPrice: val.price, // [FIX] √Ånh x·∫° gi√° ƒë√∫ng
                        category: 'plant' 
                    });
                });
            } else if (type === 'decor') {
                Object.entries(window.gardenAssets.DECORS || {}).forEach(([key, val]) => {
                    items.push({ 
                        id: key, 
                        ...val, 
                        buyPrice: val.price, // [FIX] √Ånh x·∫° gi√° ƒë√∫ng
                        category: 'decor' 
                    });
                });
            } else if (type === 'plot') {
                // [UPDATE] ƒê·∫•t ƒëai ƒë·ªÉ tr·ªëng theo y√™u c·∫ßu
                items = []; 
            }

            if (items.length === 0) {
                container.innerHTML = '<div style="padding:40px; text-align:center; width:100%; color:#8d6e63; font-style:italic;">(Tr·ªëng tr∆°n...)</div>';
                return;
            }

            // Render t·ª´ng th·∫ª
            items.forEach(item => {
                const reqLevel = item.unlockLevel || 1;
                const isLocked = userLevel < reqLevel;
                
                // L·∫•y icon
                let icon = item.icon;
                if (!icon && item.stages) icon = item.stages[item.stages.length-1]; // ·∫¢nh c√¢y ch√≠n
                if (!icon && item.image) icon = item.image; // ·∫¢nh decor
                
                const card = document.createElement('div');
                card.className = `shop-card ${isLocked ? 'locked' : ''}`;
                card.onclick = () => selectShopItem(item, isLocked);

                // [FIX] Hi·ªÉn th·ªã gi√°: D√πng item.buyPrice ƒë√£ map ·ªü tr√™n
                const displayPrice = item.buyPrice !== undefined ? item.buyPrice : '??';

                let lockHtml = isLocked ? `
                    <div class="lock-overlay"><i class="fas fa-lock"></i></div>
                    <div class="req-level">Lv ${reqLevel}</div>
                ` : '';

                card.innerHTML = `
                    ${lockHtml}
                    <img src="${icon}">
                    <div class="name">${item.name}</div>
                    <div class="price">üí∞ ${displayPrice}</div>
                `;
                container.appendChild(card);
            });
        }

        // X·ª≠ l√Ω khi ch·ªçn Item
        function selectShopItem(item, isLocked) {
            selectedShopItem = item;

            // Highlight
            document.querySelectorAll('.shop-card').forEach(c => c.classList.remove('selected'));
            event.currentTarget.classList.add('selected');

            // Chuy·ªÉn view
            document.getElementById('shop-npc-state').style.display = 'none';
            document.getElementById('shop-item-state').style.display = 'flex';

            // Fill Info
            let icon = item.icon || (item.stages ? item.stages[item.stages.length-1] : item.image);
            document.getElementById('d-img').src = icon;
            document.getElementById('d-name').innerText = item.name;
            document.getElementById('d-type').innerText = item.category === 'plant' ? 'H·∫°t Gi·ªëng' : 'Trang Tr√≠';
            
            // Level Requirement
            const lvEl = document.getElementById('d-level');
            lvEl.innerText = "C·∫•p " + (item.unlockLevel || 1);
            lvEl.style.color = isLocked ? "#ef5350" : "#33691e";
            if(isLocked) lvEl.innerHTML += ' <i class="fas fa-exclamation-circle"></i>';

            // Stats
            if (item.category === 'plant') {
                document.getElementById('d-time').innerText = item.growthTime || 'Unknown';
                document.getElementById('d-xp').innerText = (item.rewardXP || 0) + ' XP';
            } else {
                document.getElementById('d-time').innerText = 'Vƒ©nh vi·ªÖn';
                document.getElementById('d-xp').innerText = 'Trang tr√≠';
            }

            // [FIX] Gi√° ti·ªÅn
            const price = item.buyPrice !== undefined ? item.buyPrice : 0;
            document.getElementById('d-price').innerText = price + " Xu";

            // Button Logic
            const btn = document.getElementById('btn-confirm-buy');
            const userGold = window.gardenData.gold || 0;

            if (isLocked) {
                btn.disabled = true;
                btn.innerText = `C·∫¶N LEVEL ${item.unlockLevel || 1}`;
                btn.style.background = "#9e9e9e";
                btn.style.borderColor = "#616161";
            } else if (userGold < price) {
                btn.disabled = true;
                btn.innerText = "KH√îNG ƒê·ª¶ TI·ªÄN";
                btn.style.background = "#ef5350"; // ƒê·ªè
                btn.style.borderColor = "#b71c1c";
            } else {
                btn.disabled = false;
                btn.innerText = "MUA & TR·ªíNG";
                btn.style.background = "var(--accent-green)";
                btn.style.borderColor = "#2e7d32";
            }
        }

        // X·ª≠ l√Ω Mua th·∫≠t
        function confirmBuy() {
            if (!selectedShopItem) return;
            
            // G·ªçi h√†m c≈© ƒë·ªÉ emit event xu·ªëng Phaser
            // L∆∞u √Ω: H√†m buyItem c≈© trong garden.ejs c·∫ßn s·ª≠a l·∫°i ch√∫t ƒë·ªÉ kh√¥ng nh·∫≠n tham s·ªë click n·ªØa m√† l·∫•y t·ª´ selected
            if(window.gameEvents) {
                window.gameEvents.emit('buyItem', { id: selectedShopItem.id, type: selectedShopItem.category });
                closeShop();
            }
        }

        document.addEventListener('keydown', (e) => {
            if (['INPUT', 'TEXTAREA'].includes(e.target.tagName)) return;
            const key = e.key.toLowerCase();
            const isOwner = window.isOwner;

            // X to cancel planting
            if (key === 'x') { window.cancelPlanting(); return; }
            
            // ESC to close UI
            if (key === 'escape') { closeShop(); hidePlantStats(); window.cancelPlanting(); return; }

            // Tools
            switch(key) {
                case '1': selectTool('move'); break;
                case '2': selectTool('cursor'); break;
                case '3': if(isOwner) selectTool('hoe'); break;
                case '4': if(isOwner) selectTool('water'); break;
                case '5': if(isOwner) selectTool('basket'); break;
                case '6': if(isOwner) selectTool('shovel'); break;
                case 'f': if(isOwner) { 
                    if(document.getElementById('shopOverlay').style.display === 'flex') closeShop(); 
                    else openShopHTML('plant'); 
                } break;
            }
        });

        // Emit s·ª± ki·ªán ch·ªçn tool xu·ªëng Phaser
        window.selectTool = function(toolName) {
            // N·∫øu toolbar b·ªã disable (ƒëang tr·ªìng c√¢y), kh√¥ng cho b·∫•m
            if(document.getElementById('mainToolbar').classList.contains('disabled-toolbar')) return;
            
            if(window.gameEvents) window.gameEvents.emit('toolChanged', toolName);
            
            document.querySelectorAll('.tool-slot').forEach(el => el.classList.remove('active'));
            const activeEl = document.querySelector(`.tool-slot[data-tool="${toolName}"]`);
            if(activeEl) activeEl.classList.add('active');
        };

        // Toggle Move Mode from UI
        window.toggleMoveMode = function() {
            const btn = document.getElementById('mobileMoveBtn');
            btn.classList.toggle('active');
            window.gameEvents.emit('toggleMoveMode');
        }

        // Callback t·ª´ Phaser ƒë·ªÉ hi·ªán/·∫©n n√∫t
        window.updateMobileMoveBtn = function(show) {
            const btn = document.getElementById('mobileMoveBtn');
            if (btn) btn.style.display = show ? 'flex' : 'none';
            if (!show) btn.classList.remove('active'); // Reset state
        }

        // Helpers
        function formatTime(ms) { return ms <= 0 ? "00:00" : new Date(ms).toISOString().substr(14, 5); }
        function parseDuration(str) { const num = parseInt(str); return num * (str.includes('gi·ªù') ? 3600000 : 60000); }

        const PING_INTERVAL = 10 * 60 * 1000; // 10 ph√∫t

        setInterval(() => {
            fetch('/api/ping')
                .then(res => {
                    // console.log('Keep-alive ping:', res.status); // B·∫≠t n·∫øu mu·ªën debug
                })
                .catch(err => {
                    console.warn('Keep-alive failed:', err);
                });
        }, PING_INTERVAL);
    </script>

    <link rel="stylesheet" href="/css/styleTutorial.css">
    <script src="/js/tutorial.js"></script>
</body>
</html>