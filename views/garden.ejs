<%- include('partials/header') %>

<link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>

<style>
    /* Wrapper bao ngo√†i ƒë·ªÉ cƒÉn gi·ªØa khung game */
    .game-stage-container {
        width: 100vw;
        height: calc(100vh - 70px); /* Tr·ª´ header */
        background-color: #111; /* M√†u n·ªÅn t·ªëi cho ph·∫ßn th·ª´a */
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
    }

    /* --- KHUNG GAME CH√çNH (H√åNH VU√îNG) --- */
    .garden-wrapper {
        position: relative;
        /* Thi·∫øt l·∫≠p t·ªâ l·ªá 1:1 (H√¨nh vu√¥ng) */
        aspect-ratio: 1 / 1;
        
        /* Logic t·ª± co gi√£n: 
           - M·∫∑c ƒë·ªãnh cao b·∫±ng m√†n h√¨nh
           - Nh∆∞ng kh√¥ng ƒë∆∞·ª£c r·ªông qu√° m√†n h√¨nh 
        */
        height: 95%; 
        max-width: 95%;
        
        background: #1e3323; /* M√†u n·ªÅn load game */
        overflow: hidden; 
        font-family: 'VT323', monospace;
        user-select: none;
        
        /* Trang tr√≠ khung vi·ªÅn */
        border: 4px solid #5d4037;
        border-radius: 12px;
        box-shadow: 0 0 50px rgba(0,0,0,0.8);
    }

    #game-container {
        width: 100%;
        height: 100%;
        display: block;
        cursor: grab;
        border-radius: 8px; /* Bo g√≥c canvas */
        overflow: hidden;
    }
    #game-container:active { cursor: grabbing; }

    /* --- 1. HUD (G√≥c Tr√°i Tr√™n) --- */
    .garden-hud {
        position: absolute; top: 15px; left: 15px; z-index: 10;
        display: flex; flex-direction: column; gap: 8px; pointer-events: none;
    }
    .hud-stat {
        display: flex; align-items: center;
        background: rgba(0, 0, 0, 0.7);
        border: 2px solid #5d4037;
        border-radius: 8px; padding: 4px 12px; color: #fff;
        backdrop-filter: blur(4px);
    }
    .hud-icon { font-size: 1.4rem; margin-right: 8px; }
    .hud-value { font-size: 1.6rem; font-weight: bold; color: #ffeb3b; text-shadow: 2px 2px 0 #000; }

    /* --- 2. STATS PANEL (B√™n Ph·∫£i) --- */
    .plant-stats-panel {
        position: absolute; top: 15px; right: -320px;
        width: 260px; /* Thu nh·ªè ch√∫t cho g·ªçn trong h√¨nh vu√¥ng */
        background: rgba(33, 33, 33, 0.95);
        border: 3px solid #ffb300; border-radius: 12px; padding: 15px;
        color: white; transition: right 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: -5px 5px 20px rgba(0,0,0,0.5); z-index: 1000;
        display: flex; flex-direction: column; gap: 10px;
    }
    .plant-stats-panel.active { right: 15px; }

    .stats-header { display: flex; align-items: center; border-bottom: 2px dashed #555; padding-bottom: 10px; }
    .stats-img-box { width: 60px; height: 60px; background: #4a3b32; border: 2px solid #8d6e63; border-radius: 8px; display: flex; justify-content: center; align-items: center; margin-right: 10px; }
    .stats-img { width: 40px; height: 40px; object-fit: contain; image-rendering: pixelated; }
    .stats-info h3 { margin: 0; color: #ffb300; font-size: 1.6rem; line-height: 1; text-transform: uppercase; }
    .stats-info p { margin: 2px 0 0; color: #aaa; font-size: 1rem; }

    .stats-row { margin-bottom: 2px; }
    .bar-label { display: flex; justify-content: space-between; font-size: 1rem; margin-bottom: 2px; }
    .progress-track { width: 100%; height: 10px; background: #333; border-radius: 5px; overflow: hidden; border: 1px solid #555; }
    .progress-fill { height: 100%; transition: width 0.5s ease-out; }
    .fill-water { background: linear-gradient(90deg, #0288d1, #29b6f6); }
    .fill-growth { background: linear-gradient(90deg, #388e3c, #66bb6a); }
    .stats-footer { text-align: center; background: rgba(255, 255, 255, 0.1); padding: 8px; border-radius: 6px; font-size: 1.1rem; color: #ffca28; margin-top: 5px; }

    /* --- 3. TOOLBAR (Thanh C√¥ng C·ª• D∆∞·ªõi) --- */
    .garden-toolbar {
        position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%);
        background: rgba(45, 27, 14, 0.95);
        border: 3px solid #5d4037; border-radius: 14px; padding: 6px;
        display: flex; gap: 8px;
        box-shadow: 0 10px 20px rgba(0,0,0,0.6); z-index: 1000;
    }
    .tool-slot {
        width: 54px; height: 54px; /* Nh·ªè h∆°n ch√∫t */
        background: #8d6e63; border: 2px solid #5d4037; border-radius: 8px;
        cursor: pointer; display: flex; justify-content: center; align-items: center;
        position: relative; transition: all 0.1s;
    }
    .tool-slot img { width: 50px; height: 50px; filter: drop-shadow(2px 2px 0 rgba(0,0,0,0.3)); image-rendering: pixelated; }
    .tool-slot:hover { background: #a1887f; transform: translateY(-3px); }
    .tool-slot.active {
        background: #ffecb3; border-color: #ffb300;
        box-shadow: inset 0 0 10px #ffb300; transform: translateY(-5px); z-index: 10;
    }
    .key-hint { position: absolute; top: 1px; left: 3px; font-size: 0.9rem; color: #fff; opacity: 0.8; font-weight: bold; }

    /* --- 4. SHOP MODAL --- */
    .garden-modal-overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); z-index: 2000;
        display: none; align-items: center; justify-content: center; backdrop-filter: blur(3px);
        border-radius: 12px; /* Bo g√≥c theo wrapper */
    }
    .rpg-shop-window {
        width: 90%; height: 85%;
        background: #e3d5ca; border: 4px solid #3e2723; border-radius: 4px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        display: flex; flex-direction: column; position: relative; font-family: 'VT323', monospace;
    }
    .shop-title-bar { background: #3e2723; color: #ffb300; padding: 10px; font-size: 2rem; text-align: center; border-bottom: 4px solid #1a1a1a; position: relative; }
    .btn-close-shop { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: #d32f2f; color: white; border: 2px solid #fff; width: 30px; height: 30px; cursor: pointer; font-size: 1.2rem; }
    .shop-content { flex: 1; display: flex; overflow: hidden; }
    .shop-tabs { width: 140px; background: #5d4037; border-right: 4px solid #3e2723; display: flex; flex-direction: column; }
    .tab-rpg { padding: 15px; font-size: 1.3rem; color: #bbb; cursor: pointer; border-bottom: 2px solid #3e2723; transition: 0.2s; text-align: center; }
    .tab-rpg:hover { background: #4e342e; color: #fff; }
    .tab-rpg.active { background: #e3d5ca; color: #3e2723; font-weight: bold; border-right: none; margin-right: -4px; position: relative; z-index: 2;}
    .shop-grid { flex: 1; padding: 15px; display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 10px; overflow-y: auto; background: #d7ccc8; scrollbar-width: thin; scrollbar-color: #5d4037 #d7ccc8; }
    .item-card { background: #fff; border: 2px solid #8d6e63; padding: 8px; text-align: center; cursor: pointer; transition: 0.1s; border-radius: 6px; }
    .item-card:hover { transform: scale(1.05); border-color: #ffb300; background: #fff8e1; }
    .item-card img { width: 48px; height: 48px; object-fit: contain; margin-bottom: 5px; }
    .item-name { font-size: 1.2rem; color: #3e2723; line-height: 1; margin-bottom: 2px; }
    .item-price { font-size: 1.1rem; color: #d84315; font-weight: bold; }

    /* RESPONSIVE */
    @media (max-width: 600px) {
        .shop-content { flex-direction: column; }
        .shop-tabs { width: 100%; flex-direction: row; height: 50px; border-right: none; border-bottom: 4px solid #3e2723; }
        .tab-rpg { flex: 1; padding: 10px; font-size: 1.1rem; border-bottom: none; border-right: 2px solid #3e2723; }
    }
</style>

<div class="game-stage-container">
    <div class="garden-wrapper">
        
        <% if (!isOwner) { %>
            <div style="position: absolute; top: 80px; left: 50%; transform: translateX(-50%);
                        background: rgba(0,0,0,0.8); color: #fff; padding: 10px 20px;
                        border-radius: 20px; border: 2px solid #ff9800; z-index: 2000; font-family: 'VT323'; font-size: 1.5rem; text-align: center;">
                üëÄ ƒêang h√≥ng h·ªõt v∆∞·ªùn c·ªßa <strong><%= ownerName || 'H√†ng X√≥m' %></strong>
                <br>
                <a href="/my-garden" style="color: #ffeb3b; font-size: 1.2rem; text-decoration: none;">[V·ªÅ nh√† m√¨nh]</a>
                <span style="margin: 0 10px;">|</span>
                <a href="/profile/view/<%= garden.user._id %>" style="color: #4fc3f7; font-size: 1.2rem; text-decoration: none;">[Xem Profile]</a>
            </div>
        <% } %>

        <div class="garden-hud">
            <div class="hud-stat" title="N∆∞·ªõc">
                <div class="hud-icon">üíß</div>
                <div class="hud-value" id="hudWater"><%= garden.water %></div>
            </div>
            <div class="hud-stat" title="V√†ng">
                <div class="hud-icon">üí∞</div>
                <div class="hud-value" id="hudGold"><%= garden.gold %></div>
            </div>

            <div class="hud-stat" title="V·ªã tr√≠ hi·ªán t·∫°i">
                <div class="hud-icon" style="font-size: 1.2rem;">üìç</div>
                <div class="hud-value" id="hudCoords" style="font-size: 1.5rem; min-width: 60px;">0, 0</div>
            </div>
        </div>

        <div id="game-container"></div>

        <div class="plant-stats-panel" id="plantStats">
            <div class="stats-header">
                <div class="stats-img-box">
                    <img id="statImg" src="" class="stats-img">
                </div>
                <div class="stats-info">
                    <h3 id="statName">Unknown</h3>
                    <p id="statType">C√¢y Tr·ªìng</p>
                    <p id="statCoords" style="color:#4caf50; font-size: 1rem;">Pos: (0, 0)</p>
                </div>
            </div>
            
            <div style="background: rgba(255,255,255,0.05); padding: 8px; border-radius: 6px; margin-bottom: 10px;">
                <div class="bar-label"><span>Tr·∫°ng th√°i ƒë·∫•t:</span> <span id="statSoilStatus" style="color:#4fc3f7">ƒê·∫•t Kh√¥</span></div>
                <div class="bar-label" id="soilTimerRow" style="display:none; margin-top:4px;">
                    <span>H·∫øt ·∫©m trong:</span> <span id="statSoilTimer" style="color:#4fc3f7; font-weight:bold;">00:00:00</span>
                </div>
                <div class="bar-label" id="speedRow"><span>T·ªëc ƒë·ªô l·ªõn:</span> <span id="statSpeed" style="color:#ffb300">100%</span></div>
            </div>

            <div id="plantInfoSection">
                    <div class="stats-row">
                        <div class="bar-label"><span>S·ª©c kh·ªèe (N∆∞·ªõc)</span><span id="statWitherVal">100%</span></div>
                        <div class="progress-track"><div id="statWitherBar" class="progress-fill" style="width: 100%; background: #ef5350;"></div></div>
                    </div>

                    <div class="stats-row">
                        <div class="bar-label">
                            <span>Ph√°t tri·ªÉn</span>
                            <span id="statStageVal">C·∫•p 0</span>
                        </div>
                        <div class="progress-track">
                            <div id="statGrowthBar" class="progress-fill fill-growth" style="width: 0%"></div>
                        </div>
                        <div style="font-size: 0.9rem; color: #ccc; margin-top: 2px;" id="statTimeProgress">-- / --</div>
                    </div>

                    <div class="stats-row" style="background: rgba(0,0,0,0.2); padding: 5px; border-radius: 4px; margin-top: 5px;">
                        <div style="font-size: 1rem; color: #ccc; display: flex; justify-content: space-between;">
                            <span>‚è± M·ªói c·∫•p:</span>
                            <span id="statTimePerStage" style="color: #fff;">--</span>
                        </div>
                        <div style="font-size: 1rem; color: #ccc; display: flex; justify-content: space-between;">
                            <span>‚è≥ T·ªïng c·ªông:</span>
                            <span id="statTotalTime" style="color: #ffca28;">--</span>
                        </div>
                    </div>

                    <div class="stats-footer">
                        ∆Ø·ªõc t√≠nh thu ho·∫°ch: <span id="statPrice" style="color: #fff; font-weight: bold;">---</span> üí∞
                    </div>
            </div>
        </div>
        <% if (isOwner) { %>
        <div class="garden-toolbar farm-tools">
            <div class="tool-slot active" onclick="selectTool('cursor')" title="Tay (Di chuy·ªÉn/Xem)">
                <div class="key-hint">1</div>
                <img src="<%= assets.FARMING.tools.cursor.icon %>">
            </div>
            <div class="tool-slot" onclick="selectTool('hoe')" title="Cu·ªëc ƒê·∫•t">
                <div class="key-hint">2</div>
                <img src="<%= assets.FARMING.tools.hoe.icon %>">
            </div>
            <div class="tool-slot" onclick="openShopHTML('plants')" title="C·ª≠a H√†ng">
                <div class="key-hint">3</div>
                <img src="/api/pro-images/1767285084901-romnys.png">
            </div>
            <div class="tool-slot" onclick="selectTool('water')" title="T∆∞·ªõi N∆∞·ªõc">
                <div class="key-hint">4</div>
                <img src="<%= assets.FARMING.tools.water.icon %>">
            </div>
            <div class="tool-slot" onclick="selectTool('basket')" title="Thu Ho·∫°ch">
                <div class="key-hint">5</div>
                <img src="<%= assets.FARMING.tools.basket.icon %>">
            </div>
            <div class="tool-slot" onclick="selectTool('shovel')" title="D·ªçn D·∫πp">
                <div class="key-hint">6</div>
                <img src="<%= assets.FARMING.tools.shovel.icon %>">
            </div>
        </div>
        <% } %>

        <div class="garden-modal-overlay" id="shopOverlay">
            <div class="rpg-shop-window">
                <div class="shop-title-bar">
                    C·ª≠a H√†ng N√¥ng D√¢n
                    <button class="btn-close-shop" onclick="closeShop()">X</button>
                </div>
                <div class="shop-content">
                    <div class="shop-tabs">
                        <div class="tab-rpg active" onclick="switchShopTab('plants')">H·∫°t Gi·ªëng</div>
                        <div class="tab-rpg" onclick="switchShopTab('decors')">Trang Tr√≠</div>
                        <div class="tab-rpg" onclick="switchShopTab('backgrounds')">M·ªü R·ªông</div>
                    </div>
                    <div class="shop-grid" id="shopGrid"></div>
                </div>
            </div>
        </div>

    </div>
</div>

<div id="tutorialOverlay" class="tutorial-wrapper" style="display: none;">
    <div class="mascot-container">
        <img src="/api/pro-images/1767292174351-vww00c.png" class="mascot-img">
    </div>
    <div class="dialog-box">
        <h3 id="tutTitle">H·∫ø l√¥ "n√¥ng d√¢n" t·∫≠p s·ª±! üå±</h3>
        <p id="tutContent">M·ªõi nh·∫≠p m√¥n h·∫£? ƒê·ª´ng lo, c√≥ tui b·∫£o k√™! ƒêi theo tui nha fen!</p>
        <button id="tutNextBtn" class="btn-genz" onclick="nextTutorial()">Oki lun! üöÄ</button>
    </div>
    <div id="tutPointer" class="hand-pointer">üëá</div>
</div>

<script type="application/json" id="gardenAssets"><%- JSON.stringify(assets) %></script>
<script type="application/json" id="gardenData"><%- JSON.stringify(garden) %></script>

<script>
    /* eslint-disable */
    // @ts-nocheck
    // Inject d·ªØ li·ªáu
    window.gardenAssets = JSON.parse(document.getElementById('gardenAssets').textContent);
    window.gardenData = JSON.parse(document.getElementById('gardenData').textContent);

    // Bi·∫øn l∆∞u b·ªô ƒë·∫øm th·ªùi gian
    let statsInterval = null;

    // --- H√ÄM HELPER X·ª¨ L√ù TH·ªúI GIAN ---
    function formatTime(ms) {
        if (ms <= 0) return "00:00";
        const s = Math.floor(ms / 1000);
        const m = Math.floor(s / 60);
        const sec = s % 60;
        return m.toString().padStart(2,'0') + ":" + sec.toString().padStart(2,'0');
    }

    // Th√™m helper format ra HH:MM:SS
    function formatTimeHMS(ms) {
        if (ms <= 0) return "00:00:00";
        const s = Math.floor(ms / 1000);
        const h = Math.floor(s / 3600);
        const m = Math.floor((s % 3600) / 60);
        const sec = s % 60;
        return h + ":" + m.toString().padStart(2,'0') + ":" + sec.toString().padStart(2,'0');
    }

    function parseDuration(str) {
        if (!str) return 5 * 60000;
        const num = parseInt(str);
        if (str.includes('gi·ªù')) return num * 3600000;
        return num * 60000; // M·∫∑c ƒë·ªãnh l√† ph√∫t
    }

    // --- LOGIC HI·ªÇN TH·ªä STATS (AUTO UPDATE) ---
    window.showPlantStats = function(itemData, coords) {
        const panel = document.getElementById('plantStats');
        const plantInfoSection = document.getElementById('plantInfoSection');
        const soilTimerRow = document.getElementById('soilTimerRow');
        const speedRow = document.getElementById('speedRow');

        // X√≥a b·ªô ƒë·∫øm c≈© n·∫øu ƒëang ch·∫°y
        if (statsInterval) clearInterval(statsInterval);

        // Ki·ªÉm tra lo·∫°i item
        const isPlot = itemData.type === 'plot';
        const config = isPlot ? null : window.gardenAssets.PLANTS[itemData.itemId];

        // N·∫øu kh√¥ng ph·∫£i c√¢y ho·∫∑c ƒë·∫•t th√¨ ƒë√≥ng b·∫£ng
        if (!isPlot && !config) {
            window.hidePlantStats();
            return;
        }

        // H√†m render (ch·∫°y m·ªói gi√¢y)
        const render = () => {
            // 1. Th√¥ng tin c∆° b·∫£n
            if (isPlot) {
                document.getElementById('statName').innerText = "√î ƒê·∫•t";
                document.getElementById('statImg').src = "/api/pro-images/1767291175911-ytf6vu.png"; // Kh√¥ng c√≥ h√¨nh cho ƒë·∫•t
                document.getElementById('statType').innerText = "ƒê·∫•t Tr·ªëng";
                plantInfoSection.style.display = 'none'; // ·∫®n ph·∫ßn th√¥ng tin c√¢y
            } else {
                document.getElementById('statName').innerText = config.name;
                document.getElementById('statImg').src = config.stages[itemData.stage || 0];
                document.getElementById('statType').innerText = "C√¢y Tr·ªìng";
                plantInfoSection.style.display = 'block'; // Hi·ªÉn th·ªã ph·∫ßn th√¥ng tin c√¢y
            }
            if (coords) document.getElementById('statCoords').innerText = "Pos: (" + coords.x + ", " + coords.y + ")";

            // 2. Ki·ªÉm tra m√¥i tr∆∞·ªùng (ƒê·∫•t ·∫©m hay kh√¥)
            let plot = itemData;
            if (!isPlot) {
                // T√¨m √¥ ƒë·∫•t t·∫°i v·ªã tr√≠ c√¢y
                plot = window.gardenData.items.find(i => i.type === 'plot' && i.x === itemData.x && i.y === itemData.y);
            }

            let isWet = false;
            let remainingWetTime = 0;
            if (plot && plot.lastWatered) {
                const waterTime = new Date(plot.lastWatered).getTime();
                const now = Date.now();
                const elapsed = now - waterTime;
                const maxWetTime = 24 * 60 * 60 * 1000; // 24 gi·ªù
                if (elapsed < maxWetTime) {
                    isWet = true;
                    remainingWetTime = maxWetTime - elapsed;
                }
            }

            document.getElementById('statSoilStatus').innerText = isWet ? "ƒê·∫•t ·∫®m (T·ªët)" : "ƒê·∫•t Kh√¥";
            document.getElementById('statSoilStatus').style.color = isWet ? "#4fc3f7" : "#aaa";

            // Hi·ªÉn th·ªã timer n·∫øu ƒë·∫•t ·∫©m
            if (isWet) {
                soilTimerRow.style.display = 'block';
                document.getElementById('statSoilTimer').innerText = formatTimeHMS(remainingWetTime);
            } else {
                soilTimerRow.style.display = 'none';
            }

            // Hi·ªÉn th·ªã t·ªëc ƒë·ªô l·ªõn ch·ªâ khi c√≥ c√¢y
            if (isPlot) {
                speedRow.style.display = 'none';
            } else {
                speedRow.style.display = 'block';
                const speed = 1;
                document.getElementById('statSpeed').innerText = (speed * 100) + "%";
            }

            // 3. N·∫øu l√† c√¢y, t√≠nh to√°n ti·∫øn ƒë·ªô
            if (!isPlot) {
                // T√≠nh to√°n Ti·∫øn ƒë·ªô (Real-time Simulation)
                const now = Date.now();
                const lastUpdate = itemData.lastUpdated ? new Date(itemData.lastUpdated).getTime() : new Date(itemData.plantedAt).getTime();
                const elapsed = now - lastUpdate;

                const speed = 1;
                const currentProgress = (itemData.growthProgress || 0) + (elapsed * speed);
                const timePerStage = parseDuration(config.growthTime);

                const msInCurrent = currentProgress % timePerStage;
                const msRemaining = Math.max(0, (timePerStage - msInCurrent) / speed);

                const pct = Math.min(100, (msInCurrent / timePerStage) * 100);
                document.getElementById('statGrowthBar').style.width = pct + "%";
                document.getElementById('statTimeProgress').innerText = formatTime(msInCurrent) + " / " + formatTime(timePerStage);

                const maxStage = config.maxStage || 3;
                const virtualStage = Math.min(Math.floor(currentProgress / timePerStage), maxStage);

                if (virtualStage >= maxStage) {
                    document.getElementById('statStageVal').innerText = "ƒê√£ Ch√≠n! (Thu ho·∫°ch ngay)";
                    document.getElementById('statStageVal').style.color = "#4caf50";
                    document.getElementById('statTotalTime').innerText = "S·∫µn s√†ng";
                    document.getElementById('statGrowthBar').style.width = "100%";
                } else {
                    document.getElementById('statStageVal').innerText = "Giai ƒëo·∫°n " + (virtualStage + 1) + " / " + (maxStage + 1);
                    document.getElementById('statStageVal').style.color = "#fff";

                    const totalNeeded = timePerStage * maxStage;
                    const totalRemaining = Math.max(0, (totalNeeded - currentProgress) / speed);
                    document.getElementById('statTotalTime').innerText = "~" + formatTime(totalRemaining);
                }

                document.getElementById('statPrice').innerText = config.rewardGold.min + "-" + config.rewardGold.max;

                // T√≠nh to√°n Wither
                const witherTime = parseDuration(config.witherTime || '30 ph√∫t');
                const currentWither = itemData.witherProgress || 0;

                if (itemData.isDead) {
                    document.getElementById('statWitherBar').style.width = "0%";
                    document.getElementById('statWitherVal').innerText = "ƒê√£ Ch·∫øt üíÄ";
                    document.getElementById('statWitherVal').style.color = "red";
                    document.getElementById('statStageVal').innerText = "C·∫ßn d·ªçn d·∫πp";
                } else {
                    const healthPct = Math.max(0, 100 - (currentWither / witherTime * 100));
                    document.getElementById('statWitherBar').style.width = healthPct + "%";
                    document.getElementById('statWitherVal').innerText = Math.floor(healthPct) + "%";
                    document.getElementById('statWitherVal').style.color = "white";
                }
            }
        };

        // Ch·∫°y ngay l·∫≠p t·ª©c
        render();

        // C·∫≠p nh·∫≠t m·ªói gi√¢y
        statsInterval = setInterval(render, 1000);

        panel.classList.add('active');
    };

    window.hidePlantStats = function() {
        if (statsInterval) clearInterval(statsInterval); // D·ª´ng b·ªô ƒë·∫øm
        document.getElementById('plantStats').classList.remove('active');
    };

    // --- C√ÅC H√ÄM KH√ÅC GI·ªÆ NGUY√äN ---
    function selectTool(toolName) {
        console.log("Ch·ªçn c√¥ng c·ª•:", toolName);
        if(window.gameEvents) window.gameEvents.emit('toolChanged', toolName);
        document.querySelectorAll('.tool-slot').forEach(el => el.classList.remove('active'));
        const slots = document.querySelectorAll('.tool-slot');
        slots.forEach(s => {
            if(s.getAttribute('onclick').includes(`'${toolName}'`)) s.classList.add('active');
        });
    }

    document.addEventListener('keydown', (e) => {
        if(e.target.tagName === 'INPUT') return;
        if(e.key === '1') selectTool('cursor');
        if(e.key === '2') selectTool('hoe');
        if(e.key === '3') openShopHTML('plants');
        if(e.key === '4') selectTool('water');
        if(e.key === '5') selectTool('basket');
        if(e.key === '6') selectTool('shovel');
    });

    function closeShop() { document.getElementById('shopOverlay').style.display = 'none'; }
</script>

<script>
    /* eslint-disable */
    // @ts-nocheck
    // Inject d·ªØ li·ªáu (already parsed above)

    // --- SCRIPT H∆Ø·ªöNG D·∫™N (UPDATED) ---

    // [M·ªöI] Nh·∫≠n bi·∫øn isOwner t·ª´ Server (M·∫∑c ƒë·ªãnh true n·∫øu kh√¥ng c√≥)
    /* eslint-disable */
    window.isOwner = JSON.parse('<%= JSON.stringify(typeof isOwner !== "undefined" ? isOwner : true) %>');
    /* eslint-enable */

    // [C·∫¨P NH·∫¨T 1] L·∫•y ti·∫øn ƒë·ªô t·ª´ Database (thay v√¨ s·ªë 0 c·ª©ng)
    const currentStep = window.gardenData.tutorialStep || 0;

    const tutorialScript = [
        { 
            title: "H·∫ø l√¥ 'ƒë·∫°i gia' t∆∞∆°ng lai! üëã",
            content: "Ch√†o m·ª´ng t·ªõi n√¥ng tr·∫°i! Tui l√† 'Th·ªï ƒê·ªãa' khu n√†y. ƒê·ªÉ tui ch·ªâ √¥ng c√°ch l√†m gi√†u kh√¥ng kh√≥ nha. G√©t g√¥!",
            action: null, 
            target: null
        },
        { 
            title: "B∆∞·ªõc 1: S·∫Øm ƒë·ªì ngh·ªÅ ‚õèÔ∏è",
            content: "Mu·ªën c√≥ ƒë·∫•t th√¨ ph·∫£i cu·ªëc. Nh√¨n xu·ªëng thanh c√¥ng c·ª•, click v√¥ c√°i C√¢y Cu·ªëc (ph√≠m 2) ƒëi fen!",
            action: 'wait_tool_hoe', 
            target: '.tool-slot[onclick*="hoe"]'
        },
        { 
            title: "B∆∞·ªõc 2: Khai hoang üèúÔ∏è",
            content: "Gi·ªù click ƒë·∫°i v√¥ m√†n h√¨nh ƒëen ƒëen kia ƒë·ªÉ t·∫°o √¥ ƒë·∫•t ƒë·∫ßu ti√™n. 50 v√†ng/√¥ ƒë√≥, ƒë·∫ßu t∆∞ cho t∆∞∆°ng lai!",
            action: 'wait_action_buy_plot',
            target: '#game-container'
        },
        { 
            title: "B∆∞·ªõc 3: Shopping üõí",
            content: "C√≥ ƒë·∫•t r·ªìi th√¨ ph·∫£i tr·ªìng c√¢y. B·∫•m v√¥ c√°i C·ª≠a H√†ng (s·ªë 3) ho·∫∑c nh·∫•n ph√≠m 3 ƒë·ªÉ l·ª±a 'h√†ng n√≥ng'.",
            action: 'wait_open_shop',
            target: '.tool-slot[onclick*="plants"]'
        },
        { 
            // [C·∫¨P NH·∫¨T] N·ªôi dung B∆∞·ªõc 4 x·ªãn h∆°n
            title: "B∆∞·ªõc 4: Ch·ªët ƒë∆°n H∆∞·ªõng D∆∞∆°ng üåª",
            content: "H√†ng tuy·ªÉn ƒë√¢y! Mua em 'H∆∞·ªõng D∆∞∆°ng' v·ªÅ tr·ªìng l·∫•y h√™n. R·∫ª, d·ªÖ nu√¥i m√† b√°n ƒë∆∞·ª£c gi√°. Click v√¥ n√≥ l·∫π!",
            action: 'wait_buy_plant',
            target: '.item-card' // Target t·∫°m, s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω chi ti·∫øt trong code
        },
        { 
            title: "B∆∞·ªõc 5: Gieo m·∫ßm üå±",
            content: "C·∫ßm h·∫°t r·ªìi th√¨ click v√¥ √¥ ƒë·∫•t v·ª´a cu·ªëc l√∫c n√£y ƒë·ªÉ tr·ªìng. Nhanh tay l√™n k·∫ªo r·ªõt h·∫°t!",
            action: 'wait_action_plant',
            target: '#game-container'
        },
        { 
            title: "B∆∞·ªõc 6: Ch·ªçn B√¨nh T∆∞·ªõi üí¶",
            content: "√Å √° ƒë·∫•t kh√¥ queo k√¨a! Ch·ªçn ngay B√¨nh T∆∞·ªõi (s·ªë 4) ƒëi, c√¢y kh√°t n∆∞·ªõc l√† n√≥ 'd·∫πo' ƒë√≥!",
            action: 'wait_tool_water',
            target: '.tool-slot[onclick*="water"]'
        },
        { 
            title: "B∆∞·ªõc 7: T∆∞·ªõi t·∫Øm üöø",
            content: "Click v√¥ c√¢y ho·∫∑c ƒë·∫•t ƒë·ªÉ t∆∞·ªõi. C√≥ n∆∞·ªõc th√¨ c√¢y m·ªõi l·ªõn ƒë∆∞·ª£c, kh√¥ng l√† h√©o queo ƒë√≥!",
            action: 'wait_action_water',
            target: '#game-container'
        },
        { 
            title: "B∆∞·ªõc 8: Soi info üßê",
            content: "Ch·ªçn l·∫°i b√†n tay (s·ªë 1), r·ªìi ch·ªâ chu·ªôt v√¥ c√¢y xem n√≥ l·ªõn t·ªõi ƒë√¢u r·ªìi. B·∫•m n√∫t E ho·∫∑c click ƒë√∫p ƒë·ªÉ xem chi ti·∫øt.",
            action: 'wait_hover_info',
            target: '.tool-slot[onclick*="cursor"]'
        },
        { 
            title: "Xong r·ªìi! üéì",
            content: "Xong b√†i v·ª° l√≤ng! Gi·ªù √¥ng t·ª± b∆°i nha. Nh·ªõ canh n∆∞·ªõc n√¥i ƒë·∫ßy ƒë·ªß. Ch√∫c √¥ng s·ªõm th√†nh t·ª∑ ph√∫! B√°i bai üëã",
            action: null,
            target: null
        }
    ];

    let activeStep = currentStep;

    function initTutorial() {
        // Check if guest, hide tutorial
        /* eslint-disable */
        if (!window.isOwner) {
            document.getElementById('tutorialOverlay').style.display = 'none';
            return;
        }

        if (activeStep >= tutorialScript.length) {
            document.getElementById('tutorialOverlay').style.display = 'none';
            return;
        }

        const stepData = tutorialScript[activeStep];
        const dialog = document.getElementById('tutorialOverlay');
        const pointer = document.getElementById('tutPointer');
        
        // Render n·ªôi dung
        document.getElementById('tutTitle').innerText = stepData.title;
        document.getElementById('tutContent').innerText = stepData.content;
        
        // N√∫t Next
        const btn = document.getElementById('tutNextBtn');
        if (stepData.action) {
            btn.style.display = 'none'; 
        } else {
            btn.style.display = 'block';
            btn.innerText = (activeStep === tutorialScript.length - 1) ? "Chi·∫øn th√¥i! üî•" : "Ti·∫øp theo üëâ";
        }

        // Reset Highlight c≈©
        document.querySelectorAll('.highlight-tutorial').forEach(el => el.classList.remove('highlight-tutorial'));
        pointer.style.display = 'none';

        // X·ª≠ l√Ω Highlight m·ªõi
        if (stepData.target) {
            // Delay nh·∫π ƒë·ªÉ ch·ªù DOM render (ƒë·∫∑c bi·ªát l√† Shop)
            setTimeout(() => {
                let els = document.querySelectorAll(stepData.target);
                let targetEl = null;

                // [FIX] Logic t√¨m ƒë√∫ng th·∫ª H∆∞·ªõng D∆∞∆°ng ·ªü B∆∞·ªõc 4
                if (activeStep === 4) { 
                    // T√¨m item card n√†o c√≥ ch·ª©a ch·ªØ 'sunflower' trong h√†m onclick ho·∫∑c t√™n hi·ªÉn th·ªã
                    els.forEach(el => {
                        if (el.getAttribute('onclick') && el.getAttribute('onclick').includes('sunflower')) {
                            targetEl = el;
                        }
                    });
                } else {
                    targetEl = els[0]; // M·∫∑c ƒë·ªãnh l·∫•y ph·∫ßn t·ª≠ ƒë·∫ßu ti√™n t√¨m th·∫•y
                }

                if (targetEl) {
                    targetEl.classList.add('highlight-tutorial');
                    
                    // T√≠nh to√°n v·ªã tr√≠ m≈©i t√™n ch·ªâ tay
                    const rect = targetEl.getBoundingClientRect();
                    pointer.style.display = 'block';
                    // Ch·ªâ v√†o gi·ªØa element
                    pointer.style.left = (rect.left + rect.width/2 - 20) + 'px';
                    pointer.style.top = (rect.top - 60) + 'px'; // N·∫±m tr√™n element 60px
                    
                    // N·∫øu l√† Shop Item th√¨ m≈©i t√™n c·∫ßn z-index cao h∆°n modal
                    if (activeStep === 4) pointer.style.zIndex = "2005"; 
                    else pointer.style.zIndex = "100000";
                }
            }, 100);
        }

        dialog.style.display = 'flex';
    }

    function nextTutorial() {
        advanceStep();
    }

    async function advanceStep() {
        activeStep++;
        
        // [QUAN TR·ªåNG] G·ªçi ƒë√∫ng ƒë∆∞·ªùng d·∫´n API ƒë√£ khai b√°o ·ªü route
        fetch('/my-garden/tutorial/next', {
            method: 'POST', 
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ step: activeStep })
        }).catch(e => console.error("L·ªói l∆∞u step:", e));

        if (activeStep >= tutorialScript.length) {
            document.getElementById('tutorialOverlay').style.display = 'none';
            document.querySelectorAll('.highlight-tutorial').forEach(el => el.classList.remove('highlight-tutorial'));
            document.getElementById('tutPointer').style.display = 'none';
            if(window.SwalPixel) window.SwalPixel.fire({title: 'Tutorial Complete!', icon: 'success', timer: 2000});
        } else {
            initTutorial();
        }
    }

    // Bridge function
    window.checkTutorialAction = function(actionType) {
        if (activeStep >= tutorialScript.length) return;
        const requiredAction = tutorialScript[activeStep].action;
        
        if (requiredAction === actionType) {
            advanceStep();
        }
    };

    // --- HOOKS ---
    const originalSelectTool = window.selectTool;
    window.selectTool = function(toolName) {
        originalSelectTool(toolName);
        if (toolName === 'hoe') window.checkTutorialAction('wait_tool_hoe');
        if (toolName === 'water') window.checkTutorialAction('wait_tool_water');
        if (toolName === 'cursor') window.checkTutorialAction('wait_tool_cursor');
    };

    const originalOpenShop = window.openShopHTML;
    window.openShopHTML = function(tab) {
        originalOpenShop(tab);
        window.checkTutorialAction('wait_open_shop');
        
        // [FIX] N·∫øu ƒëang ·ªü b∆∞·ªõc mua h√†ng, g·ªçi l·∫°i initTutorial ƒë·ªÉ n√≥ t√≠nh to√°n v·ªã tr√≠ highlight item
        if (activeStep === 4) {
            setTimeout(() => initTutorial(), 50); 
        }
    };

    const originalShowStats = window.showPlantStats;
    window.showPlantStats = function(data, coords) {
        originalShowStats(data, coords);
        window.checkTutorialAction('wait_hover_info');
    }

    document.addEventListener('DOMContentLoaded', initTutorial);
</script>

<style>
    /* CSS CHO TUTORIAL */
    .tutorial-wrapper {
        position: absolute; bottom: 120px; left: 20px; z-index: 99999;
        display: flex; align-items: flex-end; font-family: 'VT323', monospace;
        filter: drop-shadow(0 5px 15px rgba(0,0,0,0.5));
        transition: all 0.3s;
    }
    
    .mascot-img {
        width: 100px; height: 100px; 
        animation: bounce 2s infinite;
    }
    
    .dialog-box {
        background: #fff; border: 4px solid #3e2723; border-radius: 15px;
        padding: 15px; max-width: 300px; position: relative; margin-left: -20px;
        margin-bottom: 20px;
    }
    /* M≈©i nh·ªçn h·ªôi tho·∫°i */
    .dialog-box::before {
        content: ''; position: absolute; left: -10px; bottom: 20px;
        border-top: 10px solid transparent; border-bottom: 10px solid transparent; 
        border-right: 15px solid #3e2723;
    }

    .dialog-box h3 { margin: 0 0 5px 0; color: #d84315; font-size: 1.4rem; }
    .dialog-box p { margin: 0 0 10px 0; color: #333; font-size: 1.2rem; line-height: 1.2; }

    .btn-genz {
        background: #ffeb3b; border: 2px solid #f57f17; padding: 5px 15px;
        font-family: inherit; font-size: 1.2rem; font-weight: bold; cursor: pointer;
        border-radius: 8px; width: 100%; transition: 0.2s;
    }
    .btn-genz:hover { background: #fff176; transform: scale(1.05); }

    /* Hi·ªáu ·ª©ng ch·ªâ tay */
    .hand-pointer {
        position: fixed; font-size: 3rem; 
        animation: point 1s infinite alternate;
        display: none; z-index: 100000;
        pointer-events: none; text-shadow: 0 0 10px white;
    }

    /* Hi·ªáu ·ª©ng Highlight (L√†m n·ªïi b·∫≠t n√∫t c·∫ßn b·∫•m) */
    .highlight-tutorial {
        box-shadow: 0 0 0 4px #ffff00, 0 0 20px #ffff00 !important;
        z-index: 100001 !important; position: relative;
        animation: pulse 1s infinite;
    }

    @keyframes pulse { 0% { box-shadow: 0 0 0 0px #ffff00; } 100% { box-shadow: 0 0 0 10px rgba(255, 255, 0, 0); } }
</style>

<style>
    .swal2-popup.swal2-toast {
        background: #3e2723; color: #ffb300; border: 2px solid #ffb300; border-radius: 0; font-family: 'VT323'; font-size: 1.2rem;
    }
</style>

<%- include('partials/footer') %>
<script src="/js/gardenPhaser.js"></script>