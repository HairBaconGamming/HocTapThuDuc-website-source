<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pixel Farm üöú</title>
    
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <link rel="stylesheet" href="/css/styleGarden.css">
</head>
<body>

    <div id="garden-game-container"></div>

    <div class="pixel-ui">
        
        <div class="hud-top">
            <% 
                let backLink = '/profile';
                if (!isOwner && garden.user) { backLink = '/profile/view/' + garden.user._id; }
            %>
            <a href="<%= backLink %>" class="pixel-btn btn-back" title="Quay l·∫°i">
                <i class="fas fa-arrow-left"></i>
            </a>

            <% if (!isOwner) { %>
                <div class="visitor-badge" style="background: rgba(0,0,0,0.7); color: #fff; padding: 5px 10px; border-radius: 4px; border: 2px solid #ff9800; font-family: 'VT323'; margin-right: 10px;">
                    üëÄ V∆∞·ªùn c·ªßa: <strong style="color: #ffb74d;"><%= garden.user ? garden.user.username : 'H√†ng X√≥m' %></strong>
                </div>
            <% } %>

            <div class="pixel-panel player-stats-compact">
                <div class="stat-level-box">
                    <span class="lbl">LV</span>
                    <span class="val" id="ui-level"><%= garden.userLevel %></span>
                </div>
                
                <div class="stat-info-col">
                    <div class="realm-badge" id="ui-realm"><%= garden.levelName %></div>
                    <div class="xp-progress-wrapper">
                        <% 
                            // [FIX] T√≠nh to√°n EJS an to√†n
                            const curXP = garden.currentXP || 0;
                            const maxXP = garden.nextLevelXP || 100;
                            const xpPct = (maxXP > 0) ? Math.min(100, (curXP / maxXP) * 100) : 0;
                        %>
                        <div class="xp-fill" id="ui-xp-bar" style="width: <%= xpPct %>%;"></div>
                        <span class="xp-text" id="ui-xp-text"><%= curXP %>/<%= maxXP %></span>
                    </div>
                </div>
            </div>

            <div class="pixel-panel resources">
                <div class="res-item" title="N∆∞·ªõc">
                    <img src="https://cdn-icons-png.flaticon.com/512/427/427112.png" class="pixel-icon">
                    <span id="ui-water"><%= garden.water %></span>
                </div>
                <div class="res-item" title="V√†ng">
                    <img src="https://cdn-icons-png.flaticon.com/512/217/217853.png" class="pixel-icon">
                    <span id="ui-gold"><%= garden.gold %></span>
                </div>
            </div>
        </div>

        <div id="plantingModeUI" class="planting-ui" style="display: none;">
            <div class="planting-label">üå± ƒêang tr·ªìng...</div>
            <div class="planting-item-name" id="plantingItemName">H·∫°t Gi·ªëng</div>
            <button class="pixel-btn btn-cancel-plant" onclick="window.cancelPlanting()">
                H·ªßy (X)
            </button>
        </div>

        <div id="mobileMoveBtn" class="mobile-action-btn" onclick="toggleMoveMode()" style="display: none;">
            <i class="fas fa-arrows-alt"></i>
        </div>

        <div id="ui-coords-bar" class="coords-badge">
            üìç <span id="ui-coords-x">0</span>, <span id="ui-coords-y">0</span>
        </div>

        <div class="pixel-panel plant-info-panel" id="plantStats">
            <div class="info-header">
                <div class="info-thumb">
                    <img id="statImg" src="" class="pixel-img">
                </div>
                <div class="info-text">
                    <h3 id="statName">...</h3>
                    <div id="statStageBadge" class="pixel-badge">...</div>
                </div>
                <button class="pixel-btn-close" onclick="hidePlantStats()">X</button>
            </div>
            
            <div class="info-body">
                <div class="stat-row">
                    <label><i class="fas fa-tint text-blue"></i> ƒê·ªô ·∫©m</label>
                    <div class="pixel-progress-track">
                        <div id="statWitherBar" class="pixel-progress-fill fill-water"></div>
                    </div>
                    <span id="statWitherVal" class="stat-val">--%</span>
                </div>

                <div class="stat-row">
                    <label><i class="fas fa-seedling text-green"></i> L·ªõn</label>
                    <div class="pixel-progress-track">
                        <div id="statGrowthBar" class="pixel-progress-fill fill-growth"></div>
                    </div>
                    <span id="statTimeProgress" class="stat-val">--%</span>
                </div>

                <div class="info-grid">
                    <div class="info-cell">
                        <small>‚è≥ C√≤n l·∫°i</small>
                        <strong id="statTotalTime">--</strong>
                    </div>
                    <div class="info-cell">
                        <small>üí∞ Gi√° tr·ªã</small>
                        <strong id="statPrice" class="text-gold">--</strong>
                    </div>
                </div>
                
                <div class="info-footer">
                    <small id="statSoilStatus">---</small>
                </div>
            </div>
        </div>

        <div class="hud-bottom" id="mainToolbar">
            <div class="pixel-panel toolbar">
                <div class="tool-slot" onclick="selectTool('move')" data-tool="move" title="Di chuy·ªÉn">
                    <img src="<%= assets.FARMING.tools.move.icon %>">
                    <span class="key-hint">1</span>
                </div>
                
                <div class="tool-slot active" onclick="selectTool('cursor')" data-tool="cursor" title="Xem info">
                    <img src="<%= assets.FARMING.tools.cursor.icon %>">
                    <span class="key-hint">2</span>
                </div>

                <% if (isOwner) { %>
                    <div class="tool-slot" onclick="selectTool('hoe')" data-tool="hoe" title="Cu·ªëc ƒë·∫•t">
                        <img src="<%= assets.FARMING.tools.hoe.icon %>">
                        <span class="key-hint">3</span>
                    </div>
                    
                    <div class="tool-slot" onclick="selectTool('water')" data-tool="water" title="T∆∞·ªõi n∆∞·ªõc">
                        <img src="<%= assets.FARMING.tools.water.icon %>">
                        <span class="key-hint">4</span>
                    </div>
                    
                    <div class="tool-slot shop-slot" onclick="openShopHTML('plants')" data-tool="shop" title="C·ª≠a h√†ng">
                        <img src="/api/pro-images/1767285084901-romnys.png">
                        <span class="key-hint">F</span>
                    </div>

                    <div class="tool-slot" onclick="selectTool('basket')" data-tool="basket" title="Thu ho·∫°ch">
                        <img src="<%= assets.FARMING.tools.basket.icon %>">
                        <span class="key-hint">5</span>
                    </div>
                    
                    <div class="tool-slot" onclick="selectTool('shovel')" data-tool="shovel" title="X√≥a b·ªè">
                        <img src="<%= assets.FARMING.tools.shovel.icon %>">
                        <span class="key-hint">6</span>
                    </div>
                <% } %>
            </div>
        </div>

    </div>

    <div id="shopOverlay" class="pixel-modal-overlay" style="display:none;" 
         onwheel="event.stopPropagation()" onmousedown="event.stopPropagation()" ontouchstart="event.stopPropagation()">
        
        <div class="pixel-window shop-window">
            <div class="window-header">
                <div class="win-title">üõí T·∫°p H√≥a</div>
                <button class="pixel-btn-close red" onclick="closeShop()">X</button>
            </div>
            
            <div class="window-body">
                <div class="npc-area">
                    <div class="npc-bubble">
                        Mua g√¨ h∆°m ch√°u ∆°i? ü•ï
                    </div>
                    <img src="/api/pro-images/1767353474437-ddk8r4.png" class="npc-img">
                </div>

                <div class="shop-area">
                    <div class="shop-tabs">
                        <button class="pixel-tab active" onclick="switchShopTab('plants')" id="tab-plants">üå± H·∫°t Gi·ªëng</button>
                        <button class="pixel-tab" onclick="switchShopTab('decors')" id="tab-decors">üé® Trang Tr√≠</button>
                        <button class="pixel-tab" onclick="switchShopTab('tools')" id="tab-tools">üîß C√¥ng C·ª•</button>
                    </div>
                    
                    <div class="shop-grid" id="shopGrid">
                        </div>
                </div>
            </div>
        </div>
    </div>

    <script type="application/json" id="gardenAssets"><%- JSON.stringify(assets) %></script>
    <script type="application/json" id="gardenData"><%- JSON.stringify(garden) %></script>
    <script>
        window.isOwner = <%= typeof isOwner !== "undefined" ? isOwner : true %>;
        window.gardenAssets = JSON.parse(document.getElementById('gardenAssets').textContent);
        window.gardenData = JSON.parse(document.getElementById('gardenData').textContent);
        
        // Fallback n·∫øu d·ªØ li·ªáu c≈© ch∆∞a c√≥
        if (!window.gardenData.userLevel) window.gardenData.userLevel = 1;
        if (!window.gardenData.currentXP) window.gardenData.currentXP = 0;
        if (!window.gardenData.nextLevelXP) window.gardenData.nextLevelXP = 100;
    </script>

    <script src="/js/gardenPhaser.js"></script>

    <script>
        // --- UI FUNCTIONS ---
        
        // 1. Toggle Planting Mode UI (ƒê∆∞·ª£c g·ªçi t·ª´ Phaser)
        window.togglePlantingUI = function(active, itemName = '') {
            const ui = document.getElementById('plantingModeUI');
            const toolbar = document.getElementById('mainToolbar');
            
            if (active) {
                ui.style.display = 'flex';
                document.getElementById('plantingItemName').innerText = itemName;
                toolbar.classList.add('disabled-toolbar'); // L√†m m·ªù toolbar
                window.hidePlantStats();
            } else {
                ui.style.display = 'none';
                toolbar.classList.remove('disabled-toolbar');
            }
        }

        // 2. Stats Panel Logic
        let statsInterval = null;
        window.showPlantStats = function(itemData) {
            const panel = document.getElementById('plantStats');
            if (statsInterval) clearInterval(statsInterval);

            // [FIX] X·ª≠ l√Ω tr∆∞·ªùng h·ª£p ƒê·∫•t (kh√¥ng c√≥ trong PLANTS config)
            const isPlot = itemData.type === 'plot';
            const config = isPlot ? null : window.gardenAssets.PLANTS[itemData.itemId];

            // N·∫øu kh√¥ng ph·∫£i ƒë·∫•t v√† kh√¥ng t√¨m th·∫•y config c√¢y -> ·∫®n
            if (!isPlot && !config) { window.hidePlantStats(); return; }

            panel.classList.add('active'); // Hi·ªán b·∫£ng

            const render = () => {
                // ... (Logic render gi·ªØ nguy√™n t·ª´ b·∫£n tr∆∞·ªõc) ...
                if (isPlot) {
                    document.getElementById('statName').innerText = "√î ƒê·∫•t Tr·ªëng";
                    document.getElementById('statImg').src = "/api/pro-images/1767291175911-ytf6vu.png";
                    document.getElementById('statStageBadge').innerText = "S·∫µn s√†ng";
                    document.getElementById('statStageBadge').className = "pixel-badge grey";
                    
                    document.getElementById('statGrowthBar').style.width = "0%";
                    document.getElementById('statWitherBar').style.width = "0%";
                    document.getElementById('statTotalTime').innerText = "---";
                    document.getElementById('statPrice').innerText = "---";
                    document.getElementById('statSoilStatus').innerText = "ƒê·∫•t tr·ªëng";
                } else {
                    document.getElementById('statName').innerText = config.name;
                    document.getElementById('statImg').src = config.stages[itemData.stage || 0];
                    document.getElementById('statPrice').innerText = config.rewardGold.min + "-" + config.rewardGold.max;

                    // T√≠nh to√°n th·ªùi gian
                    const now = Date.now();
                    const lastUpdate = itemData.lastUpdated ? new Date(itemData.lastUpdated).getTime() : new Date(itemData.plantedAt).getTime();
                    const elapsed = now - lastUpdate;

                    // Check ƒë·∫•t ∆∞·ªõt (T√¨m item ƒë·∫•t t∆∞∆°ng ·ª©ng trong data global)
                    let plot = window.gardenData.items.find(i => i.type === 'plot' && i.x === itemData.x && i.y === itemData.y);
                    let isWet = false;
                    if (plot && plot.lastWatered && (now - new Date(plot.lastWatered).getTime() < 24*3600000)) isWet = true;

                    document.getElementById('statSoilStatus').innerText = isWet ? "üíß ƒê·∫•t ·∫©m" : "üåµ ƒê·∫•t kh√¥";
                    document.getElementById('statSoilStatus').style.color = isWet ? "#29b6f6" : "#ef5350";

                    // Growth Progress & Wither logic (gi·ªØ nguy√™n code t√≠nh to√°n)
                    // ... (Code t√≠nh to√°n % nh∆∞ c≈©)
                    const currentProgress = (itemData.growthProgress || 0) + (isWet ? elapsed : 0);
                    const timePerStage = parseDuration(config.growthTime);
                    const maxStage = config.maxStage || 3;
                    const stage = Math.min(Math.floor(currentProgress / timePerStage), maxStage);
                    const pct = Math.min(100, ((currentProgress % timePerStage) / timePerStage) * 100);
                    
                    if (stage >= maxStage) {
                        document.getElementById('statGrowthBar').style.width = "100%";
                        document.getElementById('statTimeProgress').innerText = "MAX";
                        document.getElementById('statStageBadge').innerText = "ƒê√É CH√çN";
                        document.getElementById('statStageBadge').className = "pixel-badge green";
                        document.getElementById('statTotalTime').innerText = "Thu ho·∫°ch!";
                    } else {
                        document.getElementById('statGrowthBar').style.width = pct + "%";
                        document.getElementById('statTimeProgress').innerText = Math.floor(pct) + "%";
                        document.getElementById('statStageBadge').innerText = `C·∫•p ${stage+1}/${maxStage+1}`;
                        document.getElementById('statStageBadge').className = "pixel-badge yellow";
                        const remaining = timePerStage - (currentProgress % timePerStage);
                        document.getElementById('statTotalTime').innerText = formatTime(remaining);
                    }
                    
                    // Wither Bar update...
                    const witherTime = parseDuration(config.witherTime || '30 ph√∫t');
                    let realWither = itemData.witherProgress || 0;
                    if (!isWet) realWither += elapsed; else realWither = Math.max(0, realWither - elapsed);
                    const healthPct = Math.max(0, 100 - (realWither / witherTime * 100));
                    document.getElementById('statWitherBar').style.width = healthPct + "%";
                    document.getElementById('statWitherVal').innerText = Math.floor(healthPct) + "%";
                }
            };
            
            render();
            statsInterval = setInterval(render, 1000);
        };

        window.hidePlantStats = function() {
            if (statsInterval) clearInterval(statsInterval);
            document.getElementById('plantStats').classList.remove('active');
        };

        // --- SHOP LOGIC ---
        function closeShop() { document.getElementById('shopOverlay').style.display = 'none'; }
        
        window.openShopHTML = function(tab) {
            document.getElementById('shopOverlay').style.display = 'flex';
            switchShopTab(tab);
        };

        window.switchShopTab = function(type) {
            document.querySelectorAll('.pixel-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${type}`).classList.add('active');

            const container = document.getElementById('shopGrid');
            container.innerHTML = ''; 

            let items = [];
            // L·∫•y data t·ª´ ASSETS (ƒë∆∞·ª£c inject t·ª´ server)
            if (type === 'plants') {
                Object.entries(window.gardenAssets.PLANTS || {}).forEach(([key, val]) => {
                    items.push({ id: key, ...val, type: 'plant' });
                });
            } else if (type === 'decors') {
                Object.entries(window.gardenAssets.DECORS || {}).forEach(([key, val]) => {
                    items.push({ id: key, ...val, type: 'decor' });
                });
            }

            if (items.length === 0) {
                container.innerHTML = '<div style="width:100%; text-align:center; padding:20px; color:#5d4037;">H·∫øt h√†ng r·ªìi nha...</div>';
            } else {
                items.forEach(item => {
                    let icon = item.icon;
                    // N·∫øu l√† c√¢y, l·∫•y ·∫£nh giai ƒëo·∫°n cu·ªëi l√†m icon
                    if (!icon && item.stages) icon = item.stages[item.stages.length-1];
                    // N·∫øu l√† h√†ng r√†o, l·∫•y ·∫£nh base
                    if (item.isFence && item.images) icon = item.images.base;
                    
                    const price = item.price || 50;

                    const html = `
                        <div class="shop-card" onclick="window.buyItem('${item.id}', '${item.type}')">
                            <div class="card-img-box">
                                <img src="${icon}" class="card-img">
                            </div>
                            <div class="card-info">
                                <div class="card-name">${item.name}</div>
                                <div class="card-price">
                                    üí∞ ${price}
                                </div>
                            </div>
                        </div>
                    `;
                    container.innerHTML += html;
                });
            }
        };

        // Emit s·ª± ki·ªán mua xu·ªëng Phaser
        window.buyItem = function(id, type) {
            if(window.gameEvents) {
                window.gameEvents.emit('buyItem', { id, type });
                closeShop();
            }
        };

        document.addEventListener('keydown', (e) => {
            if (['INPUT', 'TEXTAREA'].includes(e.target.tagName)) return;
            const key = e.key.toLowerCase();
            const isOwner = window.isOwner;

            // X to cancel planting
            if (key === 'x') { window.cancelPlanting(); return; }
            
            // ESC to close UI
            if (key === 'escape') { closeShop(); hidePlantStats(); window.cancelPlanting(); return; }

            // Tools
            switch(key) {
                case '1': selectTool('move'); break;
                case '2': selectTool('cursor'); break;
                case '3': if(isOwner) selectTool('hoe'); break;
                case '4': if(isOwner) selectTool('water'); break;
                case '5': if(isOwner) selectTool('basket'); break;
                case '6': if(isOwner) selectTool('shovel'); break;
                case 'f': if(isOwner) { 
                    if(document.getElementById('shopOverlay').style.display === 'flex') closeShop(); 
                    else openShopHTML('plants'); 
                } break;
            }
        });

        // Emit s·ª± ki·ªán ch·ªçn tool xu·ªëng Phaser
        window.selectTool = function(toolName) {
            // N·∫øu toolbar b·ªã disable (ƒëang tr·ªìng c√¢y), kh√¥ng cho b·∫•m
            if(document.getElementById('mainToolbar').classList.contains('disabled-toolbar')) return;
            
            if(window.gameEvents) window.gameEvents.emit('toolChanged', toolName);
            
            document.querySelectorAll('.tool-slot').forEach(el => el.classList.remove('active'));
            const activeEl = document.querySelector(`.tool-slot[data-tool="${toolName}"]`);
            if(activeEl) activeEl.classList.add('active');
        };

        // Toggle Move Mode from UI
        window.toggleMoveMode = function() {
            const btn = document.getElementById('mobileMoveBtn');
            btn.classList.toggle('active');
            window.gameEvents.emit('toggleMoveMode');
        }

        // Callback t·ª´ Phaser ƒë·ªÉ hi·ªán/·∫©n n√∫t
        window.updateMobileMoveBtn = function(show) {
            const btn = document.getElementById('mobileMoveBtn');
            if (btn) btn.style.display = show ? 'flex' : 'none';
            if (!show) btn.classList.remove('active'); // Reset state
        }

        // Helpers
        function formatTime(ms) { return ms <= 0 ? "00:00" : new Date(ms).toISOString().substr(14, 5); }
        function parseDuration(str) { const num = parseInt(str); return num * (str.includes('gi·ªù') ? 3600000 : 60000); }
    </script>

    <link rel="stylesheet" href="/css/styleTutorial.css">
    <script src="/js/tutorial.js"></script>
</body>
</html>