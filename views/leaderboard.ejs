<%- include('partials/header') %>
<link rel="stylesheet" href="/css/styleLeaderboard.css">
<link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">

<div class="leaderboard-wrapper">
    
    <div class="lb-header">
        <h1 class="lb-title">üèÜ ƒê·∫•u Tr∆∞·ªùng Danh V·ªçng</h1>
        <div class="lb-desc">‚ú® Vinh danh nh·ªØng "Chi·∫øn Th·∫ßn" chƒÉm ch·ªâ nh·∫•t Server ‚ú®</div>
    </div>

    <div class="podium-container">
        
        <% if(top3[1]) { %>
            <a href="/profile/view/<%= top3[1]._id %>" class="podium-link rank-2">
                <div class="podium-card">
                    <div class="rank-badge">2</div>
                    <div class="podium-avatar-box">
                        <img src="<%= top3[1].avatar || '/default.png' %>" class="podium-avatar">
                    </div>
                    <div class="podium-info">
                        <div class="podium-name"><%= top3[1].username %></div>
                        <div class="podium-score"><%= top3[1].points || 0 %> pts</div>
                    </div>
                </div>
            </a>
        <% } %>

        <% if(top3[0]) { %>
            <a href="/profile/view/<%= top3[0]._id %>" class="podium-link rank-1">
                <div class="podium-card">
                    <div class="crown">üëë</div>
                    <div class="rank-badge" style="background: #ffb300; border-color: #000; color: #000;">1</div>
                    <div class="podium-avatar-box">
                        <img src="<%= top3[0].avatar || '/default.png' %>" class="podium-avatar">
                    </div>
                    <div class="podium-info">
                        <div class="podium-name">
                            <%= top3[0].username %>
                            <% if(top3[0].isPro) { %><span class="pro-badge">PRO</span><% } %>
                        </div>
                        <div class="podium-score" style="font-size: 2rem;"><%= top3[0].points || 0 %> pts</div>
                        <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">üî• Out Tr√¨nh üî•</div>
                    </div>
                </div>
            </a>
        <% } %>

        <% if(top3[2]) { %>
            <a href="/profile/view/<%= top3[2]._id %>" class="podium-link rank-3">
                <div class="podium-card">
                    <div class="rank-badge">3</div>
                    <div class="podium-avatar-box">
                        <img src="<%= top3[2].avatar || '/default.png' %>" class="podium-avatar">
                    </div>
                    <div class="podium-info">
                        <div class="podium-name"><%= top3[2].username %></div>
                        <div class="podium-score"><%= top3[2].points || 0 %> pts</div>
                    </div>
                </div>
            </a>
        <% } %>
    </div>

    <div class="rank-list">
        <% if (restOfList && restOfList.length > 0) { %>
            <% restOfList.forEach((u, idx) => { %>
                <a href="/profile/view/<%= u._id %>" style="text-decoration: none;">
                    <div class="rank-card">
                        <div class="rank-num">#<%= idx + 4 %></div>
                        <img src="<%= u.avatar || '/default.png' %>" class="rank-avatar-sm">
                        <div class="rank-details">
                            <div class="rank-name-txt">
                                <%= u.username %>
                                <% if(u.isPro) { %><span class="pro-badge">PRO</span><% } %>
                            </div>
                            <div class="rank-meta"><%= u.class || 'L·ªõp ?' %> ‚Ä¢ <%= u.school || 'THPT Th·ªß ƒê·ª©c' %></div>
                        </div>
                        <div class="rank-pts"><%= u.points || 0 %></div>
                    </div>
                </a>
            <% }) %>
        <% } else { %>
            <div style="text-align: center; color: #999; padding: 40px;">
                <img src="https://cdn-icons-png.flaticon.com/512/7486/7486744.png" width="60" style="opacity: 0.5;">
                <p>Ch∆∞a c√≥ ai ·ªü ƒë√¢y c·∫£. H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n leo rank!</p>
            </div>
        <% } %>
    </div>

</div>

<% if (user && myRank) { %>
    <a href="/profile" style="text-decoration: none;">
        <div class="player-hud">
            <div class="hud-left">
                <div class="hud-rank"><%= myRank %></div>
                <img src="<%= user.avatar || '/default.png' %>" class="hud-avatar">
                <div class="hud-info">
                    <div class="hud-label">Th·ª© h·∫°ng c·ªßa b·∫°n</div>
                    <div class="hud-name"><%= user.username %></div>
                </div>
            </div>
            <div class="hud-right">
                <%= user.points || 0 %> <span style="font-size: 1rem;">pts</span>
            </div>
        </div>
    </a>
<% } %>

<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        
        // 1. H√†m ch·∫°y hi·ªáu ·ª©ng (S·ª≠ d·ª•ng fromTo ƒë·ªÉ ch·∫Øc ch·∫Øn 100% ch·∫°y ƒë√∫ng)
        const runAnimations = () => {
            // N·∫øu GSAP v·∫´n ch∆∞a c√≥ th√¨ d·ª´ng, ch·ªù l·∫ßn check sau
            if (typeof gsap === 'undefined') return;

            const tl = gsap.timeline();

            // Header bay xu·ªëng
            tl.fromTo(".lb-header", 
                { y: -50, opacity: 0, visibility: 'hidden' },
                { y: 0, opacity: 1, visibility: 'visible', duration: 0.8, ease: "back.out(1.7)" }
            );

            // B·ª•c Podium n·∫£y l√™n
            tl.fromTo(".podium-link", 
                { y: 100, opacity: 0, scale: 0.8, visibility: 'hidden' },
                { y: 0, opacity: 1, scale: 1, visibility: 'visible', duration: 1, stagger: 0.2, ease: "elastic.out(1, 0.5)" },
                "-=0.5"
            );

            // Danh s√°ch Rank bay sang
            tl.fromTo(".rank-card", 
                { x: -30, opacity: 0, visibility: 'hidden' },
                { x: 0, opacity: 1, visibility: 'visible', duration: 0.5, stagger: 0.05, ease: "power2.out" },
                "-=0.8"
            );

            // Sticky Bar bay l√™n
            tl.fromTo(".player-hud", 
                { y: 100, opacity: 0, visibility: 'hidden' },
                { y: 0, opacity: 1, visibility: 'visible', duration: 0.8, ease: "power2.out" },
                "-=0.5"
            );
        };

        // 2. C∆† CH·∫æ KI·ªÇM TRA & K√çCH HO·∫†T (Fix l·ªói m·∫°ng ch·∫≠m)
        if (typeof gsap !== 'undefined') {
            // N·∫øu th∆∞ vi·ªán ƒë√£ t·∫£i xong -> Ch·∫°y ngay
            runAnimations();
        } else {
            // N·∫øu ch∆∞a xong -> Check m·ªói 50ms
            const checkInterval = setInterval(() => {
                if (typeof gsap !== 'undefined') {
                    clearInterval(checkInterval);
                    runAnimations();
                }
            }, 50);

            // 3. FAILSAFE (D·ª± ph√≤ng): Sau 3 gi√¢y m√† v·∫´n l·ªói -> Hi·ªán th·ªß c√¥ng
            // (Tr√°nh tr∆∞·ªùng h·ª£p m·∫°ng r·ªõt h·∫≥n khi·∫øn trang tr·∫Øng tr∆°n)
            setTimeout(() => {
                clearInterval(checkInterval);
                document.querySelectorAll('.lb-header, .podium-link, .rank-card, .player-hud').forEach(el => {
                    el.style.opacity = '1';
                    el.style.visibility = 'visible';
                    el.style.transform = 'none';
                });
            }, 3000);
        }
    });
</script>

<%- include('partials/footer') %>