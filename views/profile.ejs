<%- include('partials/header') %>
<link rel="stylesheet" href="/css/styleProfile.css">

<div class="profile-wrapper">
    
    <div class="profile-grid">
        
        <aside class="bento-card identity-card" data-animate="fade-right">
            <div class="card-banner"></div> 
            
            <div class="id-avatar-wrapper">
                <img src="<%= user.avatar || 'https://cdn-icons-png.flaticon.com/512/847/847969.png' %>" class="id-avatar">
                <% if(user.isPro) { %> <div class="pro-badge" title="VIP Member">üëë</div> <% } %>
            </div>

            <div class="id-content">
                <h1 class="id-name"><%= user.username %></h1>
                <span class="id-username">@<%= user.username.toLowerCase().replace(/\s+/g, '') %></span>

                <div class="id-bio">
                    "<%= user.bio || 'Ch∆∞a c√≥ ti·ªÉu s·ª≠. H√£y vi·∫øt g√¨ ƒë√≥ th·∫≠t ng·∫ßu!' %>"
                </div>

                <div class="id-tags">
                    <div class="tag-pill"><i class="fas fa-graduation-cap" style="color: #6366f1;"></i> <%= user.class || 'L·ªõp ?' %></div>
                    <div class="tag-pill"><i class="fas fa-school" style="color: #ef4444;"></i> <%= user.school || 'Tr∆∞·ªùng ?' %></div>
                </div>

                <a href="/profile/edit" class="btn-action btn-primary">
                    <i class="fas fa-pen-nib"></i> S·ª≠a h·ªì s∆°
                </a>
                
                <button class="btn-action btn-secondary" onclick="copyMyLink()">
                    <i class="fas fa-link"></i> Sao ch√©p Link
                </button>

                <a href="/logout" class="btn-action btn-danger" style="margin-top: 10px;">
                    <i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t
                </a>
            </div>
        </aside>

        <main>
            <div class="stats-grid" data-animate="fade-down">
                <div class="stat-card">
                    <div class="stat-val"><%= user.points || 0 %></div>
                    <div class="stat-label">ü™ô Points (V√†ng)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-val"><%= user.xp || 0 %></div>
                    <div class="stat-label">‚ú® T·ªïng XP</div>
                </div>
                <div class="stat-card">
                    <div class="stat-val">#<%= stats.rank || '--' %></div>
                    <div class="stat-label">üèÜ X·∫øp h·∫°ng</div>
                </div>
            </div>

            <div class="bento-card level-container" data-animate="fade-up">
                <div class="level-header">
                    <span><i class="fas fa-bolt" style="color:#eab308"></i> Level <%= user.level || 1 %></span>
                    <span style="color:#666; font-size: 0.9rem;"><%= (user.xp || 0) % 100 %>/100 XP</span>
                </div>
                <div class="progress-track">
                    <div class="progress-fill" style="width: <%= (user.xp || 0) % 100 %>%;"></div>
                </div>
                <p style="margin-top: 10px; font-size: 0.85rem; color: #666; text-align: center;">
                    ‚ö° Ch·ªâ c·∫ßn c√†y th√™m <b><%= 100 - ((user.xp || 0) % 100) %> XP</b> n·ªØa l√† l√™n c·∫•p!
                </p>
            </div>

            <div class="bento-card tree-section" data-animate="fade-left">
                <div class="tree-info">
                    <h3>üè° V∆∞·ªùn Nh√† Tui</h3>
                    <p style="color: #555; margin-bottom: 5px;">Khu v·ª±c tr·ªìng tr·ªçt, nu√¥i c√° v√† chill.</p>
                    <a href="/my-garden" class="btn-visit">Gh√© thƒÉm ngay &rarr;</a>
                </div>
                <div class="tree-visual">
                    <img src="https://cdn-icons-png.flaticon.com/512/4140/4140047.png" style="width: 100px; transform: rotate(10deg); filter: drop-shadow(4px 4px 0 rgba(0,0,0,0.1));">
                </div>
            </div>

            <div class="bento-card activity-box" style="margin-top: 25px;" data-animate="fade-up">
                <h3 style="font-size: 1.3rem; margin-bottom: 20px; display:flex; align-items:center; gap:10px; font-weight: 800;">
                    üìú Nh·∫≠t k√Ω ho·∫°t ƒë·ªông
                </h3>
                <ul class="activity-list">
                    <% if (activities && activities.length > 0) { %>
                        <% activities.forEach(activity => { %>
                            <li class="activity-item">
                                <div class="activity-icon">‚úÖ</div>
                                <div class="activity-info">
                                    <h4>ƒê√£ xong b√†i <b>"<%= activity.lessonId ? activity.lessonId.title : 'B√†i h·ªçc' %>"</b></h4>
                                    <span class="activity-time"><i class="far fa-clock"></i> <%= new Date(activity.completedAt).toLocaleDateString('vi-VN') %></span>
                                </div>
                            </li>
                        <% }); %>
                    <% } else { %>
                        <li style="text-align: center; color: #999; padding: 20px;">
                            <img src="https://cdn-icons-png.flaticon.com/512/7486/7486744.png" width="50" style="opacity: 0.5; margin-bottom: 10px;">
                            <p>V·∫Øng tanh √†! G√©t g√¥ ƒëi h·ªçc th√¥i c√°c b·∫°n ∆°i! üèÉ‚Äç‚ôÇÔ∏è</p>
                        </li>
                    <% } %>
                </ul>
            </div>

        </main>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        // H√†m ch·∫°y animation an to√†n
        const runProfileAnimations = () => {
            if (typeof gsap === 'undefined') return;

            gsap.fromTo('.identity-card', 
                { x: -50, opacity: 0, visibility: 'hidden' },
                { x: 0, opacity: 1, visibility: 'visible', duration: 0.8, ease: 'power2.out' }
            );

            gsap.fromTo('.stat-card', 
                { y: 30, opacity: 0, visibility: 'hidden' },
                { y: 0, opacity: 1, visibility: 'visible', duration: 0.6, stagger: 0.1, delay: 0.2, ease: "back.out(1.7)" }
            );

            gsap.fromTo('.bento-card:not(.identity-card)', 
                { y: 50, opacity: 0, visibility: 'hidden' },
                { y: 0, opacity: 1, visibility: 'visible', duration: 0.8, stagger: 0.15, delay: 0.1, ease: "power2.out" }
            );
        };

        if (typeof gsap !== 'undefined') {
            runProfileAnimations();
        } else {
            const checkInterval = setInterval(() => {
                if (typeof gsap !== 'undefined') {
                    clearInterval(checkInterval);
                    runProfileAnimations();
                }
            }, 50);

            setTimeout(() => {
                clearInterval(checkInterval);
                document.querySelectorAll('.identity-card, .stat-card, .bento-card').forEach(el => {
                    el.style.opacity = '1';
                    el.style.visibility = 'visible';
                    el.style.transform = 'none';
                });
            }, 3000);
        }
    });

    function copyMyLink() {
        const url = `${window.location.origin}/profile/view/<%= user._id %>`;
        navigator.clipboard.writeText(url).then(() => {
            if(window.SwalPixel) window.SwalPixel.fire({title: "ƒê√£ ch√©p link!", icon: "success"});
            else alert("ƒê√£ sao ch√©p link h·ªì s∆°!");
        }).catch(err => console.error('L·ªói:', err));
    }
</script>

<%- include('partials/footer') %>