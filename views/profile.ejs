<%- include('partials/header') %>
<link rel="stylesheet" href="/css/styleProfile.css">

<div class="profile-wrapper">
    
    <div class="profile-grid">
        
        <aside class="bento-card identity-card" data-animate="fade-right">
            <div class="id-avatar-wrapper">
                <img src="<%= user.avatar || 'https://cdn-icons-png.flaticon.com/512/847/847969.png' %>" class="id-avatar">
                <% if(user.isPro) { %>
                    <div class="pro-badge" title="T√†i kho·∫£n VIP">üëë</div>
                <% } %>
            </div>

            <h1 class="id-name"><%= user.username %></h1>
            <p class="id-username">@<%= user.username.toLowerCase().replace(/\s+/g, '') %></p>

            <div class="id-meta">
                <span class="meta-tag"><i class="fas fa-graduation-cap"></i> <%= user.class || 'L·ªõp ?' %></span>
                <span class="meta-tag"><i class="fas fa-school"></i> <%= user.school || 'Tr∆∞·ªùng ?' %></span>
            </div>

            <div class="id-bio">
                "<%= user.bio || 'Ch∆∞a c√≥ ti·ªÉu s·ª≠. H√£y vi·∫øt g√¨ ƒë√≥ th·∫≠t ng·∫ßu!' %>"
            </div>

            <a href="/profile/edit" class="btn-edit-profile">
                <i class="fas fa-pen"></i> Ch·ªânh s·ª≠a h·ªì s∆°
            </a>
            
            <div style="margin-top: 15px;">
                <a href="/logout" style="color: #ff6b6b; font-weight: 700; font-size: 0.9rem;">
                    <i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t
                </a>
            </div>
        </aside>

        <main>
            <div class="stats-row" data-animate="fade-down">
                <div class="stat-box highlight">
                    <h3><%= user.totalPoints || 0 %></h3>
                    <p>üå± ƒêi·ªÉm T√≠ch L≈©y</p>
                </div>
                <div class="stat-box">
                    <h3><%= stats.completedLessons || 0 %></h3> <p>üìö B√†i h·ªçc</p>
                </div>
                <div class="stat-box">
                    <h3>#<%= stats.rank || '--' %></h3> <p>üèÜ X·∫øp h·∫°ng</p>
                </div>
            </div>

            <div class="bento-card level-container" data-animate="fade-up">
                <div class="level-header">
                    <span>Level <%= Math.floor((user.points || 0) / 100) + 1 %>: H·ªçc Gi·∫£ T·∫≠p S·ª±</span>
                    <span><%= (user.points || 0) % 100 %>/100 XP</span>
                </div>
                <div class="progress-track">
                    <div class="progress-fill" style="width: <%= (user.points || 0) % 100 %>%;"></div>
                </div>
                <p style="margin-top: 10px; font-size: 0.85rem; color: #666;">
                    C·ªë l√™n! <b><%= 100 - ((user.points || 0) % 100) %> ƒëi·ªÉm</b> n·ªØa ƒë·ªÉ l√™n c·∫•p ti·∫øp theo.
                </p>
            </div>

            <div class="bento-card tree-section" data-animate="fade-left">
                <div class="tree-info">
                    <h3>üå≥ V∆∞·ªùn ∆Ø∆°m C·ªßa T√¥i</h3>
                    <p style="color: #666; margin-bottom: 15px;">C√¢y c·ªßa b·∫°n l·ªõn l√™n nh·ªù ki·∫øn th·ª©c b·∫°n n·∫°p v√†o.</p>
                    <a href="/my-garden" style="color: var(--primary); font-weight: 800; text-decoration: none;">
                        V·ªÅ v∆∞·ªùn chƒÉm c√¢y &rarr;
                    </a>
                </div>
            </div>

            <div class="bento-card" data-animate="fade-up">
                <h3 style="font-size: 1.2rem; margin-bottom: 20px;">üìú Ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y</h3>
                <ul class="activity-list">
                    <% if (activities && activities.length > 0) { %>
                        <% activities.forEach(activity => { %>
                            <li class="activity-item">
                                <div class="activity-icon"><i class="fas fa-check"></i></div>
                                <div class="activity-content">
                                    <h4>Ho√†n th√†nh b√†i "<%= activity.lessonId ? activity.lessonId.title : 'B√†i h·ªçc' %>"</h4>
                                    <span class="activity-time"><%= new Date(activity.completedAt).toLocaleDateString('vi-VN') %></span>
                                </div>
                            </li>
                        <% }); %>
                    <% } else { %>
                        <li class="activity-item">
                            <div class="activity-content">
                                <p style="color: #666; font-style: italic;">Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o</p>
                            </div>
                        </li>
                    <% } %>
                </ul>
            </div>

        </main>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script>
    if(typeof gsap !== 'undefined') {
        //gsap.from('.identity-card', { x: -50, opacity: 0, duration: 0.8, ease: 'power2.out' });
        gsap.from('.stat-box', { y: 30, opacity: 0, duration: 0.6, stagger: 0.1, delay: 0.2 });
        gsap.from('.bento-card', { y: 30, opacity: 0, duration: 0.6, stagger: 0.2, delay: 0.4 });
    }

    function copyMyLink() {
        // T·∫°o link profile d·ª±a tr√™n ID c·ªßa user hi·ªán t·∫°i
        const url = `${window.location.origin}/profile/view/<%= user._id %>`;
        navigator.clipboard.writeText(url).then(() => {
            if(window.SwalPixel) window.SwalPixel.fire({title: "ƒê√£ ch√©p link!", icon: "success"});
            else alert("ƒê√£ sao ch√©p link h·ªì s∆°!");
        }).catch(err => console.error('L·ªói:', err));
    }
</script>

<%- include('partials/footer') %>