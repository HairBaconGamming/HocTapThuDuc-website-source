<%- include('partials/header', { user: user, activePage: 'home' }) %>

<main>
    <% if (user) { %>
        <!-- ============================================= -->
        <!-- LOGGED-IN VIEW: DASHBOARD-STYLE HERO          -->
        <!-- ============================================= -->
        <section class="hero logged-in-dashboard" id="hero-section">
            <div id="particles-js"></div>
            <div class="hero-overlay"></div>
            <div class="hero-container">
                <div class="hero-content logged-in">
                    <div class="hero-grid">
                        <!-- Statistics Card -->
                        <div class="stat-card interactive-card" data-tilt>
                            <div class="card-glow"></div>
                            <div class="card-content">
                                <h2 class="card-title"><i class="fas fa-chart-bar"></i> Thống Kê</h2>
                                <p><i class="fas fa-users card-icon"></i> Tổng tài khoản: <strong><%= totalUsers.toLocaleString('vi-VN') %></strong></p>
                                <p><i class="fas fa-eye card-icon"></i> Lượt truy cập hôm nay: <strong><%= dailyVisits.toLocaleString('vi-VN') %></strong></p>
                                <p><i class="fas fa-globe-asia card-icon"></i> Tổng lượt truy cập: <strong><%= totalVisits.toLocaleString('vi-VN') %></strong></p>
                            </div>
                        </div>

                        <!-- Latest Lessons Card -->
                        <div class="latest-card interactive-card lessons-card" data-tilt>
                            <div class="card-glow"></div>
                            <div class="card-content">
                                <h2 class="card-title"><i class="fas fa-graduation-cap"></i> Bài Học Mới Nhất</h2>
                                <% if (latestLessons && latestLessons.length > 0) { %>
                                  <ul class="content-list">
                                    <% latestLessons.forEach(function(lesson) { %>
                                      <li class="list-item">
                                        <a href="/lesson/<%= lesson._id %>" class="item-link">
                                          <h3 class="item-title"><%= lesson.title %></h3>
                                          <span class="item-date"><%= new Date(lesson.createdAt).toLocaleDateString('vi-VN') %></span>
                                        </a>
                                      </li>
                                    <% }); %>
                                  </ul>
                                <% } else { %>
                                  <p class="no-content">Chưa có bài học mới.</p>
                                <% } %>
                            </div>
                        </div>

                        <!-- Latest News Card -->
                        <div class="latest-card interactive-card news-card" data-tilt>
                            <div class="card-glow"></div>
                            <div class="card-content">
                              <h2 class="card-title"><i class="fas fa-newspaper"></i> Tin Tức Mới Nhất</h2>
                              <% if (latestNews && latestNews.length > 0) { %>
                                <ul class="content-list">
                                  <% latestNews.forEach(function(news) { %>
                                    <li class="list-item">
                                      <a href="/news/<%= news._id %>" class="item-link">
                                        <h3 class="item-title"><%= news.title %></h3>
                                        <span class="item-date"><%= new Date(news.createdAt).toLocaleDateString('vi-VN') %></span>
                                      </a>
                                    </li>
                                  <% }); %>
                                </ul>
                              <% } else { %>
                                <p class="no-content">Chưa có tin tức mới.</p>
                              <% } %>
                            </div>
                        </div>
                    </div>

                    <!-- Live Activity Feed -->
                    <div id="liveFeedContainer">
                        <div id="liveFeed"></div>
                    </div>
                </div>
            </div>
        </section>

    <% } else { %>

        <!-- ============================================= -->
        <!-- GUEST VIEW: FULL LANDING PAGE                 -->
        <!-- ============================================= -->
        
        <!-- Hero Section for Guests -->
        <section class="hero-section-v2">
            <div id="particles-js" style="position: absolute; inset: 0; z-index: 0;"></div>
            <div class="hero-background-elements">
                <div class="hero-aurora aurora-1"></div>
                <div class="hero-aurora aurora-2"></div>
                <div class="hero-aurora aurora-3"></div>
            </div>
            <div class="hero-content-v2">
                <div class="hero-text-content">
                    <div class="hero-badge">
                        <i class="fas fa-school"></i> Dành Riêng cho Học Sinh THPT Thủ Đức
                    </div>
                    <h1 class="hero-title-v2">
                        <span class="line"><span>Nền Tảng</span></span>
                        <span class="line"><span><span class="highlight">Dẫn Đầu</span> Tương Lai</span></span>
                    </h1>
                    <p class="hero-subtitle-v2">
                        Chinh phục mọi kỳ thi với hệ thống bài giảng, đề thi và công cụ AI độc quyền được thiết kế cho học sinh THPT tại TP. Thủ Đức.
                    </p>
                    <div class="hero-cta-buttons">
                        <a href="/register" class="btn btn-primary-glow">
                            <i class="fas fa-user-plus"></i> Đăng Ký Miễn Phí
                        </a>
                         <a href="/login" class="btn btn-secondary-outline">
                            <i class="fas fa-sign-in-alt"></i> Đăng Nhập
                        </a>
                    </div>
                </div>
            </div>
        </section>

        <!-- Stats Section -->
        <section class="stats-section">
            <div class="container">
                <div class="stats-grid">
                    <div class="stat-item" data-animate="stagger">
                        <i class="fas fa-users stat-icon"></i>
                        <div class="stat-number" data-target="<%= totalUsers %>">0</div>
                        <div class="stat-label">Học Viên</div>
                    </div>
                    <div class="stat-item" data-animate="stagger">
                        <i class="fas fa-book-reader stat-icon"></i>
                        <div class="stat-number" data-target="<%= latestLessons.length %>">0</div>
                        <div class="stat-label">Bài Giảng</div>
                    </div>
                    <div class="stat-item" data-animate="stagger">
                        <i class="fas fa-eye stat-icon"></i>
                        <div class="stat-number" data-target="<%= dailyVisits %>">0</div>
                        <div class="stat-label">Truy Cập Hôm Nay</div>
                    </div>
                    <div class="stat-item" data-animate="stagger">
                        <i class="fas fa-globe-asia stat-icon"></i>
                        <div class="stat-number" data-target="<%= totalVisits %>">0</div>
                        <div class="stat-label">Tổng Truy Cập</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Features Section -->
        <section class="features-section">
            <div class="container">
                <div class="section-header">
                    <span class="section-tagline">Tại Sao Chọn Chúng Tôi?</span>
                    <h2 class="section-title">Công Cụ Ưu Việt Cho Tương Lai Rạng Rỡ</h2>
                    <p class="section-description">
                        Chúng tôi không chỉ cung cấp bài học, mà còn mang đến một hệ sinh thái học tập toàn diện.
                    </p>
                </div>
                <div class="features-grid-v2">
                    <div class="feature-card-v2" data-animate="stagger">
                        <div class="feature-card-icon"><i class="fas fa-map-marker-alt"></i></div>
                        <h3 class="feature-card-title">Nội Dung Địa Phương Hóa</h3>
                        <p class="feature-card-desc">Chương trình học và đề thi được biên soạn riêng, bám sát định hướng của các trường THPT tại TP. Thủ Đức.</p>
                    </div>
                    <div class="feature-card-v2" data-animate="stagger">
                        <div class="feature-card-icon"><i class="fas fa-gamepad"></i></div>
                        <h3 class="feature-card-title">Học Tập Gamification</h3>
                        <p class="feature-card-desc">Tích lũy điểm, thăng hạng trên leaderboard và nhận thành tích để hành trình học tập luôn đầy hứng khởi.</p>
                    </div>
                    <div class="feature-card-v2" data-animate="stagger">
                        <div class="feature-card-icon"><i class="fas fa-robot"></i></div>
                        <h3 class="feature-card-title">Công Cụ AI Thông Minh</h3>
                        <p class="feature-card-desc">Tự động tạo bài trắc nghiệm từ tài liệu và chấm điểm bài luận chính xác, tiết kiệm thời gian và nâng cao hiệu quả.</p>
                    </div>
                    <div class="feature-card-v2" data-animate="stagger">
                        <div class="feature-card-icon"><i class="fas fa-users-cog"></i></div>
                        <h3 class="feature-card-title">Cộng Đồng Năng Động</h3>
                        <p class="feature-card-desc">Tham gia cùng hàng ngàn học viên khác, trao đổi kiến thức, và cùng nhau tiến bộ mỗi ngày.</p>
                    </div>
                </div>
            </div>
        </section>
        
    <% } %>
</main>

<%- include('partials/footer') %>

<!-- SCRIPTS -->
<script src="/socket.io/socket.io.js"></script>           
<script src="https://cdn.jsdelivr.net/npm/tsparticles@2.9.3/tsparticles.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.5/gsap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.5/ScrollTrigger.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-tilt/1.7.2/vanilla-tilt.min.js"></script>
<script src="/js/animations.js"></script>
    
<script>
    document.addEventListener('DOMContentLoaded', () => {
        if (typeof gsap === 'undefined') return;

        const isGuest = !!document.querySelector('.hero-section-v2');
        const isLoggedIn = !!document.querySelector('.logged-in-dashboard');

        // --- tsParticles Background ---
        tsParticles.load("particles-js", {
            preset: "links",
            background: { color: "transparent" },
            particles: {
                number: { value: 60, density: { enable: true, value_area: 800 } },
                color: { value: ["#ff6ec4", "#7873f5", "#ffffff", "#ffdd57"] },
                opacity: { value: { min: 0.1, max: 0.5 } },
                size: { value: { min: 1, max: 3 } },
                links: { enable: true, distance: 150, color: "#ffffff", opacity: 0.2, width: 1 },
                move: { enable: true, speed: 1.5, direction: "none", random: true, straight: false, out_mode: "out" }
            },
            interactivity: { events: { onhover: { enable: true, mode: "repulse" } } },
            detectRetina: true,
        });

        // --- Animations for GUESTS ---
        if (isGuest) {
            const heroTitle = document.querySelector('.hero-title-v2');
            if (heroTitle) {
                const words = heroTitle.querySelectorAll('.line span');
                gsap.set(words, { y: '110%', opacity: 0 });
                gsap.to(words, { y: '0%', opacity: 1, duration: 1.2, ease: 'power4.out', stagger: 0.1, delay: 0.3 });
            }
            gsap.from('.hero-badge', { duration: 0.8, scale: 0.5, autoAlpha: 0, ease: 'back.out(1.7)', delay: 0.1 });
            gsap.from('.hero-subtitle-v2', { duration: 1, y: 20, autoAlpha: 0, ease: 'power3.out', delay: 0.8 });
            gsap.from('.hero-cta-buttons > *', { duration: 0.8, y: 20, autoAlpha: 0, ease: 'power3.out', stagger: 0.1, delay: 1 });
            
            const statNumbers = document.querySelectorAll('.stat-number');
            statNumbers.forEach(counter => {
                const target = +counter.dataset.target;
                ScrollTrigger.create({
                    trigger: counter,
                    start: 'top 90%',
                    once: true,
                    onEnter: () => {
                        gsap.to(counter, { duration: 2, innerText: target, roundProps: "innerText", ease: "power2.out" });
                    },
                });
            });
        }
        
        // --- Animations for LOGGED-IN USERS ---
        if (isLoggedIn) {
            gsap.from(".interactive-card", {
                y: 100, opacity: 0, scale: 0.9, rotationX: -45,
                duration: 0.8, ease: "power3.out", stagger: 0.2
            });
            gsap.from("#liveFeedContainer", {
                y: 50, opacity: 0, duration: 0.6, ease: "power2.out", delay: 0.5
            });

            const tiltElements = document.querySelectorAll('[data-tilt]');
            if (typeof VanillaTilt !== 'undefined' && tiltElements.length > 0) {
                VanillaTilt.init(tiltElements, { max: 10, speed: 400, glare: true, "max-glare": 0.2 });
            }
        }

        // --- Live Feed Socket.IO Logic (for logged-in users) ---
        if (isLoggedIn) {
            const socket = io();
            const liveFeed = document.getElementById("liveFeed");
            const liveFeedContainer = document.getElementById("liveFeedContainer");

            socket.on("liveAccess", (data) => {
                if (!liveFeed || !liveFeedContainer) return;
                let message = "";
                let iconClass = "";
                if (data.type === "login") {
                    message = `<strong>${data.username}</strong> vừa truy cập.`;
                    iconClass = "fas fa-sign-in-alt";
                } else if (data.type === "register") {
                    message = `Chào mừng <strong>${data.username}</strong> gia nhập!`;
                    iconClass = "fas fa-user-plus";
                }

                const liveItem = document.createElement("div");
                liveItem.className = "live-item";
                liveItem.innerHTML = `<i class="${iconClass} live-icon"></i> ${message} <span class="time">${data.time}</span>`;
                liveFeed.insertBefore(liveItem, liveFeed.firstChild);

                gsap.from(liveItem, { opacity: 0, x: -50, duration: 0.5, ease: "power3.out" });

                if (liveFeed.children.length > 5) {
                    const oldItem = liveFeed.lastChild;
                    gsap.to(oldItem, { opacity: 0, height: 0, paddingTop: 0, paddingBottom: 0, marginTop: 0, marginBottom: 0, duration: 0.4, ease: "power2.in", onComplete: () => oldItem.remove() });
                }
            });
        }
    });
</script>