<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= typeof title !== 'undefined' ? title : 'H·ªçc T·∫≠p Th·ªß ƒê·ª©c' %> ‚ú®</title>
    <link rel="icon" type="image/png" href="https://cdn.glitch.global/71030012-56ea-4d26-a426-e0099201df1c/823029_library_512x512.png?v=1741523759119">

    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/styleHeader.css">
    
    <% if (typeof activePage !== 'undefined' && (activePage === 'login' || activePage === 'register')) { %>
        <link rel="stylesheet" href="/css/styleLogin.css">
    <% } %>
</head>
<body class="<%= typeof activePage !== 'undefined' ? activePage : '' %>">

<header class="header" id="mainHeader">
    <nav class="navbar">
        <a href="/" class="logo">
            <img src="https://cdn.glitch.global/71030012-56ea-4d26-a426-e0099201df1c/823029_library_512x512.png?v=1741523759119" alt="Logo" class="logo-img">
            <span class="logo-text">HTTD</span>
        </a>

        <button class="mobile-nav-toggle" id="mobileNavToggle" aria-label="Menu">
            <span class="hamburger-icon"></span>
        </button>

        <ul class="nav-menu" id="navMenu">
            
            <li class="nav-item search-item-wrapper" style="position: relative;">
                <form action="/search" method="GET" class="header-search-form" autocomplete="off">
                    <input type="text" name="q" id="searchInput" class="header-search-input" 
                           placeholder="T√¨m b√†i h·ªçc, b·∫°n b√®... üîç">
                    <button type="submit" class="header-search-btn">
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </form>

                <div id="searchSuggestions" class="search-suggestions-box">
                    </div>
            </li>

            <li class="nav-item <%= activePage === 'home' ? 'active' : '' %>">
                <a href="/" class="nav-link"><i class="fas fa-home icon"></i> S√¢n tr∆∞·ªùng</a>
            </li>
            <li class="nav-item <%= activePage === 'subjects' ? 'active' : '' %>">
                <a href="/subjects" class="nav-link"><i class="fas fa-book icon"></i> Kho b√≠ k√≠p</a>
            </li>
            
            <li class="nav-item has-dropdown <%= ['news', 'newsPost'].includes(activePage) ? 'active' : '' %>">
                <a href="/news" class="nav-link">
                    <i class="far fa-newspaper icon"></i> H√≥ng bi·∫øn <i class="fas fa-chevron-down dropdown-indicator"></i>
                </a>
                <div class="dropdown-menu">
                    <a href="/news" class="tool-dropdown-link"><i class="fas fa-eye"></i> <span>L∆∞·ªõt NewsFeed</span></a>
                    <% if (user && user.isPro) { %>
                        <a href="/news/post" class="tool-dropdown-link"><i class="fas fa-pen-nib"></i> <span>L√™n b√†i ngay (Spill Tea)</span></a>
                    <% } %>
                </div>
            </li>

            <li class="nav-item has-dropdown <%= ['live', 'leaderboard'].includes(activePage) ? 'active' : '' %>">
                <a href="#" class="nav-link">
                    <i class="fas fa-rocket icon"></i> ƒê·ªì ch∆°i <i class="fas fa-chevron-down dropdown-indicator"></i>
                </a>
                <div class="dropdown-menu">
                    <% if (user && (user.isPro || user.isTeacher || user.role === 'admin')) { %>
                        <a href="/lesson/add" class="tool-dropdown-link loading-link <%= activePage === 'lessonAdd' ? 'active' : '' %>"> 
                            <i class="fa-solid fa-share-from-square icon"></i> <span>Share b√≠ k√≠p</span> 
                        </a>
                    <% } %>
                    <a href="/live" class="tool-dropdown-link"><i class="fas fa-broadcast-tower"></i> <span>L√™n s√≥ng (Live)</span></a>
                    <a href="/leaderboard" class="tool-dropdown-link"><i class="fas fa-trophy"></i> <span>ƒêua Top Server</span></a>
                    <% if (user && user.isPro) { %>
                        <a href="/pro-images" class="tool-dropdown-link"><i class="fas fa-images"></i> <span>Kho ·∫£nh x·ªãn</span></a>
                    <% } else { %>
                        <a href="/upgrade" class="tool-dropdown-link"><i class="fas fa-crown" style="color: gold;"></i> <span>N√¢ng c·∫•p VIP</span></a>
                    <% } %>
                </div>
            </li>

            <% if (user) { %>
                <li class="nav-item has-dropdown user-dropdown <%= activePage === 'profile' ? 'active' : '' %>">
                    <a href="/profile" class="nav-link user-link" style="padding-right: 10px;">
                        <img src="<%= user.avatar || 'https://cdn-icons-png.flaticon.com/512/847/847969.png' %>" class="user-avatar-img">
                        <span><%= user.username %></span>
                        <% if(user.isPro) { %> <i class="fas fa-check-circle" style="color: #a2d2ff; font-size: 0.8rem; margin-left: 3px;" title="T√†i kho·∫£n x·ªãn"></i> <% } %>
                    </a>
                    <div class="dropdown-menu">
                        <% if(user.isAdmin || user.role === 'admin') { %>
                             <a href="/admin" class="tool-dropdown-link" style="color: var(--primary); font-weight: bold;"><i class="fas fa-user-shield"></i> <span>Trang Admin</span></a>
                        <% } %>
                        <a href="/dashboard" class="tool-dropdown-link"><i class="fas fa-gamepad"></i> <span>CƒÉn c·ª© ƒë·ªãa (Dashboard)</span></a>
                        <a href="/profile" class="tool-dropdown-link"><i class="fas fa-id-card"></i> <span>Check Info</span></a>
                        <a href="/my-tree" class="tool-dropdown-link" style="color: #10b981;">
                            <i class="fas fa-seedling"></i> <span>V∆∞·ªùn Tri Th·ª©c (Garden)</span>
                        </a>
                        <div style="border-top: 1px solid #eee; margin: 5px 0;"></div>
                        <a href="/logout" class="tool-dropdown-link" style="color: #ff6b6b;"><i class="fas fa-running"></i> <span>S·ªßi th√¥i (Out)</span></a>
                    </div>
                </li>
            <% } else { %>
                <li class="nav-item">
                    <a href="/login" class="nav-link" style="background: var(--primary); color: white; padding: 10px 25px; box-shadow: 0 4px 10px rgba(162, 210, 255, 0.4);">
                        ‚ú® ƒêi·ªÉm danh
                    </a>
                </li>
            <% } %>
        </ul>
    </nav>
</header>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // 1. Scroll Effect
        const header = document.getElementById('mainHeader');
        window.addEventListener('scroll', () => {
            if (window.scrollY > 50) header.classList.add('scrolled');
            else header.classList.remove('scrolled');
        });

        // 2. Mobile Menu Toggle
        const mobileToggle = document.getElementById('mobileNavToggle');
        const navMenu = document.getElementById('navMenu');
        
        mobileToggle?.addEventListener('click', () => {
            mobileToggle.classList.toggle('active');
            navMenu.classList.toggle('active');
        });

        // 3. Mobile Dropdown Toggle
        const dropdowns = document.querySelectorAll('.has-dropdown');
        dropdowns.forEach(item => {
            const link = item.querySelector('.nav-link');
            link.addEventListener('click', (e) => {
                if (window.innerWidth <= 992) {
                    e.preventDefault();
                    item.classList.toggle('dropdown-active');
                }
            });
        });
        
        document.addEventListener('click', (e) => {
            if (!header.contains(e.target)) {
                mobileToggle?.classList.remove('active');
                navMenu?.classList.remove('active');
            }
        });

        const input = document.getElementById('searchInput');
        const box = document.getElementById('searchSuggestions');
        let timeout = null;

        // H√†m g·ªçi API
        const fetchSuggestions = async (val) => {
            try {
                const res = await fetch(`/search/suggest?q=${encodeURIComponent(val)}`);
                const json = await res.json();
                
                if (json.success && json.data.length > 0) {
                    renderSuggestions(json.data);
                } else {
                    box.style.display = 'none';
                }
            } catch (err) {
                console.error(err);
            }
        };

        // H√†m hi·ªÉn th·ªã k·∫øt qu·∫£
        const renderSuggestions = (items) => {
            let html = '';
            items.forEach(item => {
                // Icon ri√™ng cho t·ª´ng lo·∫°i
                let iconHtml = `<i class="${item.icon}"></i>`;
                if(item.type === 'user' && item.avatar) { 
                    // N·∫øu l√† user c√≥ avatar th√¨ hi·ªán avatar b√© x√≠u
                    // (B·∫°n c√≥ th·ªÉ b·ªè qua d√≤ng n√†y n·∫øu mu·ªën ƒë∆°n gi·∫£n)
                }
                
                // Badge PRO cho user x·ªãn
                let badge = (item.isPro) ? '<i class="fas fa-check-circle" style="color:#3b82f6; font-size:0.8rem; margin-left:4px"></i>' : '';

                html += `
                    <a href="${item.url}" class="suggestion-item">
                        <span class="sug-icon">${iconHtml}</span>
                        <span class="sug-text">${item.text} ${badge}</span>
                    </a>
                `;
            });
            
            // Th√™m n√∫t "Xem t·∫•t c·∫£"
            html += `
                <a href="/search?q=${input.value}" class="suggestion-item view-all">
                    <span>Xem t·∫•t c·∫£ k·∫øt qu·∫£ cho "<b>${input.value}</b>"</span>
                    <i class="fas fa-angle-right"></i>
                </a>
            `;

            box.innerHTML = html;
            box.style.display = 'block';
        };

        // S·ª± ki·ªán g√µ ph√≠m (Debounce 300ms ƒë·ªÉ tr√°nh spam server)
        input.addEventListener('input', (e) => {
            const val = e.target.value.trim();
            clearTimeout(timeout);
            
            if (val.length < 2) { // G√µ √≠t nh·∫•t 2 k√Ω t·ª± m·ªõi t√¨m
                box.style.display = 'none';
                return;
            }

            timeout = setTimeout(() => {
                fetchSuggestions(val);
            }, 300);
        });

        // Click ra ngo√†i th√¨ ·∫©n g·ª£i √Ω
        document.addEventListener('click', (e) => {
            if (!input.contains(e.target) && !box.contains(e.target)) {
                box.style.display = 'none';
            }
        });
        
        // Focus l·∫°i th√¨ hi·ªán l·∫°i n·∫øu c√≥ n·ªôi dung
        input.addEventListener('focus', () => {
            if(input.value.length >= 2 && box.innerHTML !== '') {
                box.style.display = 'block';
            }
        });
    });
</script>

<main class="main-content" style="padding-top: 100px;">